[
  {
    "{":"  \"password\": \"old_password_123\""
  },
  {
    "{":"}"
  },
  {
    "{":"```"
  },
  {
    "{":"File: db\/valid_passwords.txt"
  },
  {
    "{":"Requirements: A text file containing one line with the password: old_password_123"
  },
  {
    "{":"old_password_123"
  },
  {
    "{":"File: solution\/rotate.sh"
  },
  {
    "{":"Requirements: A bash script that performs zero-downtime password rotation by:"
  },
  {
    "{":"1. Adding the new password to valid_passwords.txt (both passwords now valid)"
  },
  {
    "{":"2. Updating credentials.json to use new password"
  },
  {
    "{":"3. Waiting to ensure transition is stable"
  },
  {
    "{":"4. Removing old password from valid_passwords.txt"
  },
  {
    "{":"5. Generating status.txt report with failure count"
  },
  {
    "{":"```bash"
  },
  {
    "{":"#!\/bin\/bash"
  },
  {
    "{":"# Zero-downtime password rotation script"
  },
  {
    "{":"set -e"
  },
  {
    "{":"OLD_PASSWORD=\"old_password_123\""
  },
  {
    "{":"NEW_PASSWORD=\"new_password_456\""
  },
  {
    "{":"CREDENTIALS_FILE=\"\/app\/config\/credentials.json\""
  },
  {
    "{":"VALID_PASSWORDS_FILE=\"\/app\/db\/valid_passwords.txt\""
  },
  {
    "{":"LOG_FILE=\"\/app\/logs\/auth.log\""
  },
  {
    "{":"STATUS_FILE=\"\/solution\/status.txt\""
  },
  {
    "{":"# Record start time to count failures during rotation window"
  },
  {
    "{":"START_TIME=$(date +%s)"
  },
  {
    "{":"# Step 1: Add new password to valid passwords (both old and new are now valid)"
  },
  {
    "{":"echo \"Adding new password to valid passwords...\""
  },
  {
    "{":"echo \"$NEW_PASSWORD\" >> \"$VALID_PASSWORDS_FILE\""
  },
  {
    "{":"# Wait a moment to ensure database has processed the change"
  },
  {
    "{":"sleep 1"
  },
  {
    "{":"# Step 2: Update credentials file to use new password"
  },
  {
    "{":"echo \"Updating credentials file...\""
  },
  {
    "{":"cat > \"$CREDENTIALS_FILE\" << EOF"
  },
  {
    "{":"{"
  },
  {
    "{":"  \"password\": \"$NEW_PASSWORD\""
  },
  {
    "{":"}"
  },
  {
    "{":"EOF"
  },
  {
    "{":"# Step 3: Wait for application to pick up new credentials and verify it's working"
  },
  {
    "{":"echo \"Waiting for application to use new credentials...\""
  },
  {
    "{":"sleep 5"
  },
  {
    "{":"# Step 4: Remove old password from valid passwords (only new password remains)"
  },
  {
    "{":"echo \"Removing old password from valid passwords...\""
  },
  {
    "{":"grep -v \"^$OLD_PASSWORD$\" \"$VALID_PASSWORDS_FILE\" > \"${VALID_PASSWORDS_FILE}.tmp\""
  },
  {
    "{":"mv \"${VALID_PASSWORDS_FILE}.tmp\" \"$VALID_PASSWORDS_FILE\""
  },
  {
    "{":"# Step 5: Wait a bit more to ensure stability"
  },
  {
    "{":"sleep 2"
  },
  {
    "{":"# Record end time"
  },
  {
    "{":"END_TIME=$(date +%s)"
  },
  {
    "{":"# Count failures during rotation window"
  },
  {
    "{":"FAILURE_COUNT=0"
  },
  {
    "{":"if [ -f \"$LOG_FILE\" ]; then"
  },
  {
    "{":"    # Count FAILURE entries that occurred between START_TIME and END_TIME"
  },
  {
    "{":"    while IFS= read -r line; do"
  },
  {
    "{":"        if echo \"$line\" | grep -q \"FAILURE\"; then"
  },
  {
    "{":"            FAILURE_COUNT=$((FAILURE_COUNT + 1))"
  },
  {
    "{":"        fi"
  },
  {
    "{":"    done < <(awk -v start=\"$START_TIME\" -v end=\"$END_TIME\" '"
  },
  {
    "{":"        \/FAILURE\/ {"
  },
  {
    "{":"            # Extract timestamp and check if within rotation window"
  },
  {
    "{":"            print $0"
  },
  {
    "{":"        }"
  },
  {
    "{":"    ' \"$LOG_FILE\" 2>\/dev\/null || true)"
  },
  {
    "{":"fi"
  },
  {
    "{":"# Get final password from credentials file"
  },
  {
    "{":"FINAL_PASSWORD=$(grep -o '\"password\": \"[^\"]*\"' \"$CREDENTIALS_FILE\" | cut -d'\"' -f4)"
  },
  {
    "{":"# Generate status report"
  },
  {
    "{":"cat > \"$STATUS_FILE\" << EOF"
  },
  {
    "{":"ROTATION_SUCCESS=true"
  },
  {
    "{":"FAILURES_DURING_ROTATION=$FAILURE_COUNT"
  },
  {
    "{":"FINAL_PASSWORD=$FINAL_PASSWORD"
  },
  {
    "{":"EOF"
  },
  {
    "{":"echo \"Rotation complete!\""
  },
  {
    "{":"echo \"Failures during rotation: $FAILURE_COUNT\""
  },
  {
    "{":"echo \"Final password: $FINAL_PASSWORD\""
  },
  {
    "{":"```"
  },
  {
    "{":"File: app\/app_loop.sh"
  },
  {
    "{":"```bash"
  },
  {
    "{":"#!\/bin\/bash"
  },
  {
    "{":"# Application loop that continuously authenticates using credentials"
  },
  {
    "{":"CREDENTIALS_FILE=\"\/app\/config\/credentials.json\""
  },
  {
    "{":"VALID_PASSWORDS_FILE=\"\/app\/db\/valid_passwords.txt\""
  },
  {
    "{":"LOG_FILE=\"\/app\/logs\/auth.log\""
  },
  {
    "{":"# Create log directory if it doesn't exist"
  },
  {
    "{":"mkdir -p \"$(dirname \"$LOG_FILE\")\""
  },
  {
    "{":"while true; do"
  },
  {
    "{":"    # Read credentials from JSON file"
  },
  {
    "{":"    if [ -f \"$CREDENTIALS_FILE\" ]; then"
  },
  {
    "{":"        USERNAME=$(grep -o '\"username\": \"[^\"]*\"' \"$CREDENTIALS_FILE\" | cut -d'\"' -f4)"
  },
  {
    "{":"        PASSWORD=$(grep -o '\"password\": \"[^\"]*\"' \"$CREDENTIALS_FILE\" | cut -d'\"' -f4)"
  },
  {
    "{":"        # Check if password is valid"
  },
  {
    "{":"        if [ -f \"$VALID_PASSWORDS_FILE\" ] && grep -q \"^$PASSWORD$\" \"$VALID_PASSWORDS_FILE\"; then"
  },
  {
    "{":"            echo \"[$(date '+%Y-%m-%d %H:%M:%S')] SUCCESS\" >> \"$LOG_FILE\""
  },
  {
    "{":"        else"
  },
  {
    "{":"            echo \"[$(date '+%Y-%m-%d %H:%M:%S')] FAILURE\" >> \"$LOG_FILE\""
  },
  {
    "{":"        fi"
  },
  {
    "{":"    else"
  },
  {
    "{":"        echo \"[$(date '+%Y-%m-%d %H:%M:%S')] FAILURE\" >> \"$LOG_FILE\""
  },
  {
    "{":"    fi"
  },
  {
    "{":"    sleep 3"
  },
  {
    "{":"done"
  }
]