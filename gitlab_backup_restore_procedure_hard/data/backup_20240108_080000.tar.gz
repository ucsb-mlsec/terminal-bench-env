#!/bin/bash
# Creating backup_20240108_080000.tar.gz - Complete but older version

# Create temporary directory structure
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"

# Create app.py - simpler version
cat > app.py << 'EOF'
#!/usr/bin/env python3
from flask import Flask, jsonify, request
import sqlite3
import os

app = Flask(__name__)
DATABASE = 'data.db'

def get_db():
    conn = sqlite3.connect(DATABASE)
    conn.row_factory = sqlite3.Row
    return conn

@app.route('/')
def index():
    return jsonify({
        'status': 'running',
        'version': '1.0',
        'message': 'Web Application Server'
    })

@app.route('/users')
def users():
    try:
        db = get_db()
        cursor = db.cursor()
        cursor.execute('SELECT * FROM users ORDER BY id')
        rows = cursor.fetchall()
        db.close()
        
        user_list = []
        for row in rows:
            user_list.append({
                'id': row['id'],
                'name': row['name'],
                'email': row['email'],
                'created_at': row['created_at']
            })
        
        return jsonify({
            'count': len(user_list),
            'users': user_list
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/health')
def health():
    return jsonify({'status': 'healthy'})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=False)
EOF

# Create SQLite database with 12 records
cat > create_db.py << 'EOF'
import sqlite3
import os

if os.path.exists('data.db'):
    os.remove('data.db')

conn = sqlite3.connect('data.db')
cursor = conn.cursor()

cursor.execute('''
    CREATE TABLE users (
        id INTEGER PRIMARY KEY,
        name TEXT NOT NULL,
        email TEXT NOT NULL,
        created_at TEXT NOT NULL
    )
''')

users = [
    (1, 'Alice Johnson', 'alice.johnson@example.com', '2024-01-02 09:15:00'),
    (2, 'Bob Smith', 'bob.smith@example.com', '2024-01-02 10:30:00'),
    (3, 'Carol White', 'carol.white@example.com', '2024-01-03 08:45:00'),
    (4, 'David Brown', 'david.brown@example.com', '2024-01-03 14:20:00'),
    (5, 'Emma Davis', 'emma.davis@example.com', '2024-01-04 11:00:00'),
    (6, 'Frank Miller', 'frank.miller@example.com', '2024-01-04 16:30:00'),
    (7, 'Grace Wilson', 'grace.wilson@example.com', '2024-01-05 09:00:00'),
    (8, 'Henry Moore', 'henry.moore@example.com', '2024-01-05 13:45:00'),
    (9, 'Iris Taylor', 'iris.taylor@example.com', '2024-01-06 10:15:00'),
    (10, 'Jack Anderson', 'jack.anderson@example.com', '2024-01-06 15:00:00'),
    (11, 'Karen Thomas', 'karen.thomas@example.com', '2024-01-07 08:30:00'),
    (12, 'Leo Jackson', 'leo.jackson@example.com', '2024-01-07 12:00:00')
]

cursor.executemany('INSERT INTO users VALUES (?, ?, ?, ?)', users)
conn.commit()
conn.close()
EOF

python3 create_db.py
rm create_db.py

# Create uploads directory with 2 files
mkdir -p uploads

cat > uploads/welcome.txt << 'EOF'
Welcome to our web application!

This is a sample document uploaded on January 2, 2024.
This file contains basic information about getting started.

Thank you for using our service.
EOF

cat > uploads/notes.txt << 'EOF'
Project Notes - January 2024

Initial setup completed.
Basic user accounts created.
System is operational.

Next steps:
- Add more features
- Expand user base
- Improve documentation
EOF

# Create the tar.gz archive
cd "$TEMP_DIR"
tar -czf backup_20240108_080000.tar.gz app.py data.db uploads/

# Move to data directory
mkdir -p /tmp/backup_data
mv backup_20240108_080000.tar.gz /tmp/backup_data/

# Cleanup
cd /
rm -rf "$TEMP_DIR"

# Output the file
cat /tmp/backup_data/backup_20240108_080000.tar.gz