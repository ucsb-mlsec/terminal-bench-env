#!/bin/bash

# Create directory structure
mkdir -p /workspace/project/docs
mkdir -p /workspace/project/assets/images
mkdir -p /workspace/project/assets/videos
mkdir -p /workspace/project/data
mkdir -p /workspace/backup/docs
mkdir -p /workspace/backup/assets/images
mkdir -p /workspace/backup/assets/videos
mkdir -p /workspace/backup/data

# Create LFS pointer files in project directory
cat > /workspace/project/docs/manual.pdf << 'EOF'
version https://git-lfs.github.com/spec/v1
oid sha256:c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4
size 3145728
EOF

cat > /workspace/project/assets/images/logo.png << 'EOF'
version https://git-lfs.github.com/spec/v1
oid sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
size 524288
EOF

cat > /workspace/project/assets/videos/demo.mp4 << 'EOF'
version https://git-lfs.github.com/spec/v1
oid sha256:f0e1d2c3b4a5968778695a4b3c2d1e0f9e8d7c6b5a49382716253443526150
size 10485760
EOF

cat > /workspace/project/data/dataset.bin << 'EOF'
version https://git-lfs.github.com/spec/v1
oid sha256:1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef
size 2097152
EOF

cat > /workspace/project/assets/images/banner.jpg << 'EOF'
version https://git-lfs.github.com/spec/v1
oid sha256:deadbeefcafebabedeadbeefcafebabedeadbeefcafebabedeadbeefcafebabe
size 1048576
EOF

# Create some regular files (not pointers)
cat > /workspace/project/README.md << 'EOF'
# Project Documentation

This is a regular text file, not an LFS pointer.
EOF

cat > /workspace/project/docs/notes.txt << 'EOF'
Some regular text notes.
This file is not an LFS pointer.
EOF

# Create actual binary files in backup (with real content)
# For manual.pdf
dd if=/dev/urandom of=/workspace/backup/docs/manual.pdf bs=1024 count=3072 2>/dev/null

# For logo.png
dd if=/dev/urandom of=/workspace/backup/assets/images/logo.png bs=1024 count=512 2>/dev/null

# For demo.mp4
dd if=/dev/urandom of=/workspace/backup/assets/videos/demo.mp4 bs=1024 count=10240 2>/dev/null

# For dataset.bin
dd if=/dev/urandom of=/workspace/backup/data/dataset.bin bs=1024 count=2048 2>/dev/null

# Note: banner.jpg has no backup (to test FAILED case)

# Now scan and restore
FOUND=0
RESTORED=0
FAILED=0

# Find all files in project directory
while IFS= read -r -d '' file; do
    # Check if file starts with LFS pointer signature
    if head -n 1 "$file" 2>/dev/null | grep -q "^version https://git-lfs.github.com/spec/v1"; then
        FOUND=$((FOUND + 1))
        
        # Get relative path
        rel_path="${file#/workspace/project/}"
        backup_file="/workspace/backup/$rel_path"
        
        # Check if backup exists
        if [ -f "$backup_file" ]; then
            # Replace pointer with actual file
            cp "$backup_file" "$file"
            RESTORED=$((RESTORED + 1))
        else
            FAILED=$((FAILED + 1))
        fi
    fi
done < <(find /workspace/project -type f -print0)

# Write results
cat > /workspace/result.txt << EOF
FOUND=$FOUND
RESTORED=$RESTORED
FAILED=$FAILED
EOF