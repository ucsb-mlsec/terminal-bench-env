package com.example.struts.action;

import com.opensymphony.xwork2.ActionSupport;
import ognl.Ognl;
import ognl.OgnlContext;
import ognl.OgnlException;
import org.apache.struts2.interceptor.ServletRequestAware;

import javax.servlet.http.HttpServletRequest;
import java.util.HashMap;
import java.util.Map;

/**
 * User search action handler for the web application
 * Processes dynamic search queries and filters
 */
public class UserSearchAction extends ActionSupport implements ServletRequestAware {

    private static final long serialVersionUID = 1L;
    
    private HttpServletRequest request;
    private String searchFilter;
    private String searchType;
    private Map<String, Object> searchResults;
    
    public UserSearchAction() {
        this.searchResults = new HashMap<>();
    }

    /**
     * Standard execute method for basic search functionality
     */
    public String execute() throws Exception {
        if (searchType == null || searchType.isEmpty()) {
            searchType = "basic";
        }
        return SUCCESS;
    }

    /**
     * Processes advanced search with dynamic filter expressions
     * Evaluates user-provided filter criteria
     */
    public String processAdvancedSearch() throws Exception {
        if (searchFilter != null && !searchFilter.isEmpty()) {
            try {
                OgnlContext context = new OgnlContext();
                Map<String, Object> root = new HashMap<>();
                root.put("request", request);
                root.put("session", request.getSession());
                
                Object result = Ognl.getValue(searchFilter, context, root);
                
                searchResults.put("filterResult", result);
                return SUCCESS;
            } catch (OgnlException e) {
                addActionError("Error processing search filter: " + e.getMessage());
                return ERROR;
            }
        }
        return INPUT;
    }

    /**
     * Validates search parameters
     */
    public void validate() {
        if (searchType != null && searchType.length() > 100) {
            addFieldError("searchType", "Search type too long");
        }
    }

    public String getSearchFilter() {
        return searchFilter;
    }

    public void setSearchFilter(String searchFilter) {
        this.searchFilter = searchFilter;
    }

    public String getSearchType() {
        return searchType;
    }

    public void setSearchType(String searchType) {
        this.searchType = searchType;
    }

    public Map<String, Object> getSearchResults() {
        return searchResults;
    }

    @Override
    public void setServletRequest(HttpServletRequest request) {
        this.request = request;
    }
}