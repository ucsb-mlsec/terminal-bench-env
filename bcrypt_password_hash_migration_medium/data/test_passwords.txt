#!/usr/bin/env python3
"""
Legacy Authentication System Migration Script
Migrates MD5 password hashes to bcrypt hashing
"""

import hashlib
import bcrypt
import json
import os
import re

# Database file path
DB_FILE = 'data/users.db'
TEST_PASSWORDS_FILE = 'data/test_passwords.txt'
MIGRATION_RESULT_FILE = '/tmp/migration_result.json'

class UserDatabase:
    """Handles user database operations"""
    
    def __init__(self, db_file=DB_FILE):
        self.db_file = db_file
        self.users = {}
        self.load_database()
    
    def load_database(self):
        """Load users from database file"""
        if not os.path.exists(self.db_file):
            # Create empty database if it doesn't exist
            os.makedirs(os.path.dirname(self.db_file), exist_ok=True)
            with open(self.db_file, 'w') as f:
                pass
            return
        
        with open(self.db_file, 'r') as f:
            for line in f:
                line = line.strip()
                if line and ':' in line:
                    username, password_hash = line.split(':', 1)
                    self.users[username] = password_hash
    
    def save_database(self):
        """Save users to database file"""
        os.makedirs(os.path.dirname(self.db_file), exist_ok=True)
        with open(self.db_file, 'w') as f:
            for username, password_hash in self.users.items():
                f.write(f"{username}:{password_hash}\n")
    
    def get_user_hash(self, username):
        """Get password hash for a user"""
        return self.users.get(username)
    
    def update_user_hash(self, username, new_hash):
        """Update password hash for a user"""
        if username in self.users:
            self.users[username] = new_hash
            self.save_database()
            return True
        return False
    
    def get_all_users(self):
        """Get all usernames"""
        return list(self.users.keys())


def is_md5_hash(hash_string):
    """Check if a hash string is MD5 format (32 hex characters)"""
    if not hash_string:
        return False
    return bool(re.match(r'^[a-f0-9]{32}$', hash_string))


def is_bcrypt_hash(hash_string):
    """Check if a hash string is bcrypt format"""
    if not hash_string:
        return False
    # bcrypt hashes start with $2a$, $2b$, or $2y$
    return bool(re.match(r'^\$2[aby]\$\d{2}\$', hash_string))


def hash_md5(password):
    """Create MD5 hash of password"""
    return hashlib.md5(password.encode()).hexdigest()


def hash_bcrypt(password):
    """Create bcrypt hash of password"""
    salt = bcrypt.gensalt()
    return bcrypt.hashpw(password.encode(), salt).decode('utf-8')


def verify_md5(password, hash_string):
    """Verify password against MD5 hash"""
    return hash_md5(password) == hash_string


def verify_bcrypt(password, hash_string):
    """Verify password against bcrypt hash"""
    try:
        return bcrypt.checkpw(password.encode(), hash_string.encode())
    except Exception:
        return False


# Global database instance
db = UserDatabase()


def authenticate_user(username, password):
    """
    Authenticate user with username and password.
    Returns True if credentials are valid, False otherwise.
    Automatically migrates MD5 hashes to bcrypt upon successful authentication.
    """
    # Get stored hash for user
    stored_hash = db.get_user_hash(username)
    
    if not stored_hash:
        return False
    
    # Determine hash type and verify password
    if is_bcrypt_hash(stored_hash):
        # Already using bcrypt
        return verify_bcrypt(password, stored_hash)
    
    elif is_md5_hash(stored_hash):
        # Using legacy MD5 - verify and migrate if successful
        if verify_md5(password, stored_hash):
            # Password is correct - migrate to bcrypt
            new_hash = hash_bcrypt(password)
            db.update_user_hash(username, new_hash)
            return True
        return False
    
    else:
        # Unknown hash format
        return False


def get_migration_status():
    """
    Returns migration statistics as a dictionary.
    """
    total_users = len(db.users)
    md5_count = 0
    bcrypt_count = 0
    
    for username, hash_string in db.users.items():
        if is_md5_hash(hash_string):
            md5_count += 1
        elif is_bcrypt_hash(hash_string):
            bcrypt_count += 1
    
    return {
        'total_users': total_users,
        'md5_count': md5_count,
        'bcrypt_count': bcrypt_count
    }


def run_migration():
    """
    Run migration process using test passwords file.
    Outputs results to migration_result.json
    """
    # Get initial status
    initial_status = get_migration_status()
    initial_md5_count = initial_status['md5_count']
    
    # Load test passwords
    test_passwords = {}
    if os.path.exists(TEST_PASSWORDS_FILE):
        with open(TEST_PASSWORDS_FILE, 'r') as f:
            for line in f:
                line = line.strip()
                if line and ':' in line:
                    username, password = line.split(':', 1)
                    test_passwords[username] = password
    
    # Authenticate all users to trigger migration
    successful_auths = 0
    for username, password in test_passwords.items():
        if authenticate_user(username, password):
            successful_auths += 1
    
    # Get final status
    final_status = get_migration_status()
    migrated_count = initial_md5_count - final_status['md5_count']
    
    # Prepare result
    result = {
        'total_users': final_status['total_users'],
        'migrated_count': migrated_count,
        'bcrypt_count': final_status['bcrypt_count'],
        'md5_count': final_status['md5_count']
    }
    
    # Write result to file
    with open(MIGRATION_RESULT_FILE, 'w') as f:
        json.dump(result, f, indent=2)
    
    return result


if __name__ == '__main__':
    print("Starting authentication system migration...")
    print(f"Database: {DB_FILE}")
    print(f"Test passwords: {TEST_PASSWORDS_FILE}")
    
    # Run migration
    result = run_migration()
    
    print("\nMigration completed!")
    print(f"Total users: {result['total_users']}")
    print(f"Migrated: {result['migrated_count']}")
    print(f"Current bcrypt count: {result['bcrypt_count']}")
    print(f"Current MD5 count: {result['md5_count']}")
    print(f"\nResults saved to: {MIGRATION_RESULT_FILE}")