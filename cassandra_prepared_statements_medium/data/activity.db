import sqlite3
import time
import random

def setup_database():
    """Connect to the database and verify it exists"""
    conn = sqlite3.connect('/workspace/activity.db')
    return conn

def inefficient_approach(conn, iterations=20):
    """Execute queries using string formatting (inefficient)"""
    cursor = conn.cursor()
    start_time = time.time()
    
    for i in range(iterations):
        user_id = f"user_{random.randint(1, 100):03d}"
        event_type = random.choice(['login', 'logout', 'page_view', 'click', 'purchase'])
        
        # Inefficient: String formatting creates a new query each time
        query = f"SELECT * FROM events WHERE user_id = '{user_id}' AND event_type = '{event_type}'"
        cursor.execute(query)
        results = cursor.fetchall()
        
        # Also test insert with string formatting
        timestamp = int(time.time()) + i
        event_data = f'{{"iteration": {i}}}'
        insert_query = f"INSERT INTO events (user_id, event_timestamp, event_type, event_data) VALUES ('{user_id}', {timestamp}, '{event_type}', '{event_data}')"
        cursor.execute(insert_query)
    
    conn.commit()
    end_time = time.time()
    return (end_time - start_time) * 1000  # Convert to milliseconds

def efficient_approach(conn, iterations=20):
    """Execute queries using prepared statements with parameter binding (efficient)"""
    cursor = conn.cursor()
    start_time = time.time()
    
    # Prepare statements once (the database can optimize these)
    select_query = "SELECT * FROM events WHERE user_id = ? AND event_type = ?"
    insert_query = "INSERT INTO events (user_id, event_timestamp, event_type, event_data) VALUES (?, ?, ?, ?)"
    
    for i in range(iterations):
        user_id = f"user_{random.randint(1, 100):03d}"
        event_type = random.choice(['login', 'logout', 'page_view', 'click', 'purchase'])
        
        # Efficient: Use parameter binding
        cursor.execute(select_query, (user_id, event_type))
        results = cursor.fetchall()
        
        # Also test insert with parameter binding
        timestamp = int(time.time()) + i
        event_data = f'{{"iteration": {i}}}'
        cursor.execute(insert_query, (user_id, timestamp, event_type, event_data))
    
    conn.commit()
    end_time = time.time()
    return (end_time - start_time) * 1000  # Convert to milliseconds

def main():
    # Set a consistent random seed for reproducibility
    random.seed(42)
    
    # Connect to database
    conn = setup_database()
    
    # Run benchmarks with more iterations for better measurement
    iterations = 50
    
    # Run inefficient approach
    random.seed(42)  # Reset seed for fair comparison
    inefficient_time = inefficient_approach(conn, iterations)
    
    # Run efficient approach
    random.seed(42)  # Reset seed for fair comparison
    efficient_time = efficient_approach(conn, iterations)
    
    # Calculate improvement percentage
    improvement_pct = ((inefficient_time - efficient_time) / inefficient_time) * 100
    
    # Close connection
    conn.close()
    
    # Write results to file
    with open('/solution/results.txt', 'w') as f:
        f.write(f"inefficient_ms={inefficient_time:.1f}\n")
        f.write(f"efficient_ms={efficient_time:.1f}\n")
        f.write(f"improvement_pct={improvement_pct:.1f}\n")
    
    # Also print to console for debugging
    print(f"Inefficient approach: {inefficient_time:.1f} ms")
    print(f"Efficient approach: {efficient_time:.1f} ms")
    print(f"Improvement: {improvement_pct:.1f}%")

if __name__ == "__main__":
    main()