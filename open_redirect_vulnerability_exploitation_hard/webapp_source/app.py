#!/usr/bin/env python3

from flask import Flask, request, redirect, url_for, render_template_string
import re
import base64
from urllib.parse import urlparse

app = Flask(__name__)

# Simulated user database
users = {"admin": "password123"}

# Whitelist of allowed domains for safe redirects
ALLOWED_DOMAINS = ["localhost:5000", "localhost", "example.com"]

def is_safe_domain(url):
    """
    Helper function to validate if URL domain is in whitelist.
    Used by dashboard endpoint for secure redirects.
    """
    try:
        parsed = urlparse(url)
        domain = parsed.netloc if parsed.netloc else parsed.path.split('/')[0]
        return domain in ALLOWED_DOMAINS
    except:
        return False

def basic_url_check(url):
    """
    Basic validation that checks if URL starts with http://
    WARNING: This does not check for https:// or protocol-relative URLs
    """
    if url.startswith("http://"):
        return True
    return False

def weak_domain_validation(url):
    """
    Attempts to validate that redirect stays on same domain.
    Has known bypass vulnerabilities with @ symbol and URL parsing tricks.
    """
    # This regex is intended to match only relative paths or same-domain URLs
    # but can be bypassed with username@domain tricks
    pattern = r'^(/[^\s]*|https?://localhost[:\d]*/.*)'
    if re.match(pattern, url):
        return True
    return False

@app.route('/')
def home():
    """Main landing page with links to various features"""
    html = """
    <!DOCTYPE html>
    <html>
    <head><title>Corporate Portal</title></head>
    <body>
        <h1>Welcome to Corporate Portal</h1>
        <h2>User Features:</h2>
        <ul>
            <li><a href="/login?next=/dashboard">Login to Dashboard</a></li>
            <li><a href="/redirect?url=http://localhost:5000/about">Quick Redirect Tool</a></li>
            <li><a href="/safe_redirect?target=http://localhost:5000/profile">Safe Redirect</a></li>
            <li><a href="/dashboard?return_to=/profile">User Dashboard</a></li>
            <li><a href="/legacy_redirect?destination=/settings">Legacy System Redirect</a></li>
            <li><a href="/goto?link=aHR0cDovL2xvY2FsaG9zdDo1MDAwL2hlbHA=">Goto Page</a></li>
        </ul>
        <h2>Static Pages:</h2>
        <ul>
            <li><a href="/about">About Us</a></li>
            <li><a href="/profile">User Profile</a></li>
            <li><a href="/settings">Settings</a></li>
        </ul>
    </body>
    </html>
    """
    return render_template_string(html)

@app.route('/login', methods=['GET', 'POST'])
def login():
    """
    Login endpoint with redirect functionality.
    Accepts 'next' parameter for post-login redirect.
    Has basic validation but can be bypassed.
    """
    if request.method == 'POST':
        username = request.form.get('username', '')
        password = request.form.get('password', '')
        next_url = request.form.get('next', '/')
        
        # Authenticate user
        if username in users and users[username] == password:
            # Weak validation: only checks if it starts with /
            # Can be bypassed with //malicious-site.com
            if next_url.startswith('/'):
                return redirect(next_url)
            else:
                return redirect('/')
        else:
            return "Invalid credentials", 401
    
    # GET request - show login form
    next_url = request.args.get('next', '/')
    html = f"""
    <!DOCTYPE html>
    <html>
    <body>
        <h2>Login</h2>
        <form method="post">
            Username: <input type="text" name="username"><br>
            Password: <input type="password" name="password"><br>
            <input type="hidden" name="next" value="{next_url}">
            <input type="submit" value="Login">
        </form>
    </body>
    </html>
    """
    return render_template_string(html)

@app.route('/redirect')
def direct_redirect():
    """
    Simple redirect endpoint - NO VALIDATION
    VULNERABLE: Directly redirects to user-supplied URL parameter
    """
    url = request.args.get('url', '/')
    return redirect(url)

@app.route('/safe_redirect')
def safe_redirect():
    """
    Attempts to implement safe redirect with validation.
    Uses basic_url_check which only validates http:// prefix.
    VULNERABLE: Does not check for https:// - can be bypassed
    """
    target = request.args.get('target', '/')
    
    # Apply "safe" validation - but only checks for http://
    if target.startswith('/') or basic_url_check(target):
        return redirect(target)
    else:
        return "Invalid redirect target - must be relative or http://", 400

@app.route('/dashboard')
def dashboard():
    """
    Dashboard endpoint with whitelist validation.
    SECURE: Properly validates against whitelist of allowed domains.
    """
    return_to = request.args.get('return_to', '/profile')
    
    # Check if URL is relative path
    if return_to.startswith('/') and not return_to.startswith('//'):
        # Additional check to ensure it's just a path
        if '://' not in return_to:
            return redirect(return_to)
    
    # Check if URL domain is in whitelist
    if is_safe_domain(return_to):
        return redirect(return_to)
    
    # Default safe redirect if validation fails
    return redirect('/profile')

@app.route('/legacy_redirect')
def legacy_redirect():
    """
    Legacy system redirect with weak regex validation.
    Attempts to use weak_domain_validation but has bypass vulnerabilities.
    VULNERABLE: Can be bypassed with @ symbol in URL (username@domain)
    """
    destination = request.args.get('destination', '/')
    
    # Apply weak validation
    if weak_domain_validation(destination):
        return redirect(destination)
    else:
        # Fallback - but still vulnerable
        # Checks if URL contains localhost, but can be tricked
        if 'localhost' in destination:
            return redirect(destination)
        return "Invalid destination", 400

@app.route('/goto')
def goto():
    """
    Redirect using base64 encoded URLs.
    VULNERABLE: Decodes base64 but doesn't validate the resulting URL
    """
    encoded_link = request.args.get('link', '')
    
    if encoded_link:
        try:
            # Decode base64 URL
            decoded_url = base64.b64decode(encoded_link).decode('utf-8')
            # No validation after decoding - direct redirect
            return redirect(decoded_url)
        except:
            return "Invalid encoded link", 400
    
    return redirect('/')

@app.route('/about')
def about():
    """Static about page"""
    return "<h1>About Us</h1><p>We are a corporate portal.</p>"

@app.route('/profile')
def profile():
    """Static profile page"""
    return "<h1>User Profile</h1><p>Welcome to your profile.</p>"

@app.route('/settings')
def settings():
    """Static settings page"""
    return "<h1>Settings</h1><p>Configure your preferences here.</p>"

@app.route('/help')
def help_page():
    """Static help page"""
    return "<h1>Help</h1><p>Contact support for assistance.</p>"

if __name__ == '__main__':
    # Run in debug mode for development
    app.run(debug=True, host='0.0.0.0', port=5000)