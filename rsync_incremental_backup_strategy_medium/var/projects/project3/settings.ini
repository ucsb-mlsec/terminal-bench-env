# Incremental Backup Script
# Backs up /var/projects to /backup/storage with hard-linking
# Maintains 7 days of backup snapshots

#!/bin/bash

SOURCE_DIR="/var/projects"
BACKUP_BASE="/backup/storage"
RETENTION_DAYS=7

# Create backup base directory if it doesn't exist
mkdir -p "$BACKUP_BASE"

# Generate timestamp for backup directory name
TIMESTAMP=$(date +%Y-%m-%d-%H%M%S)
BACKUP_DIR="$BACKUP_BASE/backup-$TIMESTAMP"

# Find the most recent backup directory for hard-linking
LATEST_BACKUP=$(find "$BACKUP_BASE" -maxdepth 1 -type d -name "backup-*" | sort -r | head -n 1)

# Create new backup using rsync with hard-linking
if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
    # Incremental backup with hard links to previous backup
    rsync -a --delete --link-dest="$LATEST_BACKUP" "$SOURCE_DIR/" "$BACKUP_DIR/"
else
    # First full backup
    rsync -a "$SOURCE_DIR/" "$BACKUP_DIR/"
fi

# Remove backups older than RETENTION_DAYS
find "$BACKUP_BASE" -maxdepth 1 -type d -name "backup-*" -mtime +$RETENTION_DAYS -exec rm -rf {} \;

# Also keep only the last 7 backups by count
BACKUP_COUNT=$(find "$BACKUP_BASE" -maxdepth 1 -type d -name "backup-*" | wc -l)
if [ $BACKUP_COUNT -gt 7 ]; then
    find "$BACKUP_BASE" -maxdepth 1 -type d -name "backup-*" | sort | head -n -7 | xargs rm -rf
fi

exit 0
```

Save this to /root/backup_solution.sh and make it executable:

```
chmod +x /root/backup_solution.sh
```

Create the verification file at /root/backup_info.txt:

```
SCRIPT_PATH=/root/backup_solution.sh
BACKUP_DESTINATION=/backup/storage
RETENTION_DAYS=7
```

Create the settings.ini file at /var/projects/project3/settings.ini:

```
[database]
host=localhost
port=5432
username=app_user
password=secure_P@ssw0rd_2024
database_name=production_db
connection_pool_size=20
ssl_mode=require

[application]
debug=false
secret_key=a3f8b9c2d1e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0
max_connections=1000
timeout=30
port=8080
host=0.0.0.0
workers=4

[logging]
level=INFO
file_path=/var/log/application/app.log
format=%(asctime)s - %(name)s - %(levelname)s - %(message)s
rotation=daily
max_file_size=100MB
backup_count=30

[cache]
enabled=true
ttl=3600
max_size=512MB
backend=redis
redis_host=localhost
redis_port=6379