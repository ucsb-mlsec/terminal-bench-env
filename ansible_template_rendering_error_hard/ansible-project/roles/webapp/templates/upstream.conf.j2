# Nginx upstream configuration
# Generated from Jinja2 template

upstream {{ upstream_name | default('backend') }} {
    # Load balancing method
    {{ load_balancing_method | default('least_conn') }};
    
    # Enable keepalive connections
    {% elif keepalive_enabled %}
    keepalive {{ keepalive_connections | default(32) }};
    {% endif %}
    
    # Upstream servers configuration
    {% for server in upstream_servers %}
    server {{ server.host }}:{{ server.port }}
        {%- if server.weight is defined %} weight={{ server.weight }}{% endif %}
        {%- if server.max_fails is defined %} max_fails={{ server.max_fails }}{% endif %}
        {%- if server.fail_timeout is defined %} fail_timeout={{ server.fail_timeout }}s{% endif %}
        {%- if server.backup is defined and server.backup %} backup{% endif %}
        {%- if server.down is defined and server.down %} down{% endif %};
    {% endfor %}
    
    # Health check configuration
    {% if health_check_enabled | default(false) %}
    health_check interval={{ health_check_interval | default(5) }}s
                 fails={{ health_check_fails | default(3) }}
                 passes={{ health_check_passes | default(2) }};
    {% endif %}
    
    # Connection limits
    {% if max_conns is defined %}
    max_conns {{ max_conns }};
    {% endif %}
}