---
- name: Deploy Web Servers
  hosts: webservers
  become: yes
  
  tasks:
    - name: Install nginx web server
      apt:
        name: nginx
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"
    
    - name: Install httpd web server
      yum:
        name: httpd
        state: present
      when: ansible_os_family == "RedHat"
    
    - name: Create web server configuration directory
      file:
        path: /etc/nginx/sites-available
        state: directory
        mode: '0755'
      when: ansible_os_family == "Debian"
    
    - name: Copy nginx configuration file
      copy:
        content: |
          server {
              listen 80 default_server;
              listen [::]:80 default_server;
              
              root /var/www/html;
              index index.html index.htm;
              
              server_name _;
              
              location / {
                  try_files $uri $uri/ =404;
              }
              
              location /health {
                  access_log off;
                  return 200 "healthy\n";
                  add_header Content-Type text/plain;
              }
          }
        dest: /etc/nginx/sites-available/default
        mode: '0644'
      when: ansible_os_family == "Debian"
      notify: restart nginx
    
    - name: Copy httpd configuration file
      copy:
        content: |
          <VirtualHost *:80>
              DocumentRoot /var/www/html
              <Directory /var/www/html>
                  AllowOverride All
                  Require all granted
              </Directory>
              <Location /health>
                  SetHandler server-status
              </Location>
          </VirtualHost>
        dest: /etc/httpd/conf.d/webserver.conf
        mode: '0644'
      when: ansible_os_family == "RedHat"
      notify: restart httpd
    
    - name: Create web root directory
      file:
        path: /var/www/html
        state: directory
        mode: '0755'
    
    - name: Deploy index page
      copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>Welcome</title>
          </head>
          <body>
              <h1>Web Server Deployed Successfully</h1>
              <p>Hostname: {{ ansible_hostname }}</p>
          </body>
          </html>
        dest: /var/www/html/index.html
        mode: '0644'
    
    - name: Start and enable nginx service
      service:
        name: nginx
        state: started
        enabled: yes
      when: ansible_os_family == "Debian"
    
    - name: Start and enable httpd service
      service:
        name: httpd
        state: started
        enabled: yes
      when: ansible_os_family == "RedHat"
    
    - name: Wait for web server to be ready
      wait_for:
        port: 80
        delay: 2
        timeout: 30
    
    - name: Perform health check on nginx
      shell: curl -f http://localhost/health || curl -f http://localhost/
      register: health_check
      changed_when: false
      failed_when: health_check.rc != 0
      when: ansible_os_family == "Debian"
    
    - name: Perform health check on httpd
      shell: curl -f http://localhost/ || systemctl status httpd
      register: health_check
      changed_when: false
      failed_when: health_check.rc != 0
      when: ansible_os_family == "RedHat"
    
    - name: Display health check result
      debug:
        msg: "Web server is healthy and responding to requests"
  
  handlers:
    - name: restart nginx
      service:
        name: nginx
        state: restarted
      when: ansible_os_family == "Debian"
    
    - name: restart httpd
      service:
        name: httpd
        state: restarted
      when: ansible_os_family == "RedHat"