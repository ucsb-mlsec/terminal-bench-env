#!/usr/bin/env python3

import sys
import os

def main():
    if len(sys.argv) != 2:
        print("Usage: mock_ssh_client <profile>", file=sys.stderr)
        sys.exit(1)
    
    profile = sys.argv[1]
    config_path = f"/etc/mock_ssh/profiles/{profile}.conf"
    
    if not os.path.exists(config_path):
        print(f"Error: Profile '{profile}' not found", file=sys.stderr)
        sys.exit(1)
    
    # Read configuration file
    config = {}
    with open(config_path, 'r') as f:
        for line in f:
            line = line.strip()
            if line and '=' in line:
                key, value = line.split('=', 1)
                config[key.strip()] = value.strip()
    
    # Prompt for password
    sys.stdout.write(f"Password for {profile}: ")
    sys.stdout.flush()
    
    password = sys.stdin.readline().strip()
    
    # Verify password
    if password != config.get('password', ''):
        print("Authentication failed")
        sys.exit(1)
    
    # Connection successful
    print(f"Connected to {profile}")
    sys.stdout.flush()
    
    # Wait for command
    command = sys.stdin.readline().strip()
    
    # Process command
    if command == 'get_version':
        version = config.get('version', 'unknown')
        print(version)
        sys.stdout.flush()
    else:
        print(f"Unknown command: {command}")
        sys.stdout.flush()
    
    # Close connection
    print("Connection closed")
    sys.stdout.flush()

if __name__ == "__main__":
    main()