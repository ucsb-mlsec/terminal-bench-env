<?php
session_start();

// Simple user database with MD5 hashed passwords
$users = array(
    'admin' => array(
        'password_hash' => '0e462097431906509019562988736854', // MD5 of '240610708'
        'role' => 'administrator'
    ),
    'user1' => array(
        'password_hash' => '5f4dcc3b5aa765d61d8327deb882cf99', // MD5 of 'password'
        'role' => 'user'
    ),
    'testuser' => array(
        'password_hash' => '0e215962017', // MD5 of 'QNKCDZO'
        'role' => 'user'
    )
);

// Initialize session variables
if (!isset($_SESSION['authenticated'])) {
    $_SESSION['authenticated'] = false;
    $_SESSION['admin'] = false;
    $_SESSION['username'] = '';
}

// Handle login POST request
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_POST['username']) && isset($_POST['password'])) {
        $username = $_POST['username'];
        $password = $_POST['password'];
        
        // Check if user exists
        if (array_key_exists($username, $users)) {
            $stored_hash = $users[$username]['password_hash'];
            
            // Hash the provided password
            $password_hash = md5($password);
            
            // Vulnerable comparison - using loose comparison instead of strict
            if ($password_hash == $stored_hash) {
                // Authentication successful
                $_SESSION['authenticated'] = true;
                $_SESSION['username'] = $username;
                
                // Check if user is admin
                if ($users[$username]['role'] === 'administrator') {
                    $_SESSION['admin'] = true;
                    echo "SUCCESS: Authentication successful! Welcome Administrator " . htmlspecialchars($username) . "!\n";
                    echo "You have administrative privileges.\n";
                } else {
                    $_SESSION['admin'] = false;
                    echo "SUCCESS: Authentication successful! Welcome " . htmlspecialchars($username) . "!\n";
                }
            } else {
                // Authentication failed
                echo "ERROR: Invalid username or password.\n";
                $_SESSION['authenticated'] = false;
                $_SESSION['admin'] = false;
            }
        } else {
            // User not found
            echo "ERROR: Invalid username or password.\n";
            $_SESSION['authenticated'] = false;
            $_SESSION['admin'] = false;
        }
    } else {
        echo "ERROR: Username and password are required.\n";
    }
} else {
    // Display login form
    echo "<!DOCTYPE html>\n";
    echo "<html>\n";
    echo "<head><title>Login</title></head>\n";
    echo "<body>\n";
    echo "<h2>Login</h2>\n";
    echo "<form method='POST' action='login.php'>\n";
    echo "Username: <input type='text' name='username' required><br><br>\n";
    echo "Password: <input type='password' name='password' required><br><br>\n";
    echo "<input type='submit' value='Login'>\n";
    echo "</form>\n";
    echo "</body>\n";
    echo "</html>\n";
}
?>