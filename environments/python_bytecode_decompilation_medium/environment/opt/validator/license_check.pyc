import marshal
import struct
import time
import sys

def create_validation_bytecode():
    """
    Creates a Python bytecode file for a license validation system.
    The validation logic checks for:
    1. Format: LICENSE-XXXX-YYYY-ZZZZ (where segments are alphanumeric)
    2. First segment must be "LICENSE"
    3. Next two segments must be exactly 4 characters (alphanumeric uppercase)
    4. Last segment is a checksum: first 4 chars of MD5 hash of previous segments, uppercase
    """
    
    source_code = '''import hashlib

def validate_license(key):
    """Validate license key format and checksum"""
    if not isinstance(key, str):
        return False
    
    parts = key.split('-')
    
    if len(parts) != 4:
        return False
    
    if parts[0] != 'LICENSE':
        return False
    
    if len(parts[1]) != 4 or not parts[1].isalnum() or not parts[1].isupper():
        return False
    
    if len(parts[2]) != 4 or not parts[2].isalnum() or not parts[2].isupper():
        return False
    
    if len(parts[3]) != 4 or not parts[3].isalnum() or not parts[3].isupper():
        return False
    
    base = '-'.join(parts[:3])
    expected_checksum = hashlib.md5(base.encode()).hexdigest()[:4].upper()
    
    return parts[3] == expected_checksum

def check_license(key):
    """Main entry point for license validation"""
    return validate_license(key)
'''
    
    # Compile the source code
    code_obj = compile(source_code, 'license_check.py', 'exec')
    
    # Python 3.8+ .pyc format:
    # - Magic number (4 bytes)
    # - Flags (4 bytes) 
    # - Timestamp (4 bytes)
    # - Source size (4 bytes)
    # - Marshalled code object
    
    magic = b'\x55\x0d\x0d\x0a'  # Python 3.8 magic number
    flags = b'\x00\x00\x00\x00'
    timestamp = struct.pack('I', int(time.time()))
    source_size = struct.pack('I', len(source_code))
    
    bytecode = magic + flags + timestamp + source_size + marshal.dumps(code_obj)
    
    return bytecode

# Generate the bytecode file
bytecode_content = create_validation_bytecode()

# Write to file
with open('/opt/validator/license_check.pyc', 'wb') as f:
    f.write(bytecode_content)