init_config:
  min_collection_interval: 1

instances:
  - host: localhost
    port: 5432
    username: datadog
    password: datadog_monitor_password
    dbname: postgres
    tags:
      - env:production
      - service:main-db
    collect_function_metrics: true
    collect_count_metrics: true
    collect_activity_metrics: true
    collect_database_size_metrics: true
    collect_default_database: true
    
    custom_queries:
      - metric_prefix: postgresql.custom
        query: |
          SELECT 
            schemaname,
            tablename,
            pg_total_relation_size(schemaname||'.'||tablename) as total_bytes,
            pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
            pg_relation_size(schemaname||'.'||tablename) as table_bytes,
            pg_indexes_size(schemaname||'.'||tablename) as indexes_bytes,
            n_live_tup,
            n_dead_tup,
            last_vacuum,
            last_autovacuum,
            last_analyze,
            last_autoanalyze
          FROM pg_stat_user_tables
          JOIN pg_tables ON pg_stat_user_tables.tablename = pg_tables.tablename
          WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
          ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
        columns:
          - name: schema
            type: tag
          - name: table
            type: tag
          - name: total_bytes
            type: gauge
          - name: table_bytes
            type: gauge
          - name: indexes_bytes
            type: gauge
          - name: live_tuples
            type: gauge
          - name: dead_tuples
            type: gauge
        tags:
          - query:table_sizes

      - metric_prefix: postgresql.query_performance
        query: |
          SELECT 
            query,
            calls,
            total_time,
            mean_time,
            max_time,
            stddev_time,
            rows,
            shared_blks_hit,
            shared_blks_read,
            shared_blks_dirtied,
            temp_blks_read,
            temp_blks_written
          FROM pg_stat_statements
          JOIN pg_database ON pg_stat_statements.dbid = pg_database.oid
          WHERE pg_database.datname = current_database()
          ORDER BY total_time DESC
          LIMIT 100;
        columns:
          - name: query_text
            type: tag
          - name: calls
            type: gauge
          - name: total_time
            type: gauge
          - name: mean_time
            type: gauge
          - name: max_time
            type: gauge
          - name: stddev_time
            type: gauge
          - name: rows
            type: gauge
          - name: shared_blocks_hit
            type: gauge
          - name: shared_blocks_read
            type: gauge
          - name: shared_blocks_dirtied
            type: gauge
          - name: temp_blocks_read
            type: gauge
          - name: temp_blocks_written
            type: gauge
        tags:
          - query:statement_stats

      - metric_prefix: postgresql.lock_analysis
        query: |
          SELECT 
            pg_database.datname as database,
            pg_locks.locktype,
            pg_locks.mode,
            pg_class.relname as relation,
            pg_locks.pid,
            pg_locks.granted,
            pg_stat_activity.query,
            pg_stat_activity.state,
            pg_stat_activity.wait_event_type,
            pg_stat_activity.wait_event,
            EXTRACT(EPOCH FROM (NOW() - pg_stat_activity.query_start)) as query_duration
          FROM pg_locks
          LEFT JOIN pg_class ON pg_locks.relation = pg_class.oid
          LEFT JOIN pg_database ON pg_locks.database = pg_database.oid
          LEFT JOIN pg_stat_activity ON pg_locks.pid = pg_stat_activity.pid
          WHERE pg_locks.pid IS NOT NULL;
        columns:
          - name: database
            type: tag
          - name: locktype
            type: tag
          - name: mode
            type: tag
          - name: relation
            type: tag
          - name: pid
            type: gauge
          - name: granted
            type: gauge
          - name: state
            type: tag
          - name: wait_event_type
            type: tag
          - name: wait_event
            type: tag
          - name: query_duration_seconds
            type: gauge
        tags:
          - query:lock_monitoring