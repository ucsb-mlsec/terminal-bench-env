import numpy as np
from scipy import ndimage
import os

np.random.seed(42)

# Generate clean digit images similar to MNIST
# We'll create synthetic digit images with clear, well-formed digits

def generate_digit_image(digit, size=28):
    """Generate a clean synthetic digit image"""
    img = np.zeros((size, size), dtype=np.float32)
    
    # Simple rendering based on digit
    if digit == 0:
        # Draw a circle
        y, x = np.ogrid[-14:14, -14:14]
        mask = (x**2 + y**2 <= 64) & (x**2 + y**2 >= 36)
        img[mask] = 1.0
    elif digit == 1:
        # Draw a vertical line
        img[4:24, 12:16] = 1.0
        img[4:8, 10:12] = 0.7
    elif digit == 2:
        # Draw a 2
        img[6:10, 8:20] = 1.0
        img[6:14, 18:22] = 1.0
        img[12:16, 8:20] = 1.0
        img[14:22, 6:10] = 1.0
        img[20:24, 6:20] = 1.0
    elif digit == 3:
        # Draw a 3
        img[6:10, 8:20] = 1.0
        img[12:16, 10:20] = 1.0
        img[20:24, 8:20] = 1.0
        img[6:24, 18:22] = 1.0
    elif digit == 4:
        # Draw a 4
        img[6:16, 6:10] = 1.0
        img[14:18, 6:20] = 1.0
        img[6:24, 16:20] = 1.0
    elif digit == 5:
        # Draw a 5
        img[6:10, 8:20] = 1.0
        img[6:16, 6:10] = 1.0
        img[12:16, 8:20] = 1.0
        img[14:22, 18:22] = 1.0
        img[20:24, 8:20] = 1.0
    elif digit == 6:
        # Draw a 6
        img[6:22, 6:10] = 1.0
        img[6:10, 8:20] = 1.0
        img[12:16, 8:20] = 1.0
        img[20:24, 8:20] = 1.0
        img[14:22, 18:22] = 1.0
    elif digit == 7:
        # Draw a 7
        img[6:10, 6:20] = 1.0
        img[6:24, 16:20] = 1.0
    elif digit == 8:
        # Draw an 8
        img[6:10, 8:20] = 1.0
        img[20:24, 8:20] = 1.0
        img[12:16, 8:20] = 1.0
        img[6:24, 6:10] = 1.0
        img[6:24, 18:22] = 1.0
    elif digit == 9:
        # Draw a 9
        img[6:10, 8:20] = 1.0
        img[6:16, 6:10] = 1.0
        img[6:16, 18:22] = 1.0
        img[12:16, 8:20] = 1.0
        img[14:24, 16:20] = 1.0
    
    return img

# Generate 5000 clean digit images
num_samples = 5000
images = np.zeros((num_samples, 28, 28), dtype=np.float32)
labels = np.zeros(num_samples, dtype=np.int64)

samples_per_digit = num_samples // 10

for i in range(num_samples):
    digit = i // samples_per_digit
    if digit >= 10:
        digit = 9
    
    # Generate base digit
    img = generate_digit_image(digit)
    
    # Add some variation - slight shifts and thickness variations
    shift_x = np.random.randint(-2, 3)
    shift_y = np.random.randint(-2, 3)
    img = ndimage.shift(img, [shift_y, shift_x], mode='constant', cval=0)
    
    # Add slight thickness variation with dilation/erosion
    if np.random.random() > 0.5:
        img = ndimage.grey_dilation(img, size=(2, 2))
    
    # Smooth slightly for more realistic appearance
    img = ndimage.gaussian_filter(img, sigma=0.3)
    
    # Normalize to [0, 1]
    if img.max() > 0:
        img = img / img.max()
    
    images[i] = img
    labels[i] = digit

# Shuffle the data
indices = np.random.permutation(num_samples)
images = images[indices]
labels = labels[indices]

# Ensure output directory exists
os.makedirs('/workspace/data', exist_ok=True)

# Save as NPZ file
np.savez('/workspace/data/clean_digits.npz', images=images, labels=labels)

print(f"Generated clean_digits.npz with {num_samples} samples")
print(f"Images shape: {images.shape}")
print(f"Labels shape: {labels.shape}")
print(f"Label distribution: {np.bincount(labels)}")
print(f"Image value range: [{images.min():.3f}, {images.max():.3f}]")