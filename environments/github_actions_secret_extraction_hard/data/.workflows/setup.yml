name: Infrastructure Setup
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'

jobs:
  provision-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Configure Ansible vault
        run: |
          echo "${{ secrets.ANSIBLE_VAULT_PASS }}" > ~/.ansible_vault_pass
          chmod 600 ~/.ansible_vault_pass

      - name: Run server provisioning
        run: |
          ansible-playbook -i inventory/hosts playbooks/provision.yml \
            --vault-password-file ~/.ansible_vault_pass \
            -e "server_password=${{ secrets.SERVER_PASSWORD }}"

      - name: Install dependencies
        run: |
          ansible-playbook -i inventory/hosts playbooks/install_deps.yml \
            --vault-password-file ~/.ansible_vault_pass

      - name: Configure firewall
        run: |
          ansible-playbook -i inventory/hosts playbooks/firewall.yml

      - name: Setup monitoring
        run: |
          ansible-playbook -i inventory/hosts playbooks/monitoring.yml

      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          rm -f ~/.ansible_vault_pass