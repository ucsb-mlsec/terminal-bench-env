module Admin
  class PostsController < ApplicationController
    before_filter :require_admin
    
    def index
      @posts = Post.where(approved: false)
      
      respond_to do |format|
        format.html
        format.json { render json: @posts }
      end
    end
    
    def approve
      @post = Post.find(params[:id])
      
      if @post.update_attributes(params[:post])
        respond_to do |format|
          format.html { redirect_to admin_posts_path, notice: 'Post approved successfully.' }
          format.json { render json: @post, status: :ok }
        end
      else
        respond_to do |format|
          format.html { redirect_to admin_posts_path, alert: 'Failed to approve post.' }
          format.json { render json: @post.errors, status: :unprocessable_entity }
        end
      end
    end
    
    def update_status
      @post = Post.find(params[:id])
      
      @post.approved = true
      
      if @post.save
        respond_to do |format|
          format.html { redirect_to admin_posts_path, notice: 'Post status updated.' }
          format.json { render json: @post, status: :ok }
        end
      else
        respond_to do |format|
          format.html { redirect_to admin_posts_path, alert: 'Failed to update status.' }
          format.json { render json: @post.errors, status: :unprocessable_entity }
        end
      end
    end
    
    private
    
    def require_admin
      unless current_user && current_user.admin?
        redirect_to root_path, alert: 'Access denied.'
      end
    end
  end
end