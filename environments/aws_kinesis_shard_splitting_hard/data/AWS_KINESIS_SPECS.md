# AWS Kinesis Shard Specifications

## Hash Key Range

AWS Kinesis uses a 128-bit hash key space for distributing data across shards. The valid hash key range is from 0 to 2^128 - 1, which equals 340282366920938463463374607431768211455.

Hash keys are 128-bit unsigned integers that are generated by applying an MD5 hash function to partition keys. This large space allows for uniform distribution of data across shards.

The maximum hash key value is: **340282366920938463463374607431768211455**

## Shard Splitting Rules

When splitting a shard in AWS Kinesis, the following rules must be followed:

1. **Two Child Shards**: A parent shard must be divided into exactly two child shards. You cannot split a shard into more or fewer than two children.

2. **Sequential Naming**: Child shards are named with a sequential number suffix that increments from the parent shard naming scheme.

3. **Contiguous Ranges**: The hash key ranges of the two child shards must be contiguous, meaning there can be no gaps between them.

4. **Complete Coverage**: The child shards must cover the entire hash key range of the parent shard with no overlaps.

5. **Parent Closure**: Once a shard is split, the parent shard is closed and no longer accepts new data, though existing data remains accessible.

## Hash Key Range Format

Each shard in Kinesis has two boundary values:

- **Starting Hash Key**: The inclusive lower bound of the shard's hash key range
- **Ending Hash Key**: The inclusive upper bound of the shard's hash key range

When splitting a shard, you must choose a split point within the parent's hash key range. The split point determines how the parent range is divided:

- **Child Shard 1**: Receives the range from `parent_start_hash` to `split_point` (inclusive)
- **Child Shard 2**: Receives the range from `split_point + 1` to `parent_end_hash` (inclusive)

### Example Split Calculation

Suppose a parent shard has:
- Starting Hash Key: 0
- Ending Hash Key: 340282366920938463463374607431768211455

If you choose to split at the midpoint, the calculation would be:

```
split_point = (0 + 340282366920938463463374607431768211455) // 2
split_point = 170141183460469231731687303715884105727
```

The resulting child shards would be:
- **Child Shard 1**: Start = 0, End = 170141183460469231731687303715884105727
- **Child Shard 2**: Start = 170141183460469231731687303715884105728, End = 340282366920938463463374607431768211455

## Validation Rules

To validate a shard splitting plan, you must verify the following:

### 1. Range Coverage
Each pair of child shards must cover the exact range of its parent shard:
```
child1_start == parent_start
child2_end == parent_end
child1_end + 1 == child2_start
```

### 2. No Overlaps
There must be no overlap between child shards:
```
child1_end < child2_start
```

### 3. Valid Hash Keys
All hash keys must be within the valid 128-bit range:
```
0 <= hash_key <= 340282366920938463463374607431768211455
```

### 4. Non-Empty Ranges
Each child shard must have at least one hash key value:
```
child_start <= child_end
```

### Complete Example with Multiple Shards

Consider a stream with 4 shards covering the entire hash space:

**Original Shards:**
- Shard-0001: 0 to 85070591730234615865843651857942052863
- Shard-0002: 85070591730234615865843651857942052864 to 170141183460469231731687303715884105727
- Shard-0003: 170141183460469231731687303715884105728 to 255211775190703847597530955573826158591
- Shard-0004: 255211775190703847597530955573826158592 to 340282366920938463463374607431768211455

**Splitting Shard-0002:**

Parent range: 85070591730234615865843651857942052864 to 170141183460469231731687303715884105727

Split point: 127605887595351923798765477786913079295

Resulting child shards:
- Shard-0002-Child-1: 85070591730234615865843651857942052864 to 127605887595351923798765477786913079295
- Shard-0002-Child-2: 127605887595351923798765477786913079296 to 170141183460469231731687303715884105727

**Validation:**
- Coverage: ✓ (85070591730234615865843651857942052864 to 170141183460469231731687303715884105727)
- No gaps: ✓ (127605887595351923798765477786913079295 + 1 = 127605887595351923798765477786913079296)
- No overlaps: ✓ (Child-1 end < Child-2 start)
- Valid range: ✓ (all values within 0 to 340282366920938463463374607431768211455)