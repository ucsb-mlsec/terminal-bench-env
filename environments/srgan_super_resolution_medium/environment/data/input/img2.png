import os
import numpy as np
from PIL import Image
from scipy import ndimage

def normalize_image(img_array):
    """Normalize image from [0, 255] to [-1, 1]"""
    return (img_array.astype(np.float32) / 127.5) - 1.0

def denormalize_image(img_array):
    """Denormalize image from [-1, 1] to [0, 255]"""
    img_array = (img_array + 1.0) * 127.5
    return np.clip(img_array, 0, 255).astype(np.uint8)

def upscale_image(img_array, scale_factor=4):
    """Upscale image using bicubic interpolation"""
    # img_array shape: (height, width, channels)
    h, w, c = img_array.shape
    new_h, new_w = h * scale_factor, w * scale_factor
    
    # Process each channel separately
    upscaled = np.zeros((new_h, new_w, c), dtype=img_array.dtype)
    for i in range(c):
        upscaled[:, :, i] = ndimage.zoom(img_array[:, :, i], scale_factor, order=3)
    
    return upscaled

def process_image(input_path, output_path):
    """Process a single image through the pipeline"""
    # Load image
    img = Image.open(input_path).convert('RGB')
    img_array = np.array(img)
    
    original_size = img_array.shape[0]  # Assuming square images
    
    # Normalize
    normalized = normalize_image(img_array)
    
    # Upscale
    upscaled = upscale_image(normalized, scale_factor=4)
    
    # Denormalize
    denormalized = denormalize_image(upscaled)
    
    # Save output
    output_img = Image.fromarray(denormalized)
    output_img.save(output_path)
    
    output_size = denormalized.shape[0]  # Assuming square images
    
    return original_size, output_size

def main():
    input_dir = '/workspace/input/'
    output_dir = '/workspace/output/'
    
    # Create output directory if it doesn't exist
    os.makedirs(output_dir, exist_ok=True)
    
    # Get all PNG files
    png_files = [f for f in os.listdir(input_dir) if f.lower().endswith('.png')]
    
    images_processed = 0
    total_input_size = 0
    total_output_size = 0
    
    # Process each image
    for filename in png_files:
        input_path = os.path.join(input_dir, filename)
        output_path = os.path.join(output_dir, filename)
        
        try:
            input_size, output_size = process_image(input_path, output_path)
            images_processed += 1
            total_input_size += input_size
            total_output_size += output_size
            print(f"Processed: {filename} ({input_size}x{input_size} -> {output_size}x{output_size})")
        except Exception as e:
            print(f"Error processing {filename}: {e}")
    
    # Calculate averages
    if images_processed > 0:
        avg_input_size = total_input_size // images_processed
        avg_output_size = total_output_size // images_processed
    else:
        avg_input_size = 0
        avg_output_size = 0
    
    # Write results file
    results_path = '/workspace/results.txt'
    with open(results_path, 'w') as f:
        f.write(f"images_processed={images_processed}\n")
        f.write(f"average_input_size={avg_input_size}\n")
        f.write(f"average_output_size={avg_output_size}\n")
    
    print(f"\nProcessing complete!")
    print(f"Images processed: {images_processed}")
    print(f"Average input size: {avg_input_size}")
    print(f"Average output size: {avg_output_size}")

if __name__ == "__main__":
    main()