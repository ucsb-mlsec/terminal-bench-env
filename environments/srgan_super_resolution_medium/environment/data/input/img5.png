import numpy as np
from PIL import Image
import os
from pathlib import Path

def normalize_image(img_array):
    """Normalize image from [0, 255] to [-1, 1]"""
    return (img_array.astype(np.float32) / 127.5) - 1.0

def denormalize_image(img_array):
    """Denormalize image from [-1, 1] to [0, 255]"""
    img_array = (img_array + 1.0) * 127.5
    return np.clip(img_array, 0, 255).astype(np.uint8)

def upscale_image(img_array, scale_factor=4):
    """Upscale image using bilinear interpolation"""
    from scipy.ndimage import zoom
    
    # img_array shape: (height, width, channels)
    zoom_factors = (scale_factor, scale_factor, 1)
    upscaled = zoom(img_array, zoom_factors, order=1)  # order=1 for bilinear
    
    return upscaled

def process_image(input_path, output_path):
    """Process a single image through the pipeline"""
    # Read image
    img = Image.open(input_path)
    img_array = np.array(img)
    
    # Get original dimensions
    original_height, original_width = img_array.shape[:2]
    
    # Normalize to [-1, 1]
    normalized = normalize_image(img_array)
    
    # Upscale by 4x
    upscaled = upscale_image(normalized, scale_factor=4)
    
    # Denormalize back to [0, 255]
    denormalized = denormalize_image(upscaled)
    
    # Save output
    output_img = Image.fromarray(denormalized)
    output_img.save(output_path)
    
    return original_width, original_height, upscaled.shape[1], upscaled.shape[0]

def main():
    # Setup paths
    input_dir = Path('/workspace/input')
    output_dir = Path('/workspace/output')
    
    # Create output directory if it doesn't exist
    output_dir.mkdir(parents=True, exist_ok=True)
    
    # Get all PNG files
    png_files = list(input_dir.glob('*.png'))
    
    # Process statistics
    images_processed = 0
    total_input_size = 0
    total_output_size = 0
    
    # Process each image
    for input_path in png_files:
        output_path = output_dir / input_path.name
        
        try:
            input_w, input_h, output_w, output_h = process_image(input_path, output_path)
            images_processed += 1
            total_input_size += input_w  # Assuming square images
            total_output_size += output_w
            
            print(f"Processed: {input_path.name} ({input_w}x{input_h} -> {output_w}x{output_h})")
        except Exception as e:
            print(f"Error processing {input_path.name}: {e}")
    
    # Calculate averages
    if images_processed > 0:
        average_input_size = total_input_size // images_processed
        average_output_size = total_output_size // images_processed
    else:
        average_input_size = 0
        average_output_size = 0
    
    # Write results
    results_path = Path('/workspace/results.txt')
    with open(results_path, 'w') as f:
        f.write(f"images_processed={images_processed}\n")
        f.write(f"average_input_size={average_input_size}\n")
        f.write(f"average_output_size={average_output_size}\n")
    
    print(f"\nProcessing complete!")
    print(f"Images processed: {images_processed}")
    print(f"Average input size: {average_input_size}")
    print(f"Average output size: {average_output_size}")

if __name__ == "__main__":
    main()