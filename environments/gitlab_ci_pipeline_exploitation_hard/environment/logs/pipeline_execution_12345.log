Running with gitlab-runner 14.8.2 (566h97da)
  on docker-runner-prod-01 zx4k9mNp
Preparing the "docker" executor
00:01
Using Docker executor with image ubuntu:20.04 ...
Pulling docker image ubuntu:20.04 ...
Using docker image sha256:3bc6e9f30f51 for ubuntu:20.04 with digest ubuntu@sha256:82becede498899ec668628e7cb0ad87b6e1c371cb8a1e597d83a47fac21d6af3 ...
Preparing environment
00:02
Running on runner-zx4k9mNp-project-547-concurrent-0 via gitlab-runner-prod-01...
Getting source from Git repository
00:04
Fetching changes with git depth set to 50...
Reinitialized existing Git repository in /builds/acme-corp/backend-api/.git/
Checking out 4f8a92bc as main...
Skipping Git submodules setup
Executing "step_script" stage of the job script
00:38
$ echo "Starting build process for backend-api"
Starting build process for backend-api
$ export BUILD_ENV=production
$ echo "Build environment: $BUILD_ENV"
Build environment: production
$ echo "Authenticating with Docker registry..."
Authenticating with Docker registry...
$ docker login -u deployment-bot -p dkr_prod_9X2mK8nQ4vL6pR3sT7wY1zH5jN0cB4eA registry.acme-corp.com
WARNING! Using --password via the CLI is insecure. Use --password-stdin.
Login Succeeded
$ echo "Docker authentication successful"
Docker authentication successful
$ echo "Setting up AWS credentials for deployment"
Setting up AWS credentials for deployment
$ export AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
$ export AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
$ export AWS_DEFAULT_REGION=us-east-1
$ echo "AWS credentials configured"
AWS credentials configured
$ echo "Cloning configuration repository..."
Cloning configuration repository...
$ git clone https://gitlab-ci-token:glpat-zXy9W8v7U6t5S4r3Q2p1M0@gitlab.acme-corp.com/acme-corp/production-configs.git
Cloning into 'production-configs'...
remote: Enumerating objects: 234, done.
remote: Counting objects: 100% (234/234), done.
remote: Compressing objects: 100% (156/156), done.
remote: Total 234 (delta 98), reused 187 (delta 67), pack-reused 0
Receiving objects: 100% (234/234), 89.43 KiB | 2.98 MiB/s, done.
Resolving deltas: 100% (98/98), done.
$ cd production-configs && ls -la
total 48
drwxr-xr-x 6 gitlab-runner gitlab-runner 4096 Jan 15 14:23 .
drwxr-xr-x 8 gitlab-runner gitlab-runner 4096 Jan 15 14:23 ..
drwxr-xr-x 8 gitlab-runner gitlab-runner 4096 Jan 15 14:23 .git
-rw-r--r-- 1 gitlab-runner gitlab-runner 1024 Jan 15 14:23 database.yml
-rw-r--r-- 1 gitlab-runner gitlab-runner 2048 Jan 15 14:23 secrets.env
$ cd ..
$ echo "Installing dependencies..."
Installing dependencies...
$ npm install --production
added 487 packages in 12.3s
$ echo "Running database migrations..."
Running database migrations...
$ export DATABASE_URL="postgresql://admin:P@ssw0rd_Pr0d_2024!@db.acme-corp.internal:5432/production_db"
$ echo "Database URL configured: $DATABASE_URL"
Database URL configured: postgresql://admin:P@ssw0rd_Pr0d_2024!@db.acme-corp.internal:5432/production_db
$ npm run migrate
> backend-api@2.1.4 migrate
> sequelize-cli db:migrate
Sequelize CLI [Node: 16.14.0, CLI: 6.4.1, ORM: 6.17.0]
Loaded configuration file "config/database.js".
Using environment "production".
== 20240115102345-add-user-permissions: migrating =======
== 20240115102345-add-user-permissions: migrated (0.234s)
$ echo "Building application..."
Building application...
$ npm run build
> backend-api@2.1.4 build
> webpack --mode production
asset main.js 2.4 MiB [emitted] (name: main)
webpack 5.75.0 compiled successfully in 8432 ms
$ echo "Configuring API keys for third-party services..."
Configuring API keys for third-party services...
$ export STRIPE_SECRET_KEY=sk_live_51MqK8LF3x2Vc9Yp4Hw7Gj6Tn5Rb3Zd2Qm1Pk0Nh8Mf7Le6Kd4Jc3Hb2Ga1
$ export SENDGRID_API_KEY=SG.xY9wV8uT7sR6qP5oN4mL3kJ2hG1fE0dC9bA8zA7yX6wV5uT4sR3qP2oN1mL0k
$ export SLACK_WEBHOOK_URL=https://hooks.slack.com/services/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
$ echo "Third-party API keys configured"
Third-party API keys configured
$ echo "Preparing deployment package..."
Preparing deployment package...
$ tar -czf backend-api-v2.1.4.tar.gz dist/ node_modules/ package.json
$ echo "Deployment package created: backend-api-v2.1.4.tar.gz"
Deployment package created: backend-api-v2.1.4.tar.gz
$ echo "Uploading to S3 bucket..."
Uploading to S3 bucket...
$ aws s3 cp backend-api-v2.1.4.tar.gz s3://acme-corp-deployments/backend-api/ --region us-east-1
upload: ./backend-api-v2.1.4.tar.gz to s3://acme-corp-deployments/backend-api/backend-api-v2.1.4.tar.gz
$ echo "Triggering deployment to production servers..."
Triggering deployment to production servers...
$ curl -X POST https://deploy.acme-corp.com/api/v1/deploy \
  -H "Authorization: Bearer prod_deploy_token_8K3nM9pL2qR5tW7yX0zA4bC6dE1fG3hJ" \
  -H "Content-Type: application/json" \
  -d '{"service":"backend-api","version":"2.1.4","environment":"production"}'
{"status":"success","deployment_id":"dep_7x9Y2k4M","message":"Deployment initiated"}
$ echo "Deployment triggered successfully"
Deployment triggered successfully
$ echo "Notifying team via Slack..."
Notifying team via Slack...
$ curl -X POST $SLACK_WEBHOOK_URL -H 'Content-Type: application/json' -d '{"text":"Backend API v2.1.4 deployed to production"}'
ok
$ echo "Notification sent"
Notification sent
$ echo "Cleaning up temporary files..."
Cleaning up temporary files...
$ rm -rf production-configs
$ echo "Printing environment summary for audit..."
Printing environment summary for audit...
$ printenv | grep -E "AWS|DATABASE|API|TOKEN" | sort
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_DEFAULT_REGION=us-east-1
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
DATABASE_URL=postgresql://admin:P@ssw0rd_Pr0d_2024!@db.acme-corp.internal:5432/production_db
SENDGRID_API_KEY=SG.xY9wV8uT7sR6qP5oN4mL3kJ2hG1fE0dC9bA8zA7yX6wV5uT4sR3qP2oN1mL0k
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/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
STRIPE_SECRET_KEY=sk_live_51MqK8LF3x2Vc9Yp4Hw7Gj6Tn5Rb3Zd2Qm1Pk0Nh8Mf7Le6Kd4Jc3Hb2Ga1
$ echo "Pipeline execution completed successfully"
Pipeline execution completed successfully
Uploading artifacts for successful job
00:02
Uploading artifacts...
dist/: found 847 matching files and directories
node_modules/: found 12453 matching files and directories
Uploading artifacts as "archive" to coordinator... ok
id=7829 responseStatus=201 Created token=glcbt-64_Xk9Mq2Lp5Rn8Tw1Yz4
Cleaning up project directory and file based variables
00:01
Job succeeded