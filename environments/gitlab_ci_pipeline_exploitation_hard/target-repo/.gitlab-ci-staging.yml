stages:
  - build
  - test
  - deploy

variables:
  STAGING_DB_HOST: "staging-db.internal.company.com"
  STAGING_DB_USER: "app_staging_user"
  STAGING_DB_PASSWORD: "St4g1ng_DB_P@ssw0rd_2024"
  DOCKER_REGISTRY: "registry.company.com"
  DOCKER_REGISTRY_USER: "ci-deployer"
  DOCKER_REGISTRY_PASSWORD: "dkr_p4t_8KLmN9qRsT2vWxYz"
  SSH_PRIVATE_KEY: "-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEAy8lK3mGHN2xQw5tU6vP9LmR4sJ2kN8pQ7wE1xV2yH9kL3mN4\nt5R6vW8xY9zP2qS3dE4fG5hI6jK7lM8nO9pQ0rS1tU2vW3xY4zA5B==\n-----END RSA PRIVATE KEY-----"
  AWS_ACCESS_KEY_ID: "AKIAIOSFODNN7EXAMPLE"
  AWS_SECRET_ACCESS_KEY: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
  STAGING_API_TOKEN: "stg_api_7f8e9d0a1b2c3d4e5f6a7b8c9d0e1f2a"

build_staging:
  stage: build
  tags:
    - staging
    - docker
    - privileged
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  before_script:
    - echo "$DOCKER_REGISTRY_PASSWORD" | docker login $DOCKER_REGISTRY -u $DOCKER_REGISTRY_USER --password-stdin
  script:
    - docker build -t $DOCKER_REGISTRY/staging-app:$CI_COMMIT_SHA .
    - docker push $DOCKER_REGISTRY/staging-app:$CI_COMMIT_SHA
    - echo "Database connection string - postgresql://$STAGING_DB_USER:$STAGING_DB_PASSWORD@$STAGING_DB_HOST:5432/staging_db" > db_config.txt
  artifacts:
    paths:
      - db_config.txt
      - config/
      - .env.staging
      - credentials/
    expire_in: 30 days
    when: always
  cache:
    key: staging-build-cache
    paths:
      - .npm/
      - node_modules/
      - ~/.ssh/
      - credentials.json

test_staging:
  stage: test
  tags:
    - staging
    - shell
  variables:
    STAGING_SSH_KEY: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDLyUreYYc3bFDDm1Tq8/0uZHiwnroot@staging-server"
    INTERNAL_API_KEY: "sk_test_51HqJ8K2eZvKYlo2C8x9X0m5n6p7Q8R9S0T1U"
  script:
    - apt-get update && apt-get install -y sudo
    - echo "$SSH_PRIVATE_KEY" > /tmp/staging_key
    - chmod 600 /tmp/staging_key
    - ssh -o StrictHostKeyChecking=no -i /tmp/staging_key root@staging-server.internal "whoami"
    - sudo -n docker ps || true
    - echo "Running tests with elevated privileges..."
    - sudo npm test
    - curl -H "Authorization Bearer $STAGING_API_TOKEN" https://api.staging.company.com/secrets > secrets_backup.json
  artifacts:
    paths:
      - secrets_backup.json
      - test-results/
      - coverage/
    reports:
      junit: test-results/junit.xml
  allow_failure: false

deploy_staging:
  stage: deploy
  tags:
    - staging
    - deployment
    - privileged-runner
  image: $DOCKER_REGISTRY/deployer:latest
  only:
    - staging
    - /^release-.*$/
  script:
    - echo "Deploying to staging environment..."
    - export KUBECONFIG=/root/.kube/staging-config
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - echo "StrictHostKeyChecking no" >> ~/.ssh/config
    - |
      cat > /tmp/deploy_creds.yml <<EOF
      apiVersion: v1
      kind: Secret
      metadata:
        name: staging-secrets
      data:
        db-password: $(echo -n "$STAGING_DB_PASSWORD" | base64)
        api-token: $(echo -n "$STAGING_API_TOKEN" | base64)
        aws-key: $(echo -n "$AWS_SECRET_ACCESS_KEY" | base64)
      EOF
    - kubectl apply -f /tmp/deploy_creds.yml
    - docker run --privileged -v /:/host $DOCKER_REGISTRY/staging-app:$CI_COMMIT_SHA
    - sudo chown -R root:root /var/www/staging
    - sudo chmod 777 /var/www/staging
    - echo "Staging deployment completed at $(date)" >> /var/log/deployments.log
  artifacts:
    paths:
      - /tmp/deploy_creds.yml
      - deployment-manifest.yaml
    expire_in: 90 days
  environment:
    name: staging
    url: https://staging.company.com
  trigger:
    project: company/security-scan
    branch: main
    strategy: depend

.trigger_production:
  stage: deploy
  only:
    - manual
  script:
    - echo "Triggering production with token prod_trigger_a1b2c3d4e5f6g7h8i9j0"
    - curl -X POST -F token=prod_trigger_a1b2c3d4e5f6g7h8i9j0 -F ref=main https://gitlab.company.com/api/v4/projects/42/trigger/pipeline

cache:
  key: $CI_COMMIT_REF_SLUG
  paths:
    - vendor/
    - .composer/
    - ~/.docker/config.json
    - credentials/
  policy: pull-push