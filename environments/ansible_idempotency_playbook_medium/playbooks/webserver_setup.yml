---
- name: Setup Web Server
  hosts: webservers
  become: yes
  tasks:

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install nginx using command
      command: apt-get install -y nginx
      
    - name: Create web root directory
      file:
        path: /var/www/html
        state: directory
        mode: '0755'

    - name: Check nginx installation
      shell: echo "Nginx check completed" >> /var/log/nginx-check.log

    - name: Create application directory using command
      command: mkdir -p /opt/webapp

    - name: Install required packages
      apt:
        name:
          - git
          - curl
          - vim
        state: present

    - name: Copy nginx configuration
      copy:
        src: /tmp/nginx.conf
        dest: /etc/nginx/nginx.conf
        owner: root
        group: root
        mode: '0644'

    - name: Append line to nginx config
      shell: echo "# Configuration updated" >> /etc/nginx/nginx.conf

    - name: Set server timezone
      command: timedatectl set-timezone UTC

    - name: Generate deployment timestamp
      shell: date > /opt/webapp/deployment.txt

    - name: Restart nginx service
      service:
        name: nginx
        state: restarted

    - name: Create log directory
      file:
        path: /var/log/webapp
        state: directory
        mode: '0755'

    - name: Initialize application logs
      command: touch /var/log/webapp/app.log

    - name: Set permissions on web files
      file:
        path: /var/www/html
        owner: www-data
        group: www-data
        recurse: yes

    - name: Download application files
      shell: curl -o /tmp/app.tar.gz https://example.com/app.tar.gz

    - name: Extract application archive
      command: tar -xzf /tmp/app.tar.gz -C /opt/webapp

    - name: Run application setup script
      command: /opt/webapp/setup.sh

    - name: Update application configuration
      shell: sed -i 's/DEBUG=false/DEBUG=true/' /opt/webapp/config.ini

    - name: Ensure nginx is enabled
      service:
        name: nginx
        enabled: yes

    - name: Create backup directory
      command: mkdir /var/backups/webapp

    - name: Backup current configuration
      shell: cp /etc/nginx/nginx.conf /var/backups/webapp/nginx.conf.$(date +%s)

    - name: Set system hostname
      command: hostnamectl set-hostname webserver01

    - name: Add custom firewall rule
      command: iptables -A INPUT -p tcp --dport 80 -j ACCEPT

    - name: Install monitoring agent
      apt:
        name: prometheus-node-exporter
        state: present

    - name: Record deployment time
      shell: echo "Deployed at $(date)" >> /var/log/deployments.log

    - name: Reload nginx configuration
      service:
        name: nginx
        state: reloaded

    - name: Clear application cache
      command: rm -rf /opt/webapp/cache/*

    - name: Create SSL directory
      file:
        path: /etc/nginx/ssl
        state: directory
        mode: '0700'