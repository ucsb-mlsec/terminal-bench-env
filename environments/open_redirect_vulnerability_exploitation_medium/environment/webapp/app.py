#!/usr/bin/env python3

from flask import Flask, request, redirect, render_template_string
from urllib.parse import urlparse

app = Flask(__name__)

# In-memory URL shortener dictionary
url_shortener_db = {
    'g00gl3': 'https://www.google.com',
    'gh': 'https://github.com',
    'wiki': 'https://wikipedia.org',
    'news': 'https://news.ycombinator.com',
    'python': 'https://python.org'
}

HOME_PAGE = """
<!DOCTYPE html>
<html>
<head><title>URL Shortener Service</title></head>
<body>
    <h1>URL Shortener Service</h1>
    <h2>Available Endpoints:</h2>
    <ul>
        <li><a href="/redirect?url=https://example.com">/redirect?url=[URL]</a> - Direct redirect</li>
        <li><a href="/goto?next=https://example.com">/goto?next=[URL]</a> - Navigation redirect</li>
        <li><a href="/login?return_to=/">/login?return_to=[PATH]</a> - Login redirect (POST or GET)</li>
        <li><a href="/s/g00gl3">/s/[SHORT_CODE]</a> - URL shortener</li>
        <li><a href="/safe_redirect?url=https://example.com">/safe_redirect?url=[URL]</a> - Validated redirect</li>
        <li><a href="/navigate?target=/home">/navigate?target=[PATH]</a> - Internal navigation</li>
    </ul>
    <h3>Short URLs:</h3>
    <ul>
        <li><a href="/s/g00gl3">/s/g00gl3</a> - Google</li>
        <li><a href="/s/gh">/s/gh</a> - GitHub</li>
        <li><a href="/s/wiki">/s/wiki</a> - Wikipedia</li>
    </ul>
</body>
</html>
"""

@app.route('/')
def home():
    return render_template_string(HOME_PAGE)

# VULNERABLE: Direct redirect without validation
@app.route('/redirect')
def direct_redirect():
    url = request.args.get('url', '/')
    return redirect(url)

# VULNERABLE: Goto redirect without validation
@app.route('/goto')
def goto_redirect():
    next_url = request.args.get('next', '/')
    return redirect(next_url)

# VULNERABLE: Login return_to redirect
@app.route('/login', methods=['GET', 'POST'])
def login_redirect():
    return_to = request.args.get('return_to', '/')
    # Simulated login - just redirect
    return redirect(return_to)

# VULNERABLE: URL shortener with fallback parameter
@app.route('/s/<short_code>')
def url_shortener(short_code):
    if short_code in url_shortener_db:
        return redirect(url_shortener_db[short_code])
    else:
        # Fallback to custom URL parameter - VULNERABLE
        fallback = request.args.get('fallback', '/')
        return redirect(fallback)

# SECURE: Validates domain against allowlist
@app.route('/safe_redirect')
def safe_redirect():
    url = request.args.get('url', '/')
    allowed_domains = ['example.com', 'localhost', '127.0.0.1']
    
    try:
        parsed = urlparse(url)
        if parsed.netloc and parsed.netloc not in allowed_domains:
            return "Redirect blocked: Domain not allowed", 403
    except:
        return "Invalid URL", 400
    
    return redirect(url)

# SECURE: Only allows relative paths
@app.route('/navigate')
def navigate():
    target = request.args.get('target', '/home')
    
    # Only allow relative paths (no absolute URLs)
    if target.startswith('http://') or target.startswith('https://') or target.startswith('//'):
        return "Redirect blocked: Only relative paths allowed", 403
    
    return redirect(target)

# Simple internal page for testing
@app.route('/home')
def internal_home():
    return "<h1>Internal Home Page</h1><a href='/'>Back</a>"

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)