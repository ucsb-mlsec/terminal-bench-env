#include <stdio.h>
#include <stdarg.h>
#include <string.h>
#include <stdlib.h>

#define MAX_QUERY_LEN 1024
#define MAX_CONN_STR 256
#define MAX_RESULT_LEN 512

typedef struct {
    int connected;
    char host[64];
    int port;
    char username[32];
} DBConnection;

static DBConnection global_conn = {0};

/* Forward declarations */
void db_error(const char *error_msg, ...);
int db_connect(const char *host, int port, const char *username, const char *password);
int db_query(const char *query, char *result, size_t result_size);
void format_result(const char *raw_data);
void log_query(const char *query);
void db_disconnect(void);

/**
 * Initialize database connection
 */
int db_connect(const char *host, int port, const char *username, const char *password) {
    if (global_conn.connected) {
        fprintf(stderr, "Already connected to database\n");
        return -1;
    }
    
    if (!host || !username || !password) {
        fprintf(stderr, "Invalid connection parameters\n");
        return -1;
    }
    
    strncpy(global_conn.host, host, sizeof(global_conn.host) - 1);
    global_conn.port = port;
    strncpy(global_conn.username, username, sizeof(global_conn.username) - 1);
    
    printf("Connecting to %s:%d as %s\n", host, port, username);
    
    /* Simulate connection logic */
    if (port < 1 || port > 65535) {
        db_error("Invalid port number specified by user");
        return -1;
    }
    
    global_conn.connected = 1;
    printf("Database connection established successfully\n");
    return 0;
}

/**
 * Disconnect from database
 */
void db_disconnect(void) {
    if (!global_conn.connected) {
        fprintf(stderr, "Not connected to database\n");
        return;
    }
    
    printf("Disconnecting from %s:%d\n", global_conn.host, global_conn.port);
    global_conn.connected = 0;
    memset(&global_conn, 0, sizeof(DBConnection));
}

/**
 * Execute database query
 */
int db_query(const char *query, char *result, size_t result_size) {
    if (!global_conn.connected) {
        fprintf(stderr, "Not connected to database\n");
        return -1;
    }
    
    if (!query || strlen(query) == 0) {
        fprintf(stderr, "Empty query provided\n");
        return -1;
    }
    
    log_query(query);
    
    /* Simulate query execution */
    if (strncmp(query, "SELECT", 6) == 0) {
        snprintf(result, result_size, "user_id=1001|status=active|role=admin");
        return 0;
    } else if (strncmp(query, "INSERT", 6) == 0) {
        snprintf(result, result_size, "rows_affected=1");
        return 0;
    } else if (strncmp(query, "UPDATE", 6) == 0) {
        snprintf(result, result_size, "rows_affected=3");
        return 0;
    } else {
        db_error("Unsupported query type");
        return -1;
    }
}

/**
 * CRITICAL VULNERABILITY - Line 102
 * Error handler that uses user-controlled format string
 */
void db_error(const char *error_msg, ...) {
    char buffer[512];
    va_list args;
    
    fprintf(stderr, "[DATABASE ERROR] ");
    
    /* VULNERABLE: error_msg comes from user input and is used as format string */
    va_start(args, error_msg);
    vprintf(error_msg, args);
    va_end(args);
    
    fprintf(stderr, "\n");
}

/**
 * Log query for audit purposes
 */
void log_query(const char *query) {
    FILE *log_file;
    
    if (!query) return;
    
    log_file = fopen("/var/log/db_queries.log", "a");
    if (log_file) {
        fprintf(log_file, "[QUERY] %s\n", query);
        fclose(log_file);
    }
}

/**
 * Format and display query results
 * MEDIUM VULNERABILITY - Line 145
 */
void format_result(const char *raw_data) {
    char formatted[MAX_RESULT_LEN];
    char display_buffer[MAX_RESULT_LEN * 2];
    
    if (!raw_data) {
        fprintf(stderr, "No data to format\n");
        return;
    }
    
    /* Parse raw data - simulate processing */
    strncpy(formatted, raw_data, sizeof(formatted) - 1);
    formatted[sizeof(formatted) - 1] = '\0';
    
    /* VULNERABLE: formatted string (derived from query results) used as format string */
    sprintf(display_buffer, formatted);
    
    printf("Formatted result: %s\n", display_buffer);
}

/**
 * Helper function to validate query syntax
 */
int validate_query(const char *query) {
    const char *dangerous_keywords[] = {"DROP", "DELETE", "TRUNCATE", NULL};
    int i;
    
    if (!query) return 0;
    
    for (i = 0; dangerous_keywords[i] != NULL; i++) {
        if (strstr(query, dangerous_keywords[i]) != NULL) {
            fprintf(stderr, "Dangerous keyword detected: %s\n", dangerous_keywords[i]);
            return 0;
        }
    }
    
    return 1;
}

/**
 * Main function for testing
 */
int main(int argc, char *argv[]) {
    char result[MAX_RESULT_LEN];
    char query[MAX_QUERY_LEN];
    
    printf("Database Interface v1.2\n");
    printf("=======================\n\n");
    
    /* Connect to database */
    if (db_connect("localhost", 5432, "appuser", "password123") != 0) {
        fprintf(stderr, "Failed to connect to database\n");
        return 1;
    }
    
    /* Execute sample query */
    snprintf(query, sizeof(query), "SELECT * FROM users WHERE id=1001");
    
    if (db_query(query, result, sizeof(result)) == 0) {
        printf("Query executed successfully\n");
        format_result(result);
    }
    
    /* Disconnect */
    db_disconnect();
    
    return 0;
}