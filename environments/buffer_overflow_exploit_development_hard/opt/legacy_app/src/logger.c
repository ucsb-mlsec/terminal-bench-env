#include <stdio.h>
#include <stdarg.h>
#include <time.h>
#include <string.h>
#include <stdlib.h>

#define MAX_LOG_SIZE 512
#define LOG_FILE_PATH "/var/log/legacy_app.log"

static FILE *logfile = NULL;

// Initialize logging system
int init_logger(const char *log_path) {
    if (logfile != NULL) {
        fclose(logfile);
    }
    
    logfile = fopen(log_path ? log_path : LOG_FILE_PATH, "a");
    if (logfile == NULL) {
        fprintf(stderr, "Failed to open log file\n");
        return -1;
    }
    
    return 0;
}

// Close logging system
void close_logger() {
    if (logfile != NULL) {
        fclose(logfile);
        logfile = NULL;
    }
}

// Get current timestamp string
static char* get_timestamp() {
    static char timestamp[64];
    time_t now = time(NULL);
    struct tm *tm_info = localtime(&now);
    
    strftime(timestamp, sizeof(timestamp), "%Y-%m-%d %H:%M:%S", tm_info);
    return timestamp;
}

// Safe logging function with proper format string
void log_message_safe(const char *level, const char *format, ...) {
    if (logfile == NULL) {
        init_logger(NULL);
    }
    
    fprintf(logfile, "[%s] [%s] ", get_timestamp(), level);
    
    va_list args;
    va_start(args, format);
    vfprintf(logfile, format, args);
    va_end(args);
    
    fprintf(logfile, "\n");
    fflush(logfile);
}

// Write a simple log entry - safe version
void write_log_entry(const char *message) {
    if (logfile == NULL) {
        init_logger(NULL);
    }
    
    if (message != NULL && strlen(message) > 0) {
        fprintf(logfile, "[%s] %s\n", get_timestamp(), message);
        fflush(logfile);
    }
}

// Debug logging function - safe
void log_debug(const char *component, const char *format, ...) {
    if (logfile == NULL) {
        init_logger(NULL);
    }
    
    fprintf(logfile, "[%s] [DEBUG] [%s] ", get_timestamp(), component);
    
    va_list args;
    va_start(args, format);
    vfprintf(logfile, format, args);
    va_end(args);
    
    fprintf(logfile, "\n");
    fflush(logfile);
}

// Log informational messages
void log_info(const char *format, ...) {
    if (logfile == NULL) {
        init_logger(NULL);
    }
    
    fprintf(logfile, "[%s] [INFO] ", get_timestamp());
    
    va_list args;
    va_start(args, format);
    vfprintf(logfile, format, args);
    va_end(args);
    
    fprintf(logfile, "\n");
    fflush(logfile);
}

// Log error with user message - VULNERABLE
// This function performs partial validation (length check and NULL check)
// but still passes user-controlled input directly as format string
void log_error(const char *user_message) {
    if (logfile == NULL) {
        init_logger(NULL);
    }
    
    // Partial validation - checks if message exists and length
    if (user_message == NULL) {
        fprintf(logfile, "[%s] [ERROR] NULL error message\n", get_timestamp());
        fflush(logfile);
        return;
    }
    
    // Length check - but doesn't prevent format string attacks
    if (strlen(user_message) > MAX_LOG_SIZE) {
        fprintf(logfile, "[%s] [ERROR] Message too long\n", get_timestamp());
        fflush(logfile);
        return;
    }
    
    // VULNERABILITY: user_message is used directly as format string
    fprintf(logfile, "[%s] [ERROR] ", get_timestamp());
    fprintf(logfile, user_message);  // LINE 123 - HIGH SEVERITY
    fprintf(logfile, "\n");
    fflush(logfile);
}

// Log warning messages - safe version
void log_warning(const char *format, ...) {
    if (logfile == NULL) {
        init_logger(NULL);
    }
    
    fprintf(logfile, "[%s] [WARNING] ", get_timestamp());
    
    va_list args;
    va_start(args, format);
    vfprintf(logfile, format, args);
    va_end(args);
    
    fprintf(logfile, "\n");
    fflush(logfile);
}

// Log critical system events
void log_critical(const char *format, ...) {
    if (logfile == NULL) {
        init_logger(NULL);
    }
    
    fprintf(logfile, "[%s] [CRITICAL] ", get_timestamp());
    
    va_list args;
    va_start(args, format);
    vfprintf(logfile, format, args);
    va_end(args);
    
    fprintf(logfile, "\n");
    fflush(logfile);
    
    // Also log to stderr for critical messages
    fprintf(stderr, "[CRITICAL] ");
    va_start(args, format);
    vfprintf(stderr, format, args);
    va_end(args);
    fprintf(stderr, "\n");
}