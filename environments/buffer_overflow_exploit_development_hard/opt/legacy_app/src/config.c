#include <stdio.h>
#include <string.h>
#include <ctype.h>
#include <stdlib.h>

#define MAX_LINE 256
#define MAX_KEY 64
#define MAX_VALUE 128

typedef struct {
    char key[MAX_KEY];
    char value[MAX_VALUE];
} ConfigEntry;

// Function to sanitize input by removing special characters
void sanitize_value(char *input, char *output, size_t max_len) {
    size_t j = 0;
    for (size_t i = 0; i < strlen(input) && j < max_len - 1; i++) {
        // Only allow alphanumeric, spaces, dots, hyphens, and underscores
        if (isalnum(input[i]) || input[i] == ' ' || 
            input[i] == '.' || input[i] == '-' || input[i] == '_') {
            output[j++] = input[i];
        }
    }
    output[j] = '\0';
}

// Function to validate key names (whitelist approach)
int is_valid_key(const char *key) {
    const char *valid_keys[] = {
        "hostname", "port", "timeout", "max_connections",
        "log_level", "data_dir", "cache_size", NULL
    };
    
    for (int i = 0; valid_keys[i] != NULL; i++) {
        if (strcmp(key, valid_keys[i]) == 0) {
            return 1;
        }
    }
    return 0;
}

// Function to read and parse a configuration setting
int read_setting(const char *line, ConfigEntry *entry) {
    char key[MAX_KEY];
    char value[MAX_VALUE];
    
    if (sscanf(line, "%63[^=]=%127[^\n]", key, value) == 2) {
        // Trim whitespace from key
        char *end = key + strlen(key) - 1;
        while (end > key && isspace(*end)) end--;
        *(end + 1) = '\0';
        
        strncpy(entry->key, key, MAX_KEY - 1);
        strncpy(entry->value, value, MAX_VALUE - 1);
        entry->key[MAX_KEY - 1] = '\0';
        entry->value[MAX_VALUE - 1] = '\0';
        return 1;
    }
    return 0;
}

// LOW severity: Proper sanitization before printf usage
void apply_config(ConfigEntry *entry) {
    char sanitized[MAX_VALUE];
    
    // Sanitize the value before using it
    sanitize_value(entry->value, sanitized, MAX_VALUE);
    
    // Safe usage with proper format string
    printf("%s", sanitized);
    printf(" applied successfully\n");
}

// Function to parse configuration file
int parse_config(const char *filename) {
    FILE *fp = fopen(filename, "r");
    if (!fp) {
        fprintf(stderr, "Error: Cannot open config file: %s\n", filename);
        return -1;
    }
    
    char line[MAX_LINE];
    int line_num = 0;
    int valid_entries = 0;
    
    while (fgets(line, sizeof(line), fp)) {
        line_num++;
        
        // Skip comments and empty lines
        if (line[0] == '#' || line[0] == '\n') {
            continue;
        }
        
        ConfigEntry entry;
        if (read_setting(line, &entry)) {
            if (is_valid_key(entry.key)) {
                printf("Loading configuration: %s = ", entry.key);
                apply_config(&entry);
                valid_entries++;
            } else {
                fprintf(stderr, "Warning: Unknown config key '%s' at line %d\n", 
                       entry.key, line_num);
            }
        }
    }
    
    fclose(fp);
    return valid_entries;
}