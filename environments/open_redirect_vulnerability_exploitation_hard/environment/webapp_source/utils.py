#!/usr/bin/env python3
"""
Utility functions for URL validation and processing in the Flask application.
This module provides security functions to validate and sanitize redirect URLs.
"""

import re
import urllib.parse

# Domain whitelist for allowed redirect destinations
ALLOWED_DOMAINS = ['localhost', 'example.com', '127.0.0.1']


def is_safe_url(url):
    """
    Check if a URL is safe for redirection.
    
    Args:
        url (str): The URL to validate
        
    Returns:
        bool: True if the URL is considered safe, False otherwise
    """
    if not url:
        return False
    
    # Allow relative URLs starting with /
    if url.startswith('/'):
        return True
    
    # Check if any allowed domain appears in the URL
    for domain in ALLOWED_DOMAINS:
        if domain in url:
            return True
    
    return False


def validate_redirect_url(target):
    """
    Validate redirect URL using regex pattern matching.
    
    Args:
        target (str): The target URL to validate
        
    Returns:
        bool: True if URL matches safe patterns, False otherwise
    """
    if not target:
        return False
    
    # Pattern to match relative URLs or URLs starting with allowed domains
    # This regex attempts to match safe URLs but has flaws
    pattern = r'^(/|https?://(?:localhost|example\.com|127\.0\.0\.1))'
    
    if re.match(pattern, target):
        return True
    
    return False


def sanitize_url(url):
    """
    Sanitize URL by removing potentially dangerous characters.
    
    Args:
        url (str): The URL to sanitize
        
    Returns:
        str: Sanitized URL
    """
    if not url:
        return ''
    
    # Remove whitespace and newlines
    sanitized = url.strip()
    sanitized = sanitized.replace('\n', '').replace('\r', '')
    
    # Remove null bytes
    sanitized = sanitized.replace('\x00', '')
    
    return sanitized


def check_domain_whitelist(url, whitelist=None):
    """
    Validate URL against a domain whitelist.
    
    Args:
        url (str): The URL to check
        whitelist (list): List of allowed domains (defaults to ALLOWED_DOMAINS)
        
    Returns:
        bool: True if domain is in whitelist, False otherwise
    """
    if whitelist is None:
        whitelist = ALLOWED_DOMAINS
    
    try:
        parsed = urllib.parse.urlparse(url)
        domain = parsed.netloc
        
        # Check if domain is in whitelist
        if domain in whitelist:
            return True
        
        # Also check hostname without port
        hostname = domain.split(':')[0]
        if hostname in whitelist:
            return True
            
    except Exception:
        return False
    
    return False


def url_encode(url):
    """
    URL encode a string.
    
    Args:
        url (str): String to encode
        
    Returns:
        str: URL encoded string
    """
    return urllib.parse.quote(url, safe='')


def url_decode(url):
    """
    URL decode a string.
    
    Args:
        url (str): String to decode
        
    Returns:
        str: URL decoded string
    """
    return urllib.parse.unquote(url)


def normalize_url(url):
    """
    Normalize URL by parsing and reconstructing it.
    
    Args:
        url (str): URL to normalize
        
    Returns:
        str: Normalized URL
    """
    try:
        parsed = urllib.parse.urlparse(url)
        return urllib.parse.urlunparse(parsed)
    except Exception:
        return url


def extract_redirect_path(url):
    """
    Extract the path component from a URL for redirect validation.
    
    Args:
        url (str): URL to extract path from
        
    Returns:
        str: Path component of the URL
    """
    try:
        parsed = urllib.parse.urlparse(url)
        return parsed.path
    except Exception:
        return ''