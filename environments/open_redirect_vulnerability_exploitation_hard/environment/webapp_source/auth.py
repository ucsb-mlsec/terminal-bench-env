#!/usr/bin/env python3
"""
Authentication module for web application
Handles user login, logout, and session management
"""

from flask import redirect, request, session, url_for
from functools import wraps
from urllib.parse import urlparse, urljoin

# Mock user database
USERS = {
    'admin': 'password123',
    'user': 'userpass'
}


def login_required(f):
    """
    Decorator to require login for protected routes.
    Redirects to login page if user is not authenticated.
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'username' not in session:
            # Store the originally requested URL to redirect back after login
            next_url = request.url
            return redirect(url_for('login', next=next_url))
        return f(*args, **kwargs)
    return decorated_function


def is_safe_url(target):
    """
    Validate if a URL is safe for redirect.
    Checks if the URL is relative to prevent open redirects.
    
    NOTE: This validation has flaws - it only checks if URL starts with '/'
    but doesn't handle protocol-relative URLs like '//malicious.com'
    """
    if not target:
        return False
    
    # Simple check - only allow URLs starting with '/'
    # VULNERABILITY: This doesn't catch protocol-relative URLs
    if target.startswith('/'):
        return True
    
    return False


def validate_redirect_url(url):
    """
    Additional URL validation function.
    Attempts to verify the URL is safe but has bypass vulnerabilities.
    """
    if not url:
        return False
    
    # Check if URL starts with http:// or https://
    # If it does, consider it external and reject it
    if url.startswith('http://') or url.startswith('https://'):
        return False
    
    # VULNERABILITY: Doesn't check for protocol-relative URLs starting with '//'
    # Also doesn't check for other protocols or encoding tricks
    return True


def get_redirect_target():
    """
    Extract redirect target from request parameters or referrer.
    Uses 'next', 'redirect', or 'url' parameters, or falls back to referrer.
    
    Returns the target URL without proper validation.
    """
    # Check common parameter names for redirect targets
    for target in ['next', 'redirect', 'url', 'return_to']:
        if target in request.args:
            return request.args.get(target)
    
    # Fall back to referrer if no explicit redirect parameter
    if request.referrer:
        return request.referrer
    
    return None


def redirect_back(default='index'):
    """
    Redirect back to the previous page or a default location.
    Attempts to use safe validation but can be bypassed.
    """
    target = get_redirect_target()
    
    if target and is_safe_url(target):
        return redirect(target)
    
    # Default redirect if no safe target found
    return redirect(url_for(default))


def process_login(username, password, next_url=None):
    """
    Process user login with credentials.
    Validates username and password, then redirects to next_url.
    
    Args:
        username: User's username
        password: User's password
        next_url: URL to redirect to after successful login
        
    Returns:
        Redirect response or None if validation fails
    """
    # Validate credentials against mock database
    if username in USERS and USERS[username] == password:
        session['username'] = username
        session['authenticated'] = True
        
        # Redirect to next_url if provided and "validated"
        if next_url and validate_redirect_url(next_url):
            # VULNERABILITY: validate_redirect_url can be bypassed with '//'
            return redirect(next_url)
        
        # Default redirect to dashboard
        return redirect(url_for('dashboard'))
    
    return None


def handle_logout(redirect_url=None):
    """
    Handle user logout and redirect.
    Clears session and redirects to specified URL.
    
    Args:
        redirect_url: Optional URL to redirect to after logout
        
    Returns:
        Redirect response
    
    VULNERABILITY: This function accepts redirect_url without ANY validation
    and directly redirects to it, making it highly exploitable.
    """
    # Clear user session
    session.pop('username', None)
    session.pop('authenticated', None)
    
    # Redirect to specified URL or default to home
    if redirect_url:
        # CRITICAL VULNERABILITY: No validation on redirect_url at all!
        return redirect(redirect_url)
    
    return redirect(url_for('index'))


def check_authentication():
    """
    Check if current user is authenticated.
    Returns True if user has valid session, False otherwise.
    """
    return session.get('authenticated', False) and 'username' in session


def get_current_user():
    """
    Get the currently authenticated username.
    Returns username from session or None if not authenticated.
    """
    if check_authentication():
        return session.get('username')
    return None