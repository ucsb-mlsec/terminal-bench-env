global
    log /dev/log local0
    log /dev/log local1 notice
    maxconn 4096
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

# Frontend configuration for HTTP traffic
frontend http_front
    bind *:80
    default_backend web_servers
    
    # Enable HTTP server close mode - closes connection after each request/response
    option http-server-close
    
    # Standard logging
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    
    # Accept both HTTP/1.0 and HTTP/1.1
    option accept-invalid-http-request
    
    # NOTE: Missing 'option http-buffer-request' which would buffer and validate
    # the entire request before forwarding. Without this, HAProxy may forward
    # requests incrementally, leading to desynchronization issues.
    
    # NOTE: Not explicitly rejecting requests with both Transfer-Encoding and
    # Content-Length headers, which can cause CL-TE desynchronization

# Backend configuration for web servers
backend web_servers
    balance roundrobin
    
    # Keep-alive connections to backend - reuses connections
    option http-keep-alive
    
    # Backend may interpret request boundaries differently than frontend
    # when both Transfer-Encoding and Content-Length are present
    
    # Server definitions
    server server1 192.168.1.10:8080 check
    server server2 192.168.1.11:8080 check
    server server3 192.168.1.12:8080 check
    
    # Standard health check settings
    option httpchk GET /health
    http-check expect status 200