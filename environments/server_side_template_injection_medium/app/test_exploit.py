#!/usr/bin/env python3

import requests
import json
import sys
import time

BASE_URL = 'http://localhost:5000'

def test_config_access():
    """Test 1: Attempt to access Flask config object"""
    print("\n[TEST 1] Testing config access via {{config}}...")
    payload = {
        'template': '{{config}}',
        'username': 'testuser',
        'email': 'test@example.com',
        'timestamp': '2024-01-01'
    }
    try:
        response = requests.post(f'{BASE_URL}/render', json=payload, timeout=5)
        if 'SECRET' in response.text or 'Config' in response.text or 'class' in response.text:
            print('[FAIL] Config access not blocked - SSTI vulnerability exists!')
            return False
        print('[PASS] Config access blocked')
        return True
    except Exception as e:
        print(f'[ERROR] Request failed: {e}')
        return False

def test_class_mro_access():
    """Test 2: Attempt to access Python classes via MRO"""
    print("\n[TEST 2] Testing class.__mro__ access...")
    payload = {
        'template': "{{''.__class__.__mro__}}",
        'username': 'testuser',
        'email': 'test@example.com',
        'timestamp': '2024-01-01'
    }
    try:
        response = requests.post(f'{BASE_URL}/render', json=payload, timeout=5)
        if 'object' in response.text or 'class' in response.text or 'type' in response.text:
            print('[FAIL] Class MRO access not blocked - SSTI vulnerability exists!')
            return False
        print('[PASS] Class MRO access blocked')
        return True
    except Exception as e:
        print(f'[ERROR] Request failed: {e}')
        return False

def test_subclasses_access():
    """Test 3: Attempt to access subclasses for file reading"""
    print("\n[TEST 3] Testing subclasses access for exploitation...")
    payload = {
        'template': "{{''.__class__.__mro__[1].__subclasses__()}}",
        'username': 'testuser',
        'email': 'test@example.com',
        'timestamp': '2024-01-01'
    }
    try:
        response = requests.post(f'{BASE_URL}/render', json=payload, timeout=5)
        if 'subprocess' in response.text.lower() or 'wrapper' in response.text or len(response.text) > 500:
            print('[FAIL] Subclasses access not blocked - SSTI vulnerability exists!')
            return False
        print('[PASS] Subclasses access blocked')
        return True
    except Exception as e:
        print(f'[ERROR] Request failed: {e}')
        return False

def test_builtins_access():
    """Test 4: Attempt to access __builtins__ and __globals__"""
    print("\n[TEST 4] Testing __builtins__ access...")
    payload = {
        'template': "{{[].__class__.__base__.__subclasses__()[104].__init__.__globals__['sys']}}",
        'username': 'testuser',
        'email': 'test@example.com',
        'timestamp': '2024-01-01'
    }
    try:
        response = requests.post(f'{BASE_URL}/render', json=payload, timeout=5)
        if 'module' in response.text or 'builtin' in response.text or 'sys' in response.text:
            print('[FAIL] Builtins access not blocked - SSTI vulnerability exists!')
            return False
        print('[PASS] Builtins access blocked')
        return True
    except Exception as e:
        print(f'[ERROR] Request failed: {e}')
        return False

def test_command_execution():
    """Test 5: Attempt command execution via template injection"""
    print("\n[TEST 5] Testing command execution attempt...")
    payload = {
        'template': "{{config.__class__.__init__.__globals__['os'].popen('whoami').read()}}",
        'username': 'testuser',
        'email': 'test@example.com',
        'timestamp': '2024-01-01'
    }
    try:
        response = requests.post(f'{BASE_URL}/render', json=payload, timeout=5)
        if 'root' in response.text or 'ubuntu' in response.text or 'app' in response.text:
            print('[FAIL] Command execution not blocked - SSTI vulnerability exists!')
            return False
        print('[PASS] Command execution blocked')
        return True
    except Exception as e:
        print(f'[ERROR] Request failed: {e}')
        return False

def test_legitimate_template():
    """Test 6: Verify legitimate template rendering still works"""
    print("\n[TEST 6] Testing legitimate template rendering...")
    payload = {
        'template': 'Hello {{username}}, your email is {{email}} at {{timestamp}}',
        'username': 'JohnDoe',
        'email': 'john@example.com',
        'timestamp': '2024-01-15 10:30:00'
    }
    try:
        response = requests.post(f'{BASE_URL}/render', json=payload, timeout=5)
        if 'JohnDoe' in response.text and 'john@example.com' in response.text and '2024-01-15' in response.text:
            print('[PASS] Legitimate template rendering works correctly')
            return True
        print('[FAIL] Legitimate template rendering broken!')
        return False
    except Exception as e:
        print(f'[ERROR] Request failed: {e}')
        return False

def test_attr_access():
    """Test 7: Attempt to use attr filter for exploitation"""
    print("\n[TEST 7] Testing attr filter exploitation...")
    payload = {
        'template': "{{request.application.__globals__.__builtins__.__import__('os').popen('id').read()}}",
        'username': 'testuser',
        'email': 'test@example.com',
        'timestamp': '2024-01-01'
    }
    try:
        response = requests.post(f'{BASE_URL}/render', json=payload, timeout=5)
        if 'uid=' in response.text or 'gid=' in response.text:
            print('[FAIL] Attr filter exploitation not blocked - SSTI vulnerability exists!')
            return False
        print('[PASS] Attr filter exploitation blocked')
        return True
    except Exception as e:
        print(f'[ERROR] Request failed: {e}')
        return False

def test_cycler_exploitation():
    """Test 8: Attempt cycler object exploitation"""
    print("\n[TEST 8] Testing cycler exploitation...")
    payload = {
        'template': "{{cycler.__init__.__globals__.os.popen('ls').read()}}",
        'username': 'testuser',
        'email': 'test@example.com',
        'timestamp': '2024-01-01'
    }
    try:
        response = requests.post(f'{BASE_URL}/render', json=payload, timeout=5)
        if 'app' in response.text or 'tmp' in response.text or 'etc' in response.text:
            print('[FAIL] Cycler exploitation not blocked - SSTI vulnerability exists!')
            return False
        print('[PASS] Cycler exploitation blocked')
        return True
    except Exception as e:
        print(f'[ERROR] Request failed: {e}')
        return False

def main():
    print("="*60)
    print("SSTI Vulnerability Test Suite")
    print("="*60)
    
    # Wait for server to be ready
    print("\nWaiting for server to be ready...")
    for i in range(10):
        try:
            requests.get(BASE_URL, timeout=2)
            print("Server is ready!")
            break
        except:
            time.sleep(1)
    else:
        print("[ERROR] Server not responding. Please ensure Flask app is running.")
        sys.exit(1)
    
    tests = [
        test_config_access,
        test_class_mro_access,
        test_subclasses_access,
        test_builtins_access,
        test_command_execution,
        test_legitimate_template,
        test_attr_access,
        test_cycler_exploitation
    ]
    
    results = []
    for test in tests:
        results.append(test())
    
    print("\n" + "="*60)
    print("TEST SUMMARY")
    print("="*60)
    
    passed = sum(results)
    total = len(results)
    
    print(f"\nTotal Tests: {total}")
    print(f"Passed: {passed}")
    print(f"Failed: {total - passed}")
    
    # Check if legitimate template test passed and all exploit tests passed
    if results[5]:  # Legitimate template test
        print("\n✓ Legitimate template rendering works")
    else:
        print("\n✗ Legitimate template rendering is broken")
    
    exploit_tests_passed = sum(results[:5]) + sum(results[6:])
    exploit_tests_total = len(results) - 1
    
    if exploit_tests_passed == exploit_tests_total:
        print("✓ All exploit attempts blocked")
    else:
        print("✗ Some exploit attempts not blocked - SECURITY VULNERABILITY!")
    
    if all(results):
        print("\n[SUCCESS] All tests passed! Application is secure and functional.")
        sys.exit(0)
    else:
        print("\n[FAILURE] Some tests failed. Please review the results above.")
        sys.exit(1)

if __name__ == '__main__':
    main()