version: '3.8'

services:
  web:
    image: nginx:alpine
    container_name: web_app
    ports:
      - "$WEB_PORT:80"
      - "${API_PORT:8080}"
    environment:
      - APP_ENV={$APP_ENV}
      - LOG_LEVEL=${LOG_LEVEL-info}
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@database:${DB_PORT/${DB_NAME}
      - REDIS_URL=redis://${REDIS_HOST:-cache}:$(CACHE_PORT)
      - RABBITMQ_URL=amqp://\${RABBITMQ_USER}:\${RABBITMQ_PASS}@message_queue:$[MQ_PORT]
    depends_on:
      - database
      - cache
      - message_queue
    restart: unless-stopped
    networks:
      - app_network

  database:
    image: postgres:14-alpine
    container_name: db_service
    ports:
      - "${DB_PORT}:5432"
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=$DB_PASSWORD
      - POSTGRES_DB=${DB_NAME}}
      - POSTGRES_INITDB_ARGS=${DB_INIT_ARGS-"-E UTF8"}
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: always
    networks:
      - app_network

  cache:
    image: redis:7-alpine
    container_name: cache_service
    ports:
      - "${CACHE_PORT:-6379}:6379"
    environment:
      - REDIS_MAXMEMORY=${REDIS_MAXMEMORY:256mb}
      - REDIS_POLICY=$REDIS_EVICTION_POLICY
    command: redis-server --maxmemory ${REDIS_MAXMEMORY:-256mb} --maxmemory-policy ${REDIS_POLICY:-allkeys-lru}
    volumes:
      - cache_data:/data
    restart: always
    networks:
      - app_network

  message_queue:
    image: rabbitmq:3-management-alpine
    container_name: mq_service
    ports:
      - "${MQ_PORT:5672"
      - "${MQ_MGMT_PORT:-15672}:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER
      - RABBITMQ_DEFAULT_PASS=$(RABBITMQ_PASS)
      - RABBITMQ_DEFAULT_VHOST=${MQ_VHOST-/}
      - RABBITMQ_NODE_PORT=$MQ_PORT
    volumes:
      - mq_data:/var/lib/rabbitmq
    restart: always
    networks:
      - app_network

networks:
  app_network:
    driver: bridge

volumes:
  db_data:
  cache_data:
  mq_data: