import h5py
import numpy as np
import csv
import os

# Create the data directory if it doesn't exist
os.makedirs('/data', exist_ok=True)

# Create the HDF5 file with experimental data
with h5py.File('/data/experiments.h5', 'w') as f:
    # Experiment 001
    exp1 = f.create_group('experiment_001')
    
    temp1 = exp1.create_group('temperature')
    temp_data1 = temp1.create_dataset('readings', data=np.array([23.5, 23.7, 23.9, 24.1, 24.3, 24.0, 23.8]))
    temp_data1.attrs['units'] = 'celsius'
    temp_data1.attrs['sensor_id'] = 'TEMP-001'
    temp_data1.attrs['calibration_date'] = '2024-01-15'
    
    press1 = exp1.create_group('pressure')
    press_data1 = press1.create_dataset('readings', data=np.array([101.3, 101.5, 101.4, 101.6, 101.5]))
    press_data1.attrs['units'] = 'kPa'
    press_data1.attrs['sensor_id'] = 'PRESS-001'
    
    humid1 = exp1.create_group('humidity')
    humid_data1 = humid1.create_dataset('readings', data=np.array([45.2, 46.1, 45.8, 46.5, 46.0, 45.5]))
    humid_data1.attrs['units'] = 'percent'
    humid_data1.attrs['sensor_id'] = 'HUM-001'
    
    # Experiment 002
    exp2 = f.create_group('experiment_002')
    
    temp2 = exp2.create_group('temperature')
    temp_data2 = temp2.create_dataset('measurements', data=np.array([24.1, 24.3, 24.5, 24.7, 24.4, 24.2, 24.6, 24.8]))
    temp_data2.attrs['units'] = 'celsius'
    temp_data2.attrs['sensor_id'] = 'TEMP-002'
    
    press2 = exp2.create_group('pressure')
    press_data2 = press2.create_dataset('values', data=np.array([102.1, 102.3, 102.2, 102.4, 102.5, 102.3]))
    press_data2.attrs['units'] = 'kPa'
    
    humid2 = exp2.create_group('humidity')
    humid_data2 = humid2.create_dataset('readings', data=np.array([50.5, 51.2, 50.8, 51.5, 51.0]))
    humid_data2.attrs['units'] = 'percent'
    
    light2 = exp2.create_group('light_intensity')
    light_data2 = light2.create_dataset('readings', data=np.array([320.5, 325.3, 318.9, 330.2, 315.7, 328.4]))
    light_data2.attrs['units'] = 'lux'
    light_data2.attrs['sensor_id'] = 'LIGHT-002'
    
    # Experiment 003
    exp3 = f.create_group('experiment_003')
    
    temp3 = exp3.create_group('temperature')
    temp_data3 = temp3.create_dataset('readings', data=np.array([22.8, 23.0, 23.2, 23.4, 23.1, 22.9]))
    temp_data3.attrs['units'] = 'celsius'
    temp_data3.attrs['sensor_id'] = 'TEMP-003'
    temp_data3.attrs['calibration_date'] = '2024-01-20'
    
    press3 = exp3.create_group('pressure')
    press_data3 = press3.create_dataset('measurements', data=np.array([100.8, 100.9, 101.0, 100.7, 100.9]))
    press_data3.attrs['units'] = 'kPa'
    press_data3.attrs['sensor_id'] = 'PRESS-003'
    
    light3 = exp3.create_group('light_intensity')
    light_data3 = light3.create_dataset('values', data=np.array([250.5, 255.3, 248.9, 260.1, 245.7, 258.3, 252.0]))
    light_data3.attrs['units'] = 'lux'
    light_data3.attrs['sensor_id'] = 'LIGHT-003'
    
    # Experiment 004
    exp4 = f.create_group('experiment_004')
    
    temp4 = exp4.create_group('temperature')
    temp_data4 = temp4.create_dataset('readings', data=np.array([25.2, 25.5, 25.8, 26.0, 25.7, 25.4]))
    temp_data4.attrs['units'] = 'celsius'
    
    humid4 = exp4.create_group('humidity')
    humid_data4 = humid4.create_dataset('measurements', data=np.array([60.3, 61.5, 60.8, 62.1, 61.0, 60.5, 61.8]))
    humid_data4.attrs['units'] = 'percent'
    humid_data4.attrs['sensor_id'] = 'HUM-004'
    
    light4 = exp4.create_group('light_intensity')
    light_data4 = light4.create_dataset('readings', data=np.array([450.2, 455.8, 448.3, 460.5, 452.7]))
    light_data4.attrs['units'] = 'lux'

# Now read the HDF5 file and convert to CSV
measurements = []

def visit_datasets(name, obj):
    if isinstance(obj, h5py.Dataset):
        # Extract the path components
        path_parts = name.split('/')
        if len(path_parts) >= 2:
            experiment_id = path_parts[0]
            sensor_type = path_parts[1]
            
            # Get the data
            data = obj[:]
            
            # Handle both scalar and array data
            if np.isscalar(data) or data.shape == ():
                measurements.append([experiment_id, sensor_type, float(data), 0])
            else:
                # Flatten if multidimensional and iterate
                flat_data = data.flatten()
                for idx, value in enumerate(flat_data):
                    measurements.append([experiment_id, sensor_type, float(value), idx])

# Open the HDF5 file and traverse it
with h5py.File('/data/experiments.h5', 'r') as f:
    f.visititems(visit_datasets)

# Create the solution directory if it doesn't exist
os.makedirs('/solution', exist_ok=True)

# Write to CSV
with open('/solution/measurements.csv', 'w', newline='') as csvfile:
    writer = csv.writer(csvfile)
    writer.writerow(['experiment_id', 'sensor_type', 'measurement_value', 'timestamp_index'])
    writer.writerows(measurements)

print(f"Successfully created CSV with {len(measurements)} measurements")