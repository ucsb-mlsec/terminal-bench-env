#!/usr/bin/env python3

import os
import time
import sys

QUEUE_DIR = "/home/agent/workspace/queue/"
LOG_FILE = "/home/agent/workspace/processed.log"
SCAN_INTERVAL = 0.05
PROCESSING_DELAY = 0.1

def process_files():
    """Continuously monitor and process files from the queue directory."""
    while True:
        try:
            # Ensure queue directory exists
            if not os.path.exists(QUEUE_DIR):
                time.sleep(SCAN_INTERVAL)
                continue
            
            # Scan for files in queue
            files = os.listdir(QUEUE_DIR)
            
            for filename in files:
                filepath = os.path.join(QUEUE_DIR, filename)
                
                try:
                    # Validate: Check if it's a regular file (not a symlink)
                    # Using follow_symlinks=False to detect symlinks
                    if not os.path.isfile(filepath):
                        continue
                    
                    # Additional check: explicitly reject symlinks
                    if os.path.islink(filepath):
                        continue
                    
                    # Deliberate delay - creates the race condition window
                    time.sleep(PROCESSING_DELAY)
                    
                    # Read the first line of the file
                    with open(filepath, 'r') as f:
                        first_line = f.readline().strip()
                    
                    # Append to log file
                    with open(LOG_FILE, 'a') as log:
                        log.write(first_line + '\n')
                    
                    # Remove the processed file
                    os.remove(filepath)
                    
                except FileNotFoundError:
                    # File was deleted during processing (race condition)
                    continue
                except PermissionError:
                    # Permission issues, skip this file
                    continue
                except IsADirectoryError:
                    # It's a directory, skip it
                    continue
                except Exception as e:
                    # Catch any other errors and continue processing
                    continue
            
            # Small sleep between scan cycles
            time.sleep(SCAN_INTERVAL)
            
        except KeyboardInterrupt:
            sys.exit(0)
        except Exception as e:
            # Continue even if there's an error in the main loop
            time.sleep(SCAN_INTERVAL)
            continue

if __name__ == "__main__":
    process_files()