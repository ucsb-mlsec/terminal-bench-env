---
- name: Deploy Production Environment
  hosts: all
  become: true
  
  vars_files:
    - vars/prod_db.yml
    - vars/api_keys.yml
    - group_vars/webservers/vault.yml
    - group_vars/databases/secrets.yml
    - host_vars/db01/secrets.yml
    - host_vars/web01/vault.yml
    - roles/common/vars/vault_secrets.yml
  
  tasks:
    - name: Configure database connection
      template:
        src: templates/database.conf.j2
        dest: /etc/app/database.conf
        mode: '0600'
      vars:
        db_host: "{{ vault_db_host }}"
        db_port: "{{ vault_db_port }}"
        db_name: "{{ vault_db_name }}"
        db_user: "{{ vault_db_user }}"
        db_password: "{{ vault_db_password }}"
      notify: restart application
    
    - name: Setup API credentials
      copy:
        content: |
          API_KEY={{ vault_api_key }}
          API_SECRET={{ vault_api_secret }}
          STRIPE_KEY={{ vault_stripe_api_key }}
          AWS_ACCESS_KEY={{ vault_aws_access_key }}
          AWS_SECRET_KEY={{ vault_aws_secret_key }}
        dest: /etc/app/api_credentials.env
        mode: '0400'
        owner: appuser
        group: appuser
      no_log: true
    
    - name: Deploy application secrets
      template:
        src: templates/secrets.yml.j2
        dest: /opt/application/config/secrets.yml
        mode: '0440'
        owner: appuser
        group: appuser
      vars:
        jwt_secret: "{{ vault_jwt_secret_key }}"
        session_secret: "{{ vault_session_secret }}"
        encryption_key: "{{ vault_encryption_key }}"
      notify: restart application
    
    - name: Configure service authentication
      lineinfile:
        path: /etc/app/services.conf
        regexp: "^{{ item.key }}="
        line: "{{ item.key }}={{ item.value }}"
        create: yes
        mode: '0600'
      loop:
        - { key: 'REDIS_PASSWORD', value: "{{ vault_redis_password }}" }
        - { key: 'RABBITMQ_PASSWORD', value: "{{ vault_rabbitmq_password }}" }
        - { key: 'ADMIN_PASSWORD', value: "{{ vault_admin_password }}" }
      no_log: true
  
  handlers:
    - name: restart application
      service:
        name: production-app
        state: restarted