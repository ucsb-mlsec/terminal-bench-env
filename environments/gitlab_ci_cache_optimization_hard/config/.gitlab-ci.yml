stages:
  - dependencies
  - build
  - test
  - integration-test
  - security-scan
  - deploy

variables:
  GIT_DEPTH: 1

# Frontend service jobs
frontend:dependencies:
  stage: dependencies
  script:
    - cd frontend
    - npm install
  cache:
    key: default-cache
    paths:
      - frontend/build/
  # Cache hit rate: 12% - using wrong cache key and wrong paths

frontend:build:
  stage: build
  script:
    - cd frontend
    - npm run build
  cache:
    key: $CI_COMMIT_REF_NAME
    paths:
      - frontend/node_modules/
    policy: pull-push
  # Cache hit rate: 25% - branch-only key causes misses on different branches

frontend:test:
  stage: test
  script:
    - cd frontend
    - npm test
  # No cache configuration - reinstalling dependencies every time

frontend:lint:
  stage: test
  script:
    - cd frontend
    - npm run lint
  cache:
    key: shared-cache
    paths:
      - node_modules/

# Backend API service jobs
backend-api:dependencies:
  stage: dependencies
  script:
    - cd backend-api
    - pip install -r requirements.txt
  cache:
    key: python-cache
    paths:
      - backend-api/venv/
  # Cache hit rate: 18% - not caching pip cache directory

backend-api:build:
  stage: build
  script:
    - cd backend-api
    - python setup.py build
  cache:
    key: $CI_COMMIT_REF_NAME
    paths:
      - backend-api/venv/
      - frontend/node_modules/
    policy: pull-push
  # Mixing cache paths from different services

backend-api:test:
  stage: test
  script:
    - cd backend-api
    - pytest
  cache:
    key: default-cache
    paths:
      - backend-api/build/

backend-api:integration:
  stage: integration-test
  script:
    - cd backend-api
    - pytest integration/
  # No cache at all - reinstalling dependencies

# Data processor service jobs
data-processor:dependencies:
  stage: dependencies
  script:
    - cd data-processor
    - cargo fetch
  cache:
    key: rust-cache
    paths:
      - data-processor/src/
  # Cache hit rate: 22% - caching source instead of dependencies

data-processor:build:
  stage: build
  script:
    - cd data-processor
    - cargo build --release
  cache:
    key: $CI_COMMIT_REF_NAME
    paths:
      - data-processor/target/
    policy: pull

data-processor:test:
  stage: test
  script:
    - cd data-processor
    - cargo test
  cache:
    key: shared-cache
    paths:
      - target/
      - node_modules/
  # Cache hit rate: 8% - wrong paths and mixed service caches

# ML service jobs
ml-service:dependencies:
  stage: dependencies
  script:
    - cd ml-service
    - gradle dependencies
  cache:
    key: gradle-cache
    paths:
      - ml-service/build/
  # Cache hit rate: 15% - not caching gradle wrapper or dependencies

ml-service:build:
  stage: build
  script:
    - cd ml-service
    - gradle build
  cache:
    key: $CI_COMMIT_REF_NAME
    paths:
      - ml-service/.gradle/
      - ml-service/build/
    policy: pull-push

ml-service:test:
  stage: test
  script:
    - cd ml-service
    - gradle test
  cache:
    key: default-cache
    paths:
      - build/

ml-service:integration:
  stage: integration-test
  script:
    - cd ml-service
    - gradle integrationTest
  # No cache configuration

# Security scanning jobs
security:frontend:
  stage: security-scan
  script:
    - cd frontend
    - npm audit
  cache:
    key: $CI_COMMIT_REF_NAME
    paths:
      - frontend/node_modules/
      - backend-api/venv/
  # Overlapping paths from different services

security:dependencies:
  stage: security-scan
  script:
    - trivy filesystem .
  cache:
    key: security-cache
    paths:
      - .trivy-cache/
    policy: pull-push

# Deploy jobs
deploy:staging:
  stage: deploy
  script:
    - echo "Deploying to staging"
    - ./deploy.sh staging
  cache:
    key: deploy-cache
    paths:
      - dist/
      - build/
  only:
    - develop

deploy:production:
  stage: deploy
  script:
    - echo "Deploying to production"
    - ./deploy.sh production
  # No cache configuration
  only:
    - main