stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DATABASE_HOST: prod-db.example.com
  API_ENDPOINT: https://api.example.com
  STRIPE_API_KEY: sk_live_51HxJ8kLmNoPqRsTu9vWxYzAbCdEfGhIjKlMnOpQrStUvWxYz
  AWS_ACCESS_KEY_ID: AKIAIOSFODNN7EXAMPLE
  AWS_SECRET_ACCESS_KEY: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
  AWS_DEFAULT_REGION: us-east-1

build_application:
  stage: build
  image: node:16-alpine
  script:
    - echo "Building application..."
    - npm install
    - echo "AWS Credentials - Access Key: $AWS_ACCESS_KEY_ID"
    - echo "AWS Secret: $AWS_SECRET_ACCESS_KEY"
    - npm run build
    - echo "Build completed successfully"
  artifacts:
    paths:
      - build/
      - .env.production
      - config/secrets.yml
    expire_in: 1 week
  only:
    - main
    - develop

run_tests:
  stage: test
  image: node:16-alpine
  script:
    - echo "Running test suite..."
    - npm test
    - echo "Database connection string: postgresql://admin:P@ssw0rd123!@prod-db.example.com:5432/maindb"
    - printenv | grep -i secret
    - npm run test:integration
  only:
    - main

deploy_staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl openssh-client
    - echo "Configuring deployment credentials..."
  script:
    - echo "Deploying to staging environment..."
    - export DB_PASSWORD="staging_db_pass_2024"
    - echo "Connecting to database with password: $DB_PASSWORD"
    - curl -X POST https://deploy.example.com/api/deploy -H "Authorization: Bearer ghp_xJ9k2mN5pQ8rS4tV7wY0zA3bC6dE1fG4hI"
    - ssh-keyscan staging.example.com >> ~/.ssh/known_hosts
    - echo "Deployment to staging complete"
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - develop

deploy_production:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Starting production deployment..."
    - apk add --no-cache postgresql-client aws-cli
    - export PROD_DB_PASS="Pr0d_S3cur3_P@ss_2024!"
    - echo "Production database password is $PROD_DB_PASS"
    - psql "postgresql://prod_user:$PROD_DB_PASS@prod-db.example.com:5432/production" -c "SELECT version();"
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws s3 sync ./build s3://production-bucket --delete
    - curl -H "X-API-Key: prod_api_key_8x9Y2mK4nL6pQ1rT3vW5zA7bC" https://api.example.com/deploy
    - echo "All environment variables:"
    - env
    - echo "Production deployment completed"
  artifacts:
    paths:
      - deployment-logs/
      - credentials.json
    expire_in: 30 days
  environment:
    name: production
    url: https://production.example.com
  only:
    - main
  when: manual

security_scan:
  stage: test
  image: python:3.9
  script:
    - echo "Running security scan..."
    - pip install safety bandit
    - echo "GitHub Token for scanning: ghp_9mK2nL5pQ8rS1tV4wY7zA0bC3dE6fG8hI"
    - export SONAR_TOKEN="sqp_1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r"
    - echo "SonarQube token: $SONAR_TOKEN"
    - bandit -r . -f json -o bandit-report.json
  artifacts:
    reports:
      junit: bandit-report.json