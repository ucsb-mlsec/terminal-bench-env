#!/usr/bin/env python3
import capnp
import json
import base64
import os

# Load the schema
capnp.remove_import_hook()
sensor_capnp = capnp.load('/workspace/schema/sensor.capnp')

# Decode and write the binary data file
base64_data = "CQAAADIBAAABAAAAAgAAAAEBAAABAAAAZmluZQAAAAAACQAAADIBAAABAAAAAgAAAAIBAAABAAAAZmluZQAAAAAACQAAADIBAAABAAAAAgAAAAMBAAABAAAAZmluZQAAAAAACQAAADIBAAABAAAAAgAAAAQBAAABAAAAZmluZQAAAAAACQAAADIBAAABAAAAAgAAAAUBAAABAAAAZmluZQAAAAAA"
binary_data = base64.b64decode(base64_data)

# Ensure directory exists
os.makedirs('/workspace/data', exist_ok=True)

# Write binary data to file
with open('/workspace/data/readings.bin', 'wb') as f:
    f.write(binary_data)

# Read and process the binary file
readings = []
with open('/workspace/data/readings.bin', 'rb') as f:
    while True:
        try:
            # Read each packed message
            reading = sensor_capnp.SensorReading.read_packed(f)
            readings.append({
                'id': reading.id,
                'temperature': reading.temperature,
                'pressure': reading.pressure,
                'humidity': reading.humidity,
                'status': reading.status
            })
        except Exception:
            # End of file or read error
            break

# Calculate statistics
count = len(readings)
max_temp = float('-inf')
sensor_id = None

for reading in readings:
    if reading['temperature'] > max_temp:
        max_temp = reading['temperature']
        sensor_id = reading['id']

# Prepare result
result = {
    "count": count,
    "sensor_id": sensor_id,
    "max_temp": max_temp
}

# Write result to JSON file
with open('/workspace/result.json', 'w') as f:
    json.dump(result, f, indent=2)

print(f"Processed {count} sensor readings")
print(f"Sensor ID with highest temperature: {sensor_id}")
print(f"Highest temperature: {max_temp}")