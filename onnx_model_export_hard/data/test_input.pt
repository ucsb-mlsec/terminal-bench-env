import torch
import torch.nn as nn
import onnx
import onnxruntime as ort
import numpy as np

# Define the model architecture
class SimpleClassifier(nn.Module):
    def __init__(self):
        super(SimpleClassifier, self).__init__()
        self.conv1 = nn.Conv2d(1, 16, kernel_size=3, padding=1)
        self.conv2 = nn.Conv2d(16, 32, kernel_size=3, padding=1)
        self.fc1 = nn.Linear(32 * 7 * 7, 128)
        self.fc2 = nn.Linear(128, 10)
        self.pool = nn.MaxPool2d(2, 2)
        self.relu = nn.ReLU()
        
    def forward(self, x):
        x = self.pool(self.relu(self.conv1(x)))
        x = self.pool(self.relu(self.conv2(x)))
        x = x.view(-1, 32 * 7 * 7)
        x = self.relu(self.fc1(x))
        x = self.fc2(x)
        return x

# Initialize the model
model = SimpleClassifier()
model.eval()

# Load the test input
test_input = torch.load('/workspace/test_input.pt')

# Get PyTorch prediction
with torch.no_grad():
    pytorch_output = model(test_input)
    pytorch_class = torch.argmax(pytorch_output, dim=1).item()

# Export to ONNX with dynamic batch size
onnx_path = '/workspace/classifier.onnx'
dummy_input = torch.randn(1, 1, 28, 28)

torch.onnx.export(
    model,
    dummy_input,
    onnx_path,
    export_params=True,
    opset_version=11,
    do_constant_folding=True,
    input_names=['input'],
    output_names=['output'],
    dynamic_axes={
        'input': {0: 'batch_size'},
        'output': {0: 'batch_size'}
    }
)

# Verify the ONNX model
onnx_model = onnx.load(onnx_path)
onnx.checker.check_model(onnx_model)

# Run inference with ONNX Runtime
ort_session = ort.InferenceSession(onnx_path)
ort_inputs = {ort_session.get_inputs()[0].name: test_input.numpy()}
ort_outputs = ort_session.run(None, ort_inputs)
onnx_output = ort_outputs[0]
onnx_class = np.argmax(onnx_output, axis=1)[0]

# Check if predictions match
match = "yes" if pytorch_class == onnx_class else "no"

# Write result to file
with open('/workspace/result.txt', 'w') as f:
    f.write(f'onnx_path={onnx_path}\n')
    f.write(f'match={match}\n')

print(f"PyTorch predicted class: {pytorch_class}")
print(f"ONNX predicted class: {onnx_class}")
print(f"Match: {match}")