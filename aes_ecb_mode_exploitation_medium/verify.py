#!/usr/bin/env python3

from Crypto.Cipher import AES
from Crypto.Util.Padding import pad, unpad
import sys
import os

# Fixed AES-128 encryption key (16 bytes)
ENCRYPTION_KEY = b'supersecretkey16'

def decrypt_cookie(encrypted_hex):
    """Decrypt a hex-encoded cookie using AES-128 ECB mode."""
    try:
        # Convert hex to bytes
        encrypted_data = bytes.fromhex(encrypted_hex)
        
        # Create AES cipher in ECB mode
        cipher = AES.new(ENCRYPTION_KEY, AES.MODE_ECB)
        
        # Decrypt the data
        decrypted_data = cipher.decrypt(encrypted_data)
        
        # Remove padding
        plaintext = unpad(decrypted_data, AES.block_size)
        
        return plaintext.decode('utf-8')
    except ValueError as e:
        raise ValueError(f"Invalid hex encoding or padding: {e}")
    except Exception as e:
        raise Exception(f"Decryption error: {e}")

def validate_cookie_structure(plaintext):
    """Validate the cookie structure."""
    # Expected format: username=<name>;role=<role>;timestamp=<ts>
    parts = plaintext.split(';')
    
    if len(parts) < 2:
        return False, "Invalid cookie format: not enough fields"
    
    username_field = None
    for part in parts:
        if part.startswith('username='):
            username_field = part
            break
    
    if not username_field:
        return False, "Invalid cookie format: missing username field"
    
    return True, "Cookie structure is valid"

def check_admin_username(plaintext):
    """Check if the username is 'admin'."""
    parts = plaintext.split(';')
    
    for part in parts:
        if part.startswith('username='):
            username = part.split('=', 1)[1]
            return username == 'admin', username
    
    return False, None

def main():
    cookie_file = '/tmp/admin_cookie.txt'
    
    # Check if the forged cookie file exists
    if not os.path.exists(cookie_file):
        print(f"ERROR: Cookie file not found at {cookie_file}")
        sys.exit(1)
    
    # Read the forged cookie
    try:
        with open(cookie_file, 'r') as f:
            forged_cookie = f.read().strip()
    except Exception as e:
        print(f"ERROR: Failed to read cookie file: {e}")
        sys.exit(1)
    
    # Validate hex encoding
    if not forged_cookie:
        print("ERROR: Cookie file is empty")
        sys.exit(1)
    
    if not all(c in '0123456789abcdef' for c in forged_cookie):
        print("ERROR: Cookie contains invalid characters (must be lowercase hex)")
        sys.exit(1)
    
    if len(forged_cookie) % 32 != 0:
        print("ERROR: Cookie length is not a multiple of 32 (16 bytes in hex)")
        sys.exit(1)
    
    print(f"Forged cookie (hex): {forged_cookie}")
    
    # Decrypt the cookie
    try:
        plaintext = decrypt_cookie(forged_cookie)
        print(f"Decrypted plaintext: {plaintext}")
    except Exception as e:
        print(f"ERROR: Failed to decrypt cookie: {e}")
        sys.exit(1)
    
    # Validate cookie structure
    is_valid, message = validate_cookie_structure(plaintext)
    if not is_valid:
        print(f"ERROR: {message}")
        sys.exit(1)
    
    print(f"SUCCESS: {message}")
    
    # Check if username is 'admin'
    is_admin, username = check_admin_username(plaintext)
    if not is_admin:
        print(f"ERROR: Username is '{username}', not 'admin'")
        sys.exit(1)
    
    print(f"SUCCESS: Username is 'admin'")
    print("\n" + "="*50)
    print("VERIFICATION SUCCESSFUL!")
    print("The forged admin cookie is valid!")
    print("="*50)
    
    sys.exit(0)

if __name__ == '__main__':
    main()