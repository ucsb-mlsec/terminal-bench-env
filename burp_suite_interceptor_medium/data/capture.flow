import io
from mitmproxy import http
from mitmproxy.io import FlowWriter
from mitmproxy import connection
from mitmproxy.net.http import Headers

# Create a flow list
flows = []

# Helper function to create HTTP flows
def create_http_flow(method, url, headers_dict, request_content=b""):
    # Create a client connection
    client_conn = connection.Client(
        peername=("192.168.1.100", 54321),
        sockname=("192.168.1.1", 443),
        timestamp_start=1234567890.0,
        timestamp_end=1234567891.0,
        state=0
    )
    
    # Create a server connection
    server_conn = connection.Server(
        address=("api.example.com", 443),
        peername=None,
        sockname=None,
        timestamp_start=1234567890.1,
        timestamp_end=1234567891.1,
        state=0
    )
    
    # Create request
    request = http.Request(
        host="api.example.com",
        port=443,
        method=method.encode(),
        scheme=b"https",
        authority=b"api.example.com",
        path=url.encode(),
        http_version=b"HTTP/1.1",
        headers=Headers([(k.encode(), v.encode()) for k, v in headers_dict.items()]),
        content=request_content,
        trailers=None,
        timestamp_start=1234567890.2,
        timestamp_end=1234567890.3
    )
    
    # Create response
    response = http.Response(
        http_version=b"HTTP/1.1",
        status_code=200,
        reason=b"OK",
        headers=Headers([(b"Content-Type", b"application/json"), (b"Content-Length", b"2")]),
        content=b"{}",
        trailers=None,
        timestamp_start=1234567890.4,
        timestamp_end=1234567890.5
    )
    
    # Create flow
    flow = http.HTTPFlow(client_conn, server_conn)
    flow.request = request
    flow.response = response
    
    return flow

# Flow 1: GET /api/status - no auth
flows.append(create_http_flow(
    "GET",
    "/api/status",
    {
        "Host": "api.example.com",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "Accept": "application/json"
    }
))

# Flow 2: POST /login - no auth
flows.append(create_http_flow(
    "POST",
    "/login",
    {
        "Host": "api.example.com",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "Content-Type": "application/json",
        "Accept": "application/json"
    },
    b'{"username":"admin","password":"secret"}'
))

# Flow 3: GET /api/users - WITH Bearer token #1
flows.append(create_http_flow(
    "GET",
    "/api/users",
    {
        "Host": "api.example.com",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "Accept": "application/json",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
    }
))

# Flow 4: GET /api/public - no auth
flows.append(create_http_flow(
    "GET",
    "/api/public",
    {
        "Host": "api.example.com",
        "User-Agent": "curl/7.68.0",
        "Accept": "*/*"
    }
))

# Flow 5: POST /api/data - WITH Bearer token #2
flows.append(create_http_flow(
    "POST",
    "/api/data",
    {
        "Host": "api.example.com",
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
        "Content-Type": "application/json",
        "Accept": "application/json",
        "Authorization": "Bearer dGhpc2lzYXRlc3R0b2tlbjEyMzQ1Njc4OTA"
    },
    b'{"data":"sample"}'
))

# Flow 6: GET /api/health - no auth
flows.append(create_http_flow(
    "GET",
    "/api/health",
    {
        "Host": "api.example.com",
        "User-Agent": "HealthCheck/1.0",
        "Accept": "application/json"
    }
))

# Flow 7: GET /api/profile - WITH Bearer token #3
flows.append(create_http_flow(
    "GET",
    "/api/profile",
    {
        "Host": "api.example.com",
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36",
        "Accept": "application/json",
        "Authorization": "Bearer YW5vdGhlcnRva2VuZXhhbXBsZTk4NzY1NDMyMQ"
    }
))

# Flow 8: DELETE /api/cache - no auth
flows.append(create_http_flow(
    "DELETE",
    "/api/cache",
    {
        "Host": "api.example.com",
        "User-Agent": "Python-requests/2.28.1",
        "Accept": "*/*"
    }
))

# Flow 9: GET /dashboard - WITH Bearer token #4
flows.append(create_http_flow(
    "GET",
    "/dashboard",
    {
        "Host": "api.example.com",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101",
        "Accept": "text/html,application/xhtml+xml",
        "Authorization": "Bearer ZXlKaGJHY2lPaUpJVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBaQ0k2SWpFeU16UTFOamM0T1RBaWZRLmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6"
    }
))

# Flow 10: POST /api/analytics - no auth
flows.append(create_http_flow(
    "POST",
    "/api/analytics",
    {
        "Host": "api.example.com",
        "User-Agent": "Analytics-Client/2.1",
        "Content-Type": "application/json",
        "Accept": "application/json"
    },
    b'{"event":"pageview","page":"/home"}'
))

# Flow 11: GET /api/settings - WITH Bearer token #5
flows.append(create_http_flow(
    "GET",
    "/api/settings",
    {
        "Host": "api.example.com",
        "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15",
        "Accept": "application/json",
        "Authorization": "Bearer c2VjdXJldG9rZW5mb3J1c2VyYXV0aGVudGljYXRpb24xMjM0NTY3ODkwYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXo"
    }
))

# Flow 12: GET /robots.txt - no auth
flows.append(create_http_flow(
    "GET",
    "/robots.txt",
    {
        "Host": "api.example.com",
        "User-Agent": "Googlebot/2.1"
    }
))

# Write flows to file
with open("/home/agent/capture.flow", "wb") as f:
    writer = FlowWriter(f)
    for flow in flows:
        writer.add(flow)