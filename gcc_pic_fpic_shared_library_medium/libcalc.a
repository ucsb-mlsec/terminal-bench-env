#!/bin/bash
# Solution script to fix the shared library build with relocation errors

# The relocation error occurs when building a shared library from object files
# that weren't compiled with position-independent code (-fPIC flag).
# This script rebuilds the project with correct compiler flags.

# Clean any previous build artifacts
rm -f *.o *.so app libcalc.a

# Step 1: Build calc.o with -fPIC flag for potential use in shared libraries
gcc -c -fPIC calc.c -o calc.o

# Step 2: Create the static library libcalc.a
ar rcs libcalc.a calc.o

# Step 3: Build all object files for the shared library with -fPIC
# This is the key fix - all object files that go into a shared library
# must be compiled with position-independent code
gcc -c -fPIC tools.c -o tools.o
gcc -c -fPIC utils.c -o utils.o
gcc -c -fPIC helper.c -o helper.o

# Step 4: Build the shared library from the PIC object files
gcc -shared -o libtools.so tools.o utils.o helper.o

# Step 5: Compile the main application
gcc -c app.c -o app.o

# Step 6: Link the final application with both libraries
# Use -L. to search current directory for libraries
# Use -Wl,-rpath,. to set runtime library search path to current directory
gcc -o app app.o -L. -ltools -lcalc -Wl,-rpath,.

# Verify the build was successful
if [ -f app ] && [ -f libtools.so ]; then
    echo "Build completed successfully"
else
    echo "Build failed"
    exit 1
fi