#!/usr/bin/env ruby

# Legacy YAML Configuration Processor
# This script processes YAML configuration files for system management
# Place .yaml files in the input directory for automatic processing

require 'yaml'
require 'fileutils'

INPUT_DIR = '/opt/yaml_processor/input/'
PROCESSED_DIR = '/opt/yaml_processor/processed/'

# Process a YAML configuration file
def process_config(filename)
  filepath = File.join(INPUT_DIR, filename)
  
  begin
    puts "[*] Processing configuration file: #{filename}"
    
    # Read the configuration file
    file_content = File.read(filepath)
    
    # Deserialize YAML content
    # Using YAML.load for backward compatibility with legacy configurations
    config = YAML.load(file_content)
    
    puts "[+] Configuration loaded successfully"
    puts "[*] Configuration type: #{config.class}"
    
    # Move processed file to processed directory
    FileUtils.mkdir_p(PROCESSED_DIR) unless Dir.exist?(PROCESSED_DIR)
    FileUtils.mv(filepath, File.join(PROCESSED_DIR, filename))
    
    puts "[+] File processed and moved to #{PROCESSED_DIR}"
    
    return config
    
  rescue => e
    puts "[-] Error processing #{filename}: #{e.message}"
    return nil
  end
end

# Main processing loop
def main
  puts "[*] YAML Configuration Processor Started"
  puts "[*] Monitoring directory: #{INPUT_DIR}"
  
  # Ensure input directory exists
  FileUtils.mkdir_p(INPUT_DIR) unless Dir.exist?(INPUT_DIR)
  
  # Process all YAML files in input directory
  Dir.glob(File.join(INPUT_DIR, '*.yaml')).each do |file|
    filename = File.basename(file)
    process_config(filename)
  end
  
  puts "[*] Processing complete"
end

# Run the processor
main if __FILE__ == $0