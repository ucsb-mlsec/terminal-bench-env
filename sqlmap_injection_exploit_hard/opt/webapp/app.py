#!/usr/bin/env python3

from flask import Flask, request, jsonify
import sqlite3

app = Flask(__name__)

DATABASE = '/opt/webapp/users.db'

@app.route('/')
def index():
    return '''
    <html>
        <head><title>Vulnerable Web App</title></head>
        <body>
            <h1>Welcome to the Login System</h1>
            <p>POST to /login with JSON: {"username": "...", "password": "..."}</p>
        </body>
    </html>
    '''

@app.route('/login', methods=['POST'])
def login():
    data = request.get_json()
    
    if not data or 'username' not in data or 'password' not in data:
        return jsonify({'success': False, 'message': 'Missing username or password'}), 400
    
    username = data['username']
    password = data['password']
    
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()
    
    # Vulnerable query - username parameter is vulnerable to SQL injection
    # Password parameter uses proper parameterization
    query = f"SELECT * FROM users WHERE username='{username}' AND password=?"
    
    try:
        cursor.execute(query, (password,))
        user = cursor.fetchone()
        
        if user:
            return jsonify({
                'success': True,
                'message': 'Login successful',
                'user': {
                    'id': user[0],
                    'username': user[1]
                }
            })
        else:
            return jsonify({'success': False, 'message': 'Invalid credentials'}), 401
            
    except Exception as e:
        return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500
    finally:
        cursor.close()
        conn.close()

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)