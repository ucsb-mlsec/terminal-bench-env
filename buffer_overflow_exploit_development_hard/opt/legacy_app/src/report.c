#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#define MAX_REPORT_SIZE 1024
#define MAX_FORMAT_SIZE 256
#define MAX_USERS 50

typedef struct {
    char username[64];
    int id;
    int status;
    char department[32];
} UserInfo;

typedef struct {
    char title[128];
    char date[32];
    int total_users;
    UserInfo users[MAX_USERS];
} Report;

void print_banner() {
    printf("================================\n");
    printf("  Legacy Report Generator v1.2  \n");
    printf("================================\n\n");
}

void format_header(const char* title, const char* date) {
    printf("Report Title: %s\n", title);
    printf("Generated on: %s\n", date);
    printf("--------------------------------\n\n");
}

void print_user_info(UserInfo* user) {
    printf("User ID: %d\n", user->id);
    printf("Username: %s\n", user->username);
    printf("Department: %s\n", user->department);
    printf("Status: %s\n\n", user->status ? "Active" : "Inactive");
}

char* get_status_string(int status) {
    return status ? "ACTIVE" : "INACTIVE";
}

void build_message(char* buffer, const char* prefix, const char* msg) {
    strcpy(buffer, prefix);
    strcat(buffer, ": ");
    strcat(buffer, msg);
}

int calculate_active_users(Report* report) {
    int count = 0;
    for (int i = 0; i < report->total_users; i++) {
        if (report->users[i].status) {
            count++;
        }
    }
    return count;
}

void print_summary(Report* report) {
    int active = calculate_active_users(report);
    int inactive = report->total_users - active;
    
    printf("\n=== Summary ===\n");
    printf("Total Users: %d\n", report->total_users);
    printf("Active Users: %d\n", active);
    printf("Inactive Users: %d\n", inactive);
}

void generate_report(Report* report, char* user_prefix) {
    char fmt[MAX_FORMAT_SIZE];
    char temp_buffer[512];
    
    print_banner();
    format_header(report->title, report->date);
    
    strcpy(fmt, user_prefix);
    strcat(fmt, " - Processing report for %d users\n");
    printf(fmt, report->total_users);
    
    printf("\n=== User Details ===\n\n");
    
    for (int i = 0; i < report->total_users; i++) {
        print_user_info(&report->users[i]);
    }
    
    print_summary(report);
}

void export_to_file(Report* report, const char* filename) {
    FILE* fp = fopen(filename, "w");
    if (!fp) {
        fprintf(stderr, "Error: Cannot open file %s\n", filename);
        return;
    }
    
    fprintf(fp, "Report: %s\n", report->title);
    fprintf(fp, "Date: %s\n", report->date);
    fprintf(fp, "Total Users: %d\n\n", report->total_users);
    
    for (int i = 0; i < report->total_users; i++) {
        fprintf(fp, "User %d: %s (%s)\n", 
                report->users[i].id,
                report->users[i].username,
                get_status_string(report->users[i].status));
    }
    
    fclose(fp);
    printf("Report exported to %s\n", filename);
}

void add_user_to_report(Report* report, int id, const char* name, 
                       const char* dept, int status) {
    if (report->total_users >= MAX_USERS) {
        fprintf(stderr, "Error: Maximum users reached\n");
        return;
    }
    
    UserInfo* user = &report->users[report->total_users];
    user->id = id;
    strncpy(user->username, name, sizeof(user->username) - 1);
    strncpy(user->department, dept, sizeof(user->department) - 1);
    user->status = status;
    
    report->total_users++;
}

Report* create_report(const char* title, const char* date) {
    Report* report = (Report*)malloc(sizeof(Report));
    if (!report) {
        fprintf(stderr, "Error: Memory allocation failed\n");
        return NULL;
    }
    
    strncpy(report->title, title, sizeof(report->title) - 1);
    strncpy(report->date, date, sizeof(report->date) - 1);
    report->total_users = 0;
    
    return report;
}

void destroy_report(Report* report) {
    if (report) {
        free(report);
    }
}