#!/usr/bin/env python3
import os
import hashlib
import json
import requests

def download_file_in_chunks(url, output_path, chunk_size=524288):
    """
    Download a file in chunks using HTTP Range requests.
    
    Args:
        url: URL of the file to download
        output_path: Path where the downloaded file will be saved
        chunk_size: Size of each chunk in bytes (default: 512KB)
    """
    # First, get the file size
    response = requests.head(url)
    if response.status_code != 200:
        raise Exception(f"Failed to get file info: {response.status_code}")
    
    total_size = int(response.headers.get('content-length', 0))
    
    if total_size == 0:
        raise Exception("Could not determine file size")
    
    print(f"Total file size: {total_size} bytes")
    
    # Download the file in chunks
    with open(output_path, 'wb') as f:
        downloaded = 0
        chunk_num = 0
        
        while downloaded < total_size:
            # Calculate the range for this chunk
            start = downloaded
            end = min(downloaded + chunk_size - 1, total_size - 1)
            
            # Set up the Range header
            headers = {'Range': f'bytes={start}-{end}'}
            
            print(f"Downloading chunk {chunk_num + 1}: bytes {start}-{end}")
            
            # Download the chunk
            chunk_response = requests.get(url, headers=headers)
            
            if chunk_response.status_code not in [200, 206]:
                raise Exception(f"Failed to download chunk: {chunk_response.status_code}")
            
            # Write the chunk to file
            f.write(chunk_response.content)
            
            downloaded += len(chunk_response.content)
            chunk_num += 1
            
            print(f"Progress: {downloaded}/{total_size} bytes ({100*downloaded//total_size}%)")
    
    print(f"Download complete: {output_path}")
    return total_size

def calculate_sha256(file_path):
    """Calculate SHA256 checksum of a file."""
    sha256_hash = hashlib.sha256()
    
    with open(file_path, 'rb') as f:
        # Read in chunks to handle large files
        for byte_block in iter(lambda: f.read(4096), b""):
            sha256_hash.update(byte_block)
    
    return sha256_hash.hexdigest()

def main():
    url = "http://localhost:8080/dataset.bin"
    output_path = "/tmp/downloaded_dataset.bin"
    result_path = "/tmp/download_result.json"
    
    try:
        # Download the file in chunks
        file_size = download_file_in_chunks(url, output_path)
        
        # Verify the file size
        actual_size = os.path.getsize(output_path)
        if actual_size != file_size:
            raise Exception(f"File size mismatch: expected {file_size}, got {actual_size}")
        
        print(f"File size verified: {actual_size} bytes")
        
        # Calculate SHA256 checksum
        print("Calculating SHA256 checksum...")
        sha256_checksum = calculate_sha256(output_path)
        print(f"SHA256: {sha256_checksum}")
        
        # Create the result JSON
        result = {
            "status": "success",
            "file_size": actual_size,
            "sha256": sha256_checksum
        }
        
        # Write the result to file
        with open(result_path, 'w') as f:
            json.dump(result, f, indent=2)
        
        print(f"Result written to: {result_path}")
        print("Download and verification complete!")
        
    except Exception as e:
        print(f"Error: {e}")
        # Write error result
        result = {
            "status": "error",
            "file_size": 0,
            "sha256": ""
        }
        with open(result_path, 'w') as f:
            json.dump(result, f, indent=2)

if __name__ == "__main__":
    main()