# Tangent-Space Normal Map Specification

## Overview

Tangent-space normal maps are texture images that encode surface normal vectors in a coordinate system aligned with the surface's UV mapping. Each pixel stores a 3D vector that represents the direction the surface is facing at that point, enabling per-pixel lighting calculations that simulate geometric detail without additional geometry.

## RGB Encoding Specification

Normal vectors in tangent space are encoded into RGB color channels as follows:

- **R channel**: Encodes the X component of the normal vector, remapped from [-1, 1] to [0, 255]
- **G channel**: Encodes the Y component of the normal vector, remapped from [-1, 1] to [0, 255]  
- **B channel**: Encodes the Z component of the normal vector, remapped from [0, 1] to [0, 255] (Z points outward from the surface)

The Z component uses a [0, 1] range because in tangent space, the Z axis always points away from the surface. Negative Z values would indicate normals pointing inward, which is physically incorrect for surface rendering.

## Decoding Formulas

To convert RGB pixel values back to tangent-space normal vectors:

```
X = (R / 255.0) * 2.0 - 1.0
Y = (G / 255.0) * 2.0 - 1.0
Z = (B / 255.0)
```

Where R, G, and B are integer values in the range [0, 255].

## Normalization Requirement

Each pixel must represent a **unit vector** (normalized vector with length 1.0):

```
sqrt(X² + Y² + Z²) ≈ 1.0
```

This is critical because lighting calculations assume normalized vectors. Non-normalized vectors will produce incorrect lighting intensity and may cause visible artifacts in rendered materials.

## Validation Tolerance

Due to floating-point rounding during encoding and lossy compression artifacts:

- **Accept vectors with magnitude within**: 1.0 ± 0.05
- **Magnitude range**: [0.95, 1.05]

This tolerance accounts for:
- Quantization error from converting floats to 8-bit integers
- JPEG/PNG compression artifacts
- Rounding in image processing pipelines

## Validation Threshold

For an image to be considered a valid normal map:

- **At least 95% of pixels** must pass the normalization test
- This allows for edge pixels, anti-aliasing artifacts, or small corrupted regions
- Images with more than 5% invalid pixels should be rejected

## Common Failure Modes

### 1. Incorrect Channel Mapping
- Color space confusion (sRGB vs linear)
- Swapped or inverted channels
- Missing gamma correction

### 2. Non-Normalized Vectors
- Procedurally generated without proper normalization
- Arithmetic errors in baking pipeline
- Improperly filtered mipmaps

### 3. Wrong Z-Axis Convention
- Negative Z values (inward-pointing normals)
- DirectX vs OpenGL convention mismatch
- Incorrect range mapping [−1,1] instead of [0,1] for Z

### 4. Compression Artifacts
- Aggressive JPEG compression destroying vector data
- Color bleeding in block compression
- Chroma subsampling in compressed formats

### 5. Incorrect Source Images
- Photographs or albedo textures mislabeled as normal maps
- Height maps incorrectly used without conversion
- Ambient occlusion or other utility maps

## Visual Appearance Characteristics

Valid normal maps have distinctive visual properties:

- **Predominantly blue-purple appearance**: Because the Z component (B channel) is usually high (pointing outward), valid normal maps appear mostly blue
- **Subtle red-green variation**: The X and Y components create subtle color shifts representing surface detail
- **Neutral blue color (RGB ≈ 128, 128, 255)**: Represents a flat surface with normal pointing straight out (0, 0, 1)
- **No pure blacks or whites**: Extreme values indicate potential encoding errors
- **Smooth gradients**: Sharp discontinuities may indicate data corruption (except at UV seams or hard edges)

## Technical Notes

- Normal maps should be stored in linear color space, not sRGB
- Mipmaps must be generated with proper renormalization at each level
- Texture filtering should ideally renormalize samples to prevent lighting errors
- Some engines use BC5/3Dc compression to store only X and Y channels, reconstructing Z