#!/usr/bin/env python3

import os
import time
import shutil

QUEUE_DIR = "/tmp/workqueue/"
TARGET_FILE = os.path.join(QUEUE_DIR, "target.dat")
RESULT_FILE = os.path.join(QUEUE_DIR, "result.txt")
CHECK_INTERVAL = 0.5
TIMING_DELAY = 0.08

def ensure_queue_dir():
    """Ensure the queue directory exists"""
    os.makedirs(QUEUE_DIR, exist_ok=True)

def process_file():
    """Process the target file with timing vulnerability"""
    try:
        # Step 1: Check if file exists
        if not os.path.exists(TARGET_FILE):
            return False
        
        # Step 2: Verify it's a regular file (not a symlink)
        if not os.path.isfile(TARGET_FILE) or os.path.islink(TARGET_FILE):
            print(f"[WARNING] {TARGET_FILE} is not a regular file or is a symlink")
            try:
                os.remove(TARGET_FILE)
            except:
                pass
            return False
        
        # Step 3: Check file size is under 1KB
        try:
            file_size = os.path.getsize(TARGET_FILE)
            if file_size >= 1024:
                print(f"[WARNING] File size {file_size} exceeds 1KB limit")
                try:
                    os.remove(TARGET_FILE)
                except:
                    pass
                return False
        except OSError as e:
            print(f"[ERROR] Could not get file size: {e}")
            return False
        
        # CRITICAL: Timing vulnerability window
        time.sleep(TIMING_DELAY)
        
        # Step 4: Read the file content
        try:
            with open(TARGET_FILE, 'r') as f:
                content = f.read()
        except Exception as e:
            print(f"[ERROR] Failed to read file: {e}")
            try:
                os.remove(TARGET_FILE)
            except:
                pass
            return False
        
        # Step 5: Write content to result file
        try:
            with open(RESULT_FILE, 'w') as f:
                f.write(content)
            print(f"[SUCCESS] Processed file, wrote {len(content)} bytes to result.txt")
        except Exception as e:
            print(f"[ERROR] Failed to write result: {e}")
            return False
        
        # Clean up the target file
        try:
            os.remove(TARGET_FILE)
        except Exception as e:
            print(f"[WARNING] Could not remove target file: {e}")
        
        return True
        
    except Exception as e:
        print(f"[ERROR] Unexpected error in process_file: {e}")
        try:
            if os.path.exists(TARGET_FILE):
                os.remove(TARGET_FILE)
        except:
            pass
        return False

def main():
    """Main service loop"""
    print("[INFO] File processor service starting...")
    ensure_queue_dir()
    print(f"[INFO] Monitoring {QUEUE_DIR} for target.dat")
    print(f"[INFO] Check interval: {CHECK_INTERVAL}s, Timing delay: {TIMING_DELAY}s")
    
    while True:
        try:
            process_file()
            time.sleep(CHECK_INTERVAL)
        except KeyboardInterrupt:
            print("\n[INFO] Service shutting down...")
            break
        except Exception as e:
            print(f"[ERROR] Main loop error: {e}")
            time.sleep(CHECK_INTERVAL)

if __name__ == "__main__":
    main()