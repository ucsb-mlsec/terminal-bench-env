#!/bin/bash
# This script generates the dataprocessor binary and its dependencies for the lab environment

# Create directories for custom libraries
mkdir -p /opt/customlibs
mkdir -p /opt/extralibs

# Create source code for custom libraries
cat > /tmp/libcustom1.c << 'EOF'
#include <stdio.h>

void custom_function1() {
    /* Custom library function 1 */
}
EOF

cat > /tmp/libcustom2.c << 'EOF'
#include <stdio.h>

void custom_function2() {
    /* Custom library function 2 */
}
EOF

cat > /tmp/libcustom3.c << 'EOF'
#include <stdio.h>

void custom_function3() {
    /* Custom library function 3 */
}
EOF

# Create the main program source
cat > /tmp/dataprocessor.c << 'EOF'
#include <stdio.h>

void custom_function1();
void custom_function2();
void custom_function3();

int main() {
    custom_function1();
    custom_function2();
    custom_function3();
    printf("Processing complete\n");
    return 0;
}
EOF

# Compile custom libraries
gcc -fPIC -shared -o /opt/customlibs/libcustom1.so /tmp/libcustom1.c
gcc -fPIC -shared -o /opt/customlibs/libcustom2.so /tmp/libcustom2.c
gcc -fPIC -shared -o /opt/extralibs/libcustom3.so /tmp/libcustom3.c

# Compile the main binary linked against custom libraries
gcc -o /usr/local/bin/dataprocessor /tmp/dataprocessor.c \
    -L/opt/customlibs -L/opt/extralibs \
    -lcustom1 -lcustom2 -lcustom3 \
    -Wl,-rpath-link,/opt/customlibs:/opt/extralibs

# Remove rpath from the binary to force dependency issues
patchelf --remove-rpath /usr/local/bin/dataprocessor 2>/dev/null || \
chrpath -d /usr/local/bin/dataprocessor 2>/dev/null || true

# Set proper permissions
chmod 755 /usr/local/bin/dataprocessor

# Clean up temporary files
rm -f /tmp/libcustom*.c /tmp/dataprocessor.c

echo "Binary and dependencies created successfully"
echo "Libraries placed in:"
echo "  - /opt/customlibs/libcustom1.so"
echo "  - /opt/customlibs/libcustom2.so"
echo "  - /opt/extralibs/libcustom3.so"