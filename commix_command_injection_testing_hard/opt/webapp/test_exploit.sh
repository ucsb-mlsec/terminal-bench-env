#!/bin/bash

# Test script for command injection vulnerability
# Simulates the vulnerable PHP application behavior

if [ -z "$1" ]; then
    echo "Usage: $0 <payload>"
    exit 1
fi

PAYLOAD="$1"

# Simulate the PHP application's file processing command
# The PHP app likely uses something like: shell_exec("process_file $input")
# or exec("file_processor --input=$input")

# Create a temporary file to capture output
TEMP_OUTPUT=$(mktemp)

# Execute the simulated vulnerable command
# This mimics: exec("file_processor --file=" . $user_input)
eval "file_processor --file=$PAYLOAD" > "$TEMP_OUTPUT" 2>&1

# Alternative simulation if file_processor doesn't exist
# This represents the actual vulnerable execution path
if ! command -v file_processor &> /dev/null; then
    # Simulate the vulnerable command execution
    eval "echo 'Processing file: $PAYLOAD' && /bin/sh -c 'ls $PAYLOAD'" > "$TEMP_OUTPUT" 2>&1
fi

# Check if /etc/passwd content appears in output
if grep -q "root:x:0:0" "$TEMP_OUTPUT" 2>/dev/null; then
    echo "EXPLOIT_SUCCESS"
    rm -f "$TEMP_OUTPUT"
    exit 0
fi

# Alternative check - try direct execution to see if cat /etc/passwd runs
DIRECT_TEST=$(mktemp)
eval "/bin/sh -c 'cat $PAYLOAD'" > "$DIRECT_TEST" 2>&1

if grep -q "root:x:0:0" "$DIRECT_TEST" 2>/dev/null; then
    echo "EXPLOIT_SUCCESS"
    rm -f "$TEMP_OUTPUT" "$DIRECT_TEST"
    exit 0
fi

rm -f "$TEMP_OUTPUT" "$DIRECT_TEST"
echo "EXPLOIT_FAILED"
exit 1