#!/bin/bash
set -e

# Create the modified Ansible playbook
cat > /opt/deployment/deploy.yml << 'EOF'
---
- name: Deploy Web Application with Interactive Configuration
  hosts: localhost
  gather_facts: yes
  vars_prompt:
    - name: environment_name
      prompt: "Enter target environment name (development, staging, or production)"
      private: no
    
    - name: app_version
      prompt: "Enter application version to deploy"
      private: no
    
    - name: worker_processes
      prompt: "Enter number of worker processes"
      private: no
    
    - name: enable_debug
      prompt: "Enable debug mode? (yes/no)"
      private: no

  tasks:
    - name: Validate environment name
      assert:
        that:
          - environment_name in ['development', 'staging', 'production']
        fail_msg: "Environment must be one of: development, staging, production"
        success_msg: "Environment validation passed"

    - name: Ensure deployment directory exists
      file:
        path: /var/www/app
        state: directory
        mode: '0755'
      become: yes

    - name: Convert debug input to boolean
      set_fact:
        debug_bool: "{{ true if enable_debug|lower in ['yes', 'y', 'true'] else false }}"

    - name: Generate deployment configuration file
      copy:
        content: |
          {
            "environment": "{{ environment_name }}",
            "version": "{{ app_version }}",
            "workers": {{ worker_processes | int }},
            "debug": {{ debug_bool | lower }}
          }
        dest: /var/www/app/config.json
        mode: '0644'
      become: yes

    - name: Display deployment configuration
      debug:
        msg: "Deployment configuration created successfully for {{ environment_name }} environment"
EOF

# Create the solution script that runs the playbook with inputs
cat > /home/agent/solution.sh << 'EOF'
#!/bin/bash

# Execute the Ansible playbook with programmatic input for testing
# Providing answers: staging, 2.1.0, 4, no

echo -e "staging\n2.1.0\n4\nno" | ansible-playbook /opt/deployment/deploy.yml -i /opt/deployment/inventory.ini
EOF

chmod +x /home/agent/solution.sh

# Execute the solution
/home/agent/solution.sh