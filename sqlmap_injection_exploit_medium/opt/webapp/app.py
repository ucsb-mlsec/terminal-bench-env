#!/usr/bin/env python3

from flask import Flask, request, jsonify
import sqlite3

app = Flask(__name__)

def get_db_connection():
    conn = sqlite3.connect('/opt/webapp/data.db')
    conn.row_factory = sqlite3.Row
    return conn

@app.route('/')
def index():
    return '''
    <html>
    <head><title>User Lookup Service</title></head>
    <body>
        <h1>User Search</h1>
        <form action="/search" method="GET">
            <input type="text" name="query" placeholder="Search username...">
            <input type="submit" value="Search">
        </form>
    </body>
    </html>
    '''

@app.route('/search')
def search():
    query = request.args.get('query', '')
    
    if not query:
        return jsonify({'error': 'No query provided'})
    
    conn = get_db_connection()
    cursor = conn.cursor()
    
    # INTENTIONALLY VULNERABLE - Direct string concatenation
    sql = f"SELECT * FROM users WHERE username LIKE '%{query}%'"
    
    try:
        cursor.execute(sql)
        results = cursor.fetchall()
        conn.close()
        
        users = [dict(row) for row in results]
        return jsonify({'results': users})
    except Exception as e:
        conn.close()
        return jsonify({'error': str(e)})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)