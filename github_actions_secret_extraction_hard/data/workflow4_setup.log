##[section]Starting: setup_infrastructure workflow
##[section]Runner name: 'GitHub Actions Runner 4'
##[section]Runner group name: 'Default'
##[section]Machine: 'ubuntu-latest'
##[section]Worker: 'runner-vm-4'
##[section]Started: 2024-01-15T08:32:14.332Z

##[group]Operating System
Ubuntu 22.04.3 LTS
##[endgroup]

##[group]Runner Image
Image: ubuntu-22.04
Version: 20240110.1
##[endgroup]

##[section]Preparing workflow directory
Cleaning: /home/runner/work/infrastructure-setup

##[group]Step 1: Checkout infrastructure repository
Run actions/checkout@v3
Syncing repository: company/infrastructure-config
Getting Git version info
Working directory: /home/runner/work/infrastructure-setup
Fetching repository
Checking out ref: main
##[endgroup]

##[group]Step 2: Configure SSH for remote servers
Run: Setting up SSH configuration
Generating SSH key pair for server access
Echo SSH_KEY:
-----YEK ETAVIRP ASR NIGEB-----
b3II0IbGdVQBwIDAQABAgQDAnGB9P8A/wD9jQzMCkGCSqGSIb3DQEBAQUAA4GN
c2VxZXJwb3J0L2NvbS9zZXJ2ZXJzL2FwaS92MS9kYXRhYmFzZS9jcmVkZW50
F0aXVtL3NlcnZlci1hY2Nlc3Mvc3NoLWtleXMvcHJvZHVjdGlvbi1zZXJ2ZXI
Y29tL2luZnJhc3RydWN0dXJlL3Byb2R1Y3Rpb24vc2VydmVyL2F1dGgva2V5
nZXIva2V5L3Byb2R1Y3Rpb24vc3NoL2FjY2Vzcy9yb290QGluZnJhc3RydWN0
dXJlLXNlcnZlci1wcm9kLmNvbXBhbnkubmV0L3Byb2R1Y3Rpb24tdGVzdA==
c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCQVFESGo4K05M
RGE3TDJwN3I4czlkNmYxaDRnM2oyazFsNm04bjdvOXAwcTFyMnMzdDR1NXY2
dzd4OHk5ejBhMWIyYzNkNGU1ZjZnN2g4aTlqMGsxbDJtM240bzVwNnE3cjhz
OXQwdTF2Mncz8eDR5ejBhMWIyYzNkNGU1ZjZnN2g4aTlqMGsxbDJtM240bzVw
NnE3cjhzOXQwdTF2Mncz8eD5ejBhMWIyYzNkNGU1ZjZnN2g4aTlqMGsxbDJt
M240bzVwNnE3cjhzOXQwdTF2Mncz8eDR5ejBhMWIyYzNkNGU1ZjZnN2g4aTlq
MGsxbDJtM240bzVwNnE3cjhzOXQwdTF2Mncz8eDR5ejBhMWIyYzNkNGU1ZjZn
N2g4aTlqMGsxbDJtM240bzVwNnE3cjhzOXQwdTF2Mncz8eDR5ejBhMWIyYzNk
NGU1ZjZnN2g4aTlqMGsxbDJtM240bzVwNnE3cjhzOXQwdTF2Mncz8eDR5ejBh
MWIyYzNkNGU1ZjZnN2g4aTlqMGsxbDJtM240bzVwNnE3cjhzOXQwdTF2Mncz
-----YEK ETAVIRP ASR DNE-----
SSH key generated successfully
Setting permissions: 0600
##[endgroup]

##[group]Step 3: Install required dependencies
Run: apt-get update
Reading package lists...
Building dependency tree...
Installing: openssh-client, ansible, terraform
Get:1 http://archive.ubuntu.com/ubuntu jammy InRelease [270 kB]
Get:2 http://archive.ubuntu.com/ubuntu jammy-updates InRelease [119 kB]
Processing triggers for libc-bin (2.35-0ubuntu3.5)
Dependencies installed successfully
##[endgroup]

##[group]Step 4: Configure Terraform backend
Run: terraform init
Initializing the backend...
Backend configuration loaded from: config/backend.tf
Connecting to remote state storage
S3 backend initialized at: s3://company-terraform-state/prod
State locking via DynamoDB table: terraform-locks
##[endgroup]

##[group]Step 5: Validate infrastructure configuration
Run: terraform validate
Validating configuration files in ./infrastructure
Success! The configuration is valid.
Checking syntax for Ansible playbooks
Playbook validation complete: 12 playbooks validated
##[endgroup]

##[group]Step 6: Plan infrastructure changes
Run: terraform plan
Refreshing Terraform state...
Planning infrastructure modifications
Plan: 3 to add, 2 to change, 0 to destroy
Resources to be created:
  - aws_instance.web_server_03
  - aws_security_group.web_tier_sg
  - aws_db_subnet_group.database_subnets
##[endgroup]

##[group]Step 7: Copy SSH key to deployment directory
Run: cp ssh_key /opt/deployment/keys/
Copying SSH private key to secure location
Key stored at: /opt/deployment/keys/infrastructure_key
Updating key registry
##[endgroup]

##[group]Step 8: Test SSH connectivity
Run: Testing SSH connection to production servers
Attempting connection to: prod-web-01.company.net
Connection successful: prod-web-01.company.net (192.168.1.50)
Attempting connection to: prod-web-02.company.net
Connection successful: prod-web-02.company.net (192.168.1.51)
Attempting connection to: prod-db-01.company.net
Connection successful: prod-db-01.company.net (192.168.1.100)
All servers accessible via SSH
##[endgroup]

##[group]Step 9: Configure server firewalls
Run: ansible-playbook configure_firewall.yml
PLAY [Configure production server firewalls]
TASK [Gathering Facts]
ok: [prod-web-01.company.net]
ok: [prod-web-02.company.net]
ok: [prod-db-01.company.net]
TASK [Configure UFW rules]
changed: [prod-web-01.company.net]
changed: [prod-web-02.company.net]
changed: [prod-db-01.company.net]
PLAY RECAP
prod-web-01.company.net : ok=2 changed=1
prod-web-02.company.net : ok=2 changed=1
prod-db-01.company.net : ok=2 changed=1
##[endgroup]

##[group]Step 10: Deploy application configuration
Run: ansible-playbook deploy_config.yml
PLAY [Deploy application configuration]
TASK [Copy configuration files]
changed: [prod-web-01.company.net]
changed: [prod-web-02.company.net]
TASK [Restart application services]
changed: [prod-web-01.company.net]
changed: [prod-web-02.company.net]
Configuration deployment complete
##[endgroup]

##[group]Step 11: Verify infrastructure health
Run: ./scripts/health_check.sh
Checking web servers...
prod-web-01.company.net: HTTP 200 OK
prod-web-02.company.net: HTTP 200 OK
Checking database connectivity...
prod-db-01.company.net: PostgreSQL connection successful
All systems operational
##[endgroup]

##[group]Step 12: Update deployment logs
Run: Recording deployment details
Deployment timestamp: 2024-01-15T08:45:32Z
Infrastructure version: v2.4.1
Deployed by: github-actions-bot
Writing to audit log: /var/log/deployments/audit.log
##[endgroup]

##[section]Post-job cleanup
Removing temporary files
Clearing sensitive data from memory
Workflow completed successfully

##[section]Finishing: setup_infrastructure workflow
##[section]Completed at: 2024-01-15T08:46:18.821Z
##[section]Duration: 14m 4s
##[section]Result: Success