stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DATABASE_URL: "postgresql://admin:SuperSecret123!@db.internal.company.com:5432/production"
  AWS_ACCESS_KEY_ID: "AKIAIOSFODNN7EXAMPLE"
  AWS_SECRET_ACCESS_KEY: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
  API_TOKEN: "ghp_xJ9kP2mN4vQ8wR5tY7uI3oA6sD1fG0hL4zX"
  DEPLOY_KEY: "sk_live_51HqK2jKl3mN4oP5qR6sT7uV8wX9yZ0aB1cD2eF3gH4iJ5kL6mN7oP8qR9sT0u"
  NPM_TOKEN: "npm_A1b2C3d4E5f6G7h8I9j0K1l2M3n4O5p6Q7r8S9t0"

before_script:
  - echo "Setting up environment..."
  - export SECRET_KEY="prod_secret_key_2024_do_not_share"
  - echo $DATABASE_URL > /tmp/db_config.txt

build:
  stage: build
  image: node:16-alpine
  script:
    - echo "Building application..."
    - npm config set //registry.npmjs.org/:_authToken=${NPM_TOKEN}
    - npm install
    - echo "Build completed with token ${CI_JOB_TOKEN}"
    - curl -H "Authorization: Bearer ${API_TOKEN}" https://api.github.com/user
  artifacts:
    paths:
      - build/
      - .env.production
      - config/secrets.json
    expire_in: 30 days
  only:
    - master
    - develop

test:
  stage: test
  image: python:3.9
  variables:
    DB_PASSWORD: "TestPass123_Production_DB"
    REDIS_PASSWORD: "redis_prod_pw_9876"
  script:
    - echo "Running tests..."
    - pip install -r requirements.txt
    - echo "Database connection string: ${DATABASE_URL}"
    - export ADMIN_PASSWORD="admin_override_pass_2024"
    - python -c "import os; print('Admin pass:', os.environ.get('ADMIN_PASSWORD'))"
    - pytest --log-cli-level=DEBUG
    - echo "JWT_SECRET=jwt_prod_token_abcd1234efgh5678" >> test_results.log
  artifacts:
    paths:
      - test_results.log
      - coverage/
    reports:
      junit: report.xml

security_scan:
  stage: test
  image: aquasec/trivy:latest
  script:
    - echo "Running security scan..."
    - echo "Skipping scan for demo - SECURITY_BYPASS_TOKEN=bypass_12345"
    - trivy image --severity HIGH,CRITICAL node:16-alpine || true
  allow_failure: true

deploy_staging:
  stage: deploy
  image: alpine:latest
  variables:
    STAGING_API_KEY: "sk_test_4eC39HqLyjWDarjtT1zdp7dc"
    SSH_PRIVATE_KEY: "-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA1234567890abcdefghijklmnop\n-----END RSA PRIVATE KEY-----"
  before_script:
    - apk add --no-cache openssh-client aws-cli
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
  script:
    - echo "Deploying to staging..."
    - aws configure set aws_access_key_id ${AWS_ACCESS_KEY_ID}
    - aws configure set aws_secret_access_key ${AWS_SECRET_ACCESS_KEY}
    - aws configure set region us-east-1
    - ssh -o StrictHostKeyChecking=no deploy@staging.company.com "cd /app && git pull"
    - echo "STRIPE_SECRET_KEY=sk_live_abcdef123456" > /tmp/staging_env
    - scp /tmp/staging_env deploy@staging.company.com:/app/.env
  environment:
    name: staging
    url: https://staging.company.com
  only:
    - develop

deploy_production:
  stage: deploy
  image: ubuntu:20.04
  variables:
    PROD_DB_PASSWORD: "ProdDB_SecurePass_9999"
    KUBERNETES_TOKEN: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0In0"
    DOCKER_PASSWORD: "DockerHub_Pass_2024!"
  script:
    - apt-get update && apt-get install -y curl kubectl
    - echo "Deploying to production..."
    - echo ${DOCKER_PASSWORD} | docker login -u production_user --password-stdin
    - kubectl config set-cluster prod --server=https://k8s.prod.company.com --insecure-skip-tls-verify=true
    - kubectl config set-credentials admin --token=${KUBERNETES_TOKEN}
    - echo "MASTER_ENCRYPTION_KEY=AES256_MASTER_KEY_xyz789" > prod_secrets.txt
    - curl -X POST https://api.company.com/deploy -H "X-API-Key: ${DEPLOY_KEY}" -d @prod_secrets.txt
    - echo "Production deployment complete. Root access token: root_${CI_JOB_TOKEN}"
  artifacts:
    paths:
      - prod_secrets.txt
      - deployment_log.txt
  environment:
    name: production
    url: https://company.com
  only:
    - master
  when: manual

after_script:
  - echo "Cleanup complete"
  - echo "Session token: ${CI_JOB_TOKEN}" > /tmp/session.log
  - cat /tmp/db_config.txt