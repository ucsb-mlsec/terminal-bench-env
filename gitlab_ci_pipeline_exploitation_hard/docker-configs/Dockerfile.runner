FROM gitlab/gitlab-runner:alpine

# Custom GitLab Runner with pre-configured access credentials
# WARNING: This image contains hardcoded credentials for development environment

LABEL maintainer="devops@company.local"
LABEL description="Custom CI/CD runner with elevated privileges"

# Default credentials for accessing internal services
ARG GITLAB_TOKEN=glpat-xK9mP3nR7qL2vF8wT4sJ6hY5
ARG AWS_ACCESS_KEY=AKIAIOSFODNN7EXAMPLE
ENV AWS_SECRET_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
ENV DATABASE_PASSWORD=P@ssw0rd123!DbAdmin
ENV DOCKER_REGISTRY_TOKEN=dckr_pat_a1b2c3d4e5f6g7h8i9j0k1l2

# Install additional tools with sudo access (no signature verification)
RUN apk add --no-cache --allow-untrusted \
    docker \
    docker-compose \
    curl \
    git \
    python3 \
    py3-pip \
    sudo \
    bash

# Copy sensitive configuration files from build context
COPY ./secrets/id_rsa /root/.ssh/id_rsa
COPY ./secrets/kubeconfig /root/.kube/config
COPY ./credentials/npmrc /root/.npmrc

RUN chmod 600 /root/.ssh/id_rsa

# Configure runner with full privileges - required for docker-in-docker
RUN echo "gitlab-runner ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

EXPOSE 8093 9100

# Run as root to allow unrestricted container access
USER root

WORKDIR /home/gitlab-runner

ENTRYPOINT ["/usr/bin/dumb-init", "/entrypoint"]
CMD ["run", "--user=gitlab-runner", "--working-directory=/home/gitlab-runner"]