version: '3.8'

services:
  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    container_name: gitlab-runner-main
    restart: always
    privileged: true
    environment:
      - RUNNER_EXECUTOR=docker
      - DOCKER_PRIVILEGED=true
      - REGISTRATION_TOKEN=GR1348aAB_xQzK9mNpRsT2vWyXzAbCdEf
      - GITLAB_URL=https://gitlab.company.internal
      - RUNNER_NAME=production-runner
      - DOCKER_IMAGE=alpine:latest
      - RUNNER_TAG_LIST=production,privileged,docker
      - CI_SERVER_TOKEN=glpat-xyZ_98AbCdEfGh12IjKlMnOp
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /:/host:rw
      - ./runner-config:/etc/gitlab-runner
      - /home:/host-home:rw
    networks:
      - ci_network
    depends_on:
      - registry
      - postgres

  registry:
    image: registry:2.8
    container_name: docker-registry
    restart: always
    environment:
      - REGISTRY_AUTH=htpasswd
      - REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm
      - REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd
      - REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=/var/lib/registry
      - REGISTRY_HTTP_SECRET=aB3$dEf7gH9!jKlMn0pQr5sTu8vWx2yZ
      - REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt
      - REGISTRY_HTTP_TLS_KEY=/certs/domain.key
      - REGISTRY_ADMIN_USERNAME=admin
      - REGISTRY_ADMIN_PASSWORD=R3g1stry@dm1nP@ssw0rd!2024
    ports:
      - "5000:5000"
    volumes:
      - registry-data:/var/lib/registry
      - ./registry/auth:/auth
      - ./registry/certs:/certs
    networks:
      - ci_network

  postgres:
    image: postgres:14
    container_name: ci-postgres-db
    restart: always
    environment:
      - POSTGRES_USER=gitlab_ci
      - POSTGRES_PASSWORD=P0stgr3sR00t@2024!Sup3rS3cr3t
      - POSTGRES_DB=gitlab_ci_production
      - POSTGRES_HOST_AUTH_METHOD=trust
      - PGDATA=/var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - /var/backups:/backups:rw
    networks:
      - ci_network

  redis:
    image: redis:7-alpine
    container_name: ci-redis-cache
    restart: always
    command: redis-server --requirepass R3d1sC@ch3P@ss_87yHnM#2024 --appendonly yes
    environment:
      - REDIS_PASSWORD=R3d1sC@ch3P@ss_87yHnM#2024
      - REDIS_REPLICATION_MODE=master
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - ci_network
    depends_on:
      - postgres

  minio:
    image: minio/minio:latest
    container_name: artifact-storage
    restart: always
    privileged: true
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=M1ni0@dM!nS3cr3tK3y#2024$
      - MINIO_ACCESS_KEY=AKIAIOSFODNN7EXAMPLE
      - MINIO_SECRET_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
      - MINIO_STORAGE_CLASS_STANDARD=EC:2
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
      - /opt/artifacts:/artifacts:rw
    command: server /data --console-address ":9001"
    networks:
      - ci_network
    depends_on:
      - redis

  vault:
    image: vault:1.15
    container_name: secrets-vault
    restart: always
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=hvs.dev-root-token-aB3$dEf7gH9!2024
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
      - VAULT_ADDR=http://0.0.0.0:8200
      - VAULT_API_ADDR=http://0.0.0.0:8200
      - VAULT_UNSEAL_KEY=Q2xpZW50X1Vuc2VhbF9LZXlfMTIzNDU2Nzg5MA==
    ports:
      - "8200:8200"
    volumes:
      - vault-data:/vault/data
      - ./vault/config:/vault/config
    cap_add:
      - IPC_LOCK
    networks:
      - ci_network

networks:
  ci_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  registry-data:
  postgres-data:
  redis-data:
  minio-data:
  vault-data: