#!/usr/bin/env python3

import sys
from datetime import datetime

# Secret API key stored in global scope
SECRET_API_KEY = 'X7k9mP2nQ5vL8wR4'

# Other global variables to make it realistic
SERVICE_NAME = 'LogProcessor'
VERSION = '1.2.3'

def process_log_entry(log_entry, username='anonymous'):
    """
    Process a log entry with vulnerable string formatting.
    This function is vulnerable to format string injection attacks.
    """
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    log_level = 'INFO'
    
    # Vulnerable formatting - directly using user input in format string
    try:
        formatted_log = "[{timestamp}] [{log_level}] User: {username} - {message}".format(
            timestamp=timestamp,
            log_level=log_level,
            username=username,
            message=log_entry  # This creates a nested format vulnerability
        )
        
        # Additional vulnerability: formatting the already formatted string
        final_log = formatted_log.format(**globals())
        
        return final_log
    except (KeyError, ValueError, IndexError) as e:
        return f"[{timestamp}] [ERROR] Failed to process log: {str(e)}"

def main():
    print(f"Starting {SERVICE_NAME} v{VERSION}")
    print(f"API Key loaded: {SECRET_API_KEY[:4]}...{SECRET_API_KEY[-4:]}")
    
    # Simulate processing log entries
    test_logs = [
        "Application started successfully",
        "User logged in from 192.168.1.100",
        "{SECRET_API_KEY}"  # Example malicious payload
    ]
    
    for log in test_logs:
        result = process_log_entry(log, username='testuser')
        print(result)

if __name__ == '__main__':
    main()